# 批量设备导入功能方案

> **功能名称**: 批量设备导入  
> **创建时间**: 2026-01-12  
> **状态**: 📋 待确认  
> **优先级**: P0 - 高优先级

---

## 📋 目录

- [一、功能概述](#一功能概述)
- [二、功能位置](#二功能位置)
- [三、用户操作流程](#三用户操作流程)
- [四、Excel模板设计](#四excel模板设计)
- [五、数据校验规则](#五数据校验规则)
- [六、界面设计](#六界面设计)
- [七、技术实现](#七技术实现)
- [八、错误处理](#八错误处理)
- [九、性能考虑](#九性能考虑)
- [十、测试计划](#十测试计划)
- [十一、待确认事项](#十一待确认事项)

---

## 一、功能概述

### 1.1 功能目标

提供批量导入设备功能，支持通过 Excel 文件一次性导入多个设备，提高设备录入效率。

### 1.2 功能价值

- ✅ **提升效率**: 批量导入替代逐个添加，节省时间
- ✅ **减少错误**: 模板化录入，降低人工错误率
- ✅ **数据校验**: 导入前预览和校验，确保数据质量
- ✅ **用户体验**: 清晰的步骤指引，友好的错误提示

### 1.3 功能范围

- ✅ Excel 模板下载
- ✅ Excel 文件上传和解析
- ✅ 数据预览和校验
- ✅ 批量导入设备
- ✅ 导入结果反馈

---

## 二、功能位置

### 2.1 前端位置

| 文件路径 | 说明 |
|---------|------|
| `frontend/src/views/DeviceManagement.vue` | 设备管理页面，添加批量导入按钮和对话框 |
| `frontend/src/api/device.js` | 添加批量导入相关 API 方法 |
| `frontend/src/components/` | 可选：创建独立的批量导入组件（如果复用） |

### 2.2 后端位置

| 文件路径 | 说明 |
|---------|------|
| `backend/src/main/java/com/iot/platform/controller/DeviceController.java` | 添加批量导入接口 |
| `backend/src/main/java/com/iot/platform/service/DeviceService.java` | 添加批量导入业务逻辑（可选） |

### 2.3 依赖安装

```bash
# 前端需要安装 Excel 处理库
cd frontend
npm install xlsx
```

---

## 三、用户操作流程

### 3.1 完整流程图

```
┌─────────────────────────────────────────────────────────┐
│  1. 用户点击"批量导入"按钮                              │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  2. 弹出批量导入对话框                                   │
│     - 显示三个步骤：下载模板 → 上传文件 → 预览数据       │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  3. 步骤1：下载Excel模板                                 │
│     - 点击"下载模板"按钮                                │
│     - 下载标准模板（包含表头和示例数据）                 │
│     - 提示：模板已下载，请填写后上传                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  4. 用户填写Excel文件                                    │
│     - 打开下载的模板文件                                │
│     - 按照格式填写设备信息                              │
│     - 保存文件                                          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  5. 步骤2：上传Excel文件                                 │
│     - 点击"选择文件"按钮                                │
│     - 选择填写好的Excel文件                             │
│     - 自动触发文件解析                                  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  6. 步骤3：数据预览和校验                                │
│     - 显示解析后的数据表格                              │
│     - 标记数据状态：                                    │
│       ✅ 有效数据（绿色）                               │
│       ❌ 错误数据（红色，显示错误原因）                  │
│       ⚠️  重复数据（黄色，Excel内重复或数据库已存在）    │
│     - 显示统计信息：有效X条、错误Y条、重复Z条            │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  7. 确认导入                                             │
│     - 如果有错误数据，禁用"确认导入"按钮                │
│     - 点击"确认导入"按钮                                │
│     - 显示确认对话框："确认导入 X 条设备数据？"          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  8. 导入执行                                             │
│     - 显示导入进度（可选）                              │
│     - 调用后端批量导入接口                              │
│     - 后端逐条校验和插入                                │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  9. 导入结果反馈                                         │
│     - 显示导入结果：                                    │
│       "导入完成: 成功 X 条，失败 Y 条"                  │
│     - 如果有失败，显示失败详情列表                      │
│     - 自动刷新设备列表                                  │
│     - 关闭对话框                                        │
└─────────────────────────────────────────────────────────┘
```

### 3.2 异常流程

```
异常情况1：文件格式错误
  → 提示："请上传 .xlsx 或 .xls 格式的文件"

异常情况2：文件过大
  → 提示："文件大小不能超过 10MB"

异常情况3：Excel格式错误
  → 提示："Excel文件格式错误，请检查文件是否损坏"

异常情况4：所有数据都有错误
  → 禁用"确认导入"按钮，提示："请修正错误数据后重新上传"

异常情况5：导入过程中部分失败
  → 显示成功和失败统计，列出失败详情
```

---

## 四、Excel模板设计

### 4.1 模板字段定义

| 列序号 | 列名 | 字段名 | 必填 | 数据类型 | 长度限制 | 说明 | 示例值 |
|--------|------|--------|------|----------|----------|------|--------|
| A | 设备编码 | deviceCode | ✅ | 字符串 | 1-50 | 唯一标识，不能重复 | DEV001 |
| B | 设备名称 | deviceName | ✅ | 字符串 | 1-100 | 设备显示名称 | 温湿度传感器01 |
| C | 产品ID | productId | ✅ | 整数 | - | 产品表中的ID | 1 |
| D | 分组ID | groupId | ✅ | 整数 | - | 设备分组表中的ID | 1 |
| E | 位置 | location | ❌ | 字符串 | 0-200 | 设备位置描述 | 北京朝阳区 |
| F | 离线超时(分钟) | offlineTimeout | ❌ | 整数 | - | 默认300分钟 | 300 |
| G | 备注 | remark | ❌ | 字符串 | 0-500 | 备注信息 | 测试设备 |

### 4.2 模板示例数据

```
设备编码 | 设备名称      | 产品ID | 分组ID | 位置     | 离线超时(分钟) | 备注
---------|--------------|--------|--------|----------|---------------|----
DEV001   | 温湿度传感器01 | 1      | 1      | 北京     | 300           | 测试设备
DEV002   | 温湿度传感器02 | 1      | 1      | 上海     | 300           |
DEV003   | 压力传感器01   | 2      | 2      | 深圳     | 600           | 生产环境
```

### 4.3 模板文件结构

```
文件名: 设备导入模板.xlsx
工作表名: 设备导入模板（或 Sheet1）

表头行（第1行）:
A1: 设备编码
B1: 设备名称
C1: 产品ID
D1: 分组ID
E1: 位置
F1: 离线超时(分钟)
G1: 备注

示例数据行（第2-3行）:
A2: DEV001, B2: 设备1, C2: 1, D2: 1, E2: 北京, F2: 300, G2: 测试
A3: DEV002, B3: 设备2, C3: 1, D3: 1, E3: 上海, F3: 300, G3: 
```

### 4.4 模板列宽设置

| 列 | 宽度 | 说明 |
|----|------|------|
| A | 15 | 设备编码 |
| B | 15 | 设备名称 |
| C | 10 | 产品ID |
| D | 10 | 分组ID |
| E | 15 | 位置 |
| F | 18 | 离线超时(分钟) |
| G | 20 | 备注 |

---

## 五、数据校验规则

### 5.1 前端校验（预览阶段）

#### 5.1.1 必填字段校验

| 字段 | 校验规则 | 错误提示 |
|------|----------|----------|
| 设备编码 | 不能为空 | "设备编码不能为空" |
| 设备名称 | 不能为空 | "设备名称不能为空" |
| 产品ID | 不能为空 | "产品ID不能为空" |
| 分组ID | 不能为空 | "分组ID不能为空" |

#### 5.1.2 格式校验

| 字段 | 校验规则 | 错误提示 |
|------|----------|----------|
| 设备编码 | 长度1-50，不能包含特殊字符（建议：字母、数字、下划线、中划线） | "设备编码长度必须在1-50之间" |
| 设备名称 | 长度1-100 | "设备名称长度必须在1-100之间" |
| 产品ID | 必须是整数 | "产品ID必须是数字" |
| 分组ID | 必须是整数 | "分组ID必须是数字" |
| 离线超时 | 必须是正整数（如果填写） | "离线超时必须为正整数" |

#### 5.1.3 业务逻辑校验

| 校验项 | 校验规则 | 错误提示 |
|--------|----------|----------|
| 产品存在性 | 产品ID必须在产品列表中存在 | "产品ID不存在: {productId}" |
| 分组存在性 | 分组ID必须在分组列表中存在 | "分组ID不存在: {groupId}" |
| Excel内重复 | Excel内设备编码不能重复 | "设备编码重复: {deviceCode}" |
| 数据库重复 | 设备编码不能与数据库中已存在的设备重复 | "设备编码已存在: {deviceCode}" |

#### 5.1.4 数据清理

- 自动去除前后空格
- 忽略空行
- 数字字段自动转换为数字类型

### 5.2 后端校验（导入阶段）

#### 5.2.1 再次校验所有前端规则

防止前端校验被绕过，后端必须再次校验。

#### 5.2.2 数据库唯一性校验

```java
// 检查设备编码是否已存在
Device existing = deviceService.getByDeviceCode(deviceCode);
if (existing != null) {
    throw new Exception("设备编码已存在: " + deviceCode);
}
```

#### 5.2.3 关联数据校验

```java
// 验证产品是否存在
Product product = productService.getById(productId);
if (product == null) {
    throw new Exception("产品不存在: " + productId);
}

// 验证分组是否存在
DeviceGroup group = deviceGroupService.getById(groupId);
if (group == null) {
    throw new Exception("分组不存在: " + groupId);
}
```

### 5.3 校验结果标记

| 状态 | 标记 | 颜色 | 说明 |
|------|------|------|------|
| valid | ✅ | 绿色 | 数据有效，可以导入 |
| error | ❌ | 红色 | 数据有错误，不能导入 |
| duplicate | ⚠️ | 黄色 | 数据重复（Excel内重复或数据库已存在） |

---

## 六、界面设计

### 6.1 批量导入按钮位置

```
设备管理页面工具栏：
┌─────────────────────────────────────────────────────────┐
│ [🔍 搜索框] [产品筛选] [查询] [刷新] [添加设备] [批量导入] │
└─────────────────────────────────────────────────────────┘
```

### 6.2 批量导入对话框设计

```
┌─────────────────────────────────────────────────────────────┐
│  批量导入设备                                        [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 📥 步骤1: 下载模板                                   │  │
│  │                                                      │  │
│  │  [📥 下载Excel模板]                                  │  │
│  │                                                      │  │
│  │  💡 请按照模板格式填写设备信息                       │  │
│  │     必填字段：设备编码、设备名称、产品ID、分组ID      │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 📤 步骤2: 上传Excel文件                              │  │
│  │                                                      │  │
│  │  [选择文件]  device_list.xlsx  (1.2 MB)             │  │
│  │                                                      │  │
│  │  💡 只能上传 .xlsx 或 .xls 文件，且不超过 10MB      │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 📊 步骤3: 预览数据                                   │  │
│  │                                                      │  │
│  │  统计: [有效: 8条] [错误: 1条] [重复: 1条]          │  │
│  │                                                      │  │
│  │  ┌───────────────────────────────────────────────┐ │  │
│  │  │行号│设备编码│设备名称│产品ID│分组ID│状态│错误信息│ │  │
│  │  ├───┼──────┼──────┼──────┼──────┼────┼────────┤ │  │
│  │  │ 2 │DEV001│设备1 │  1   │  1   │ ✅ │        │ │  │
│  │  │ 3 │DEV002│设备2 │  1   │  1   │ ✅ │        │ │  │
│  │  │ 4 │      │设备3 │  1   │  1   │ ❌ │设备编码│ │  │
│  │  │ 5 │DEV001│设备4 │  1   │  1   │ ⚠️ │设备编码│ │  │
│  │  └───────────────────────────────────────────────┘ │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                    [取消]  [确认导入(8条)]  │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 导入结果反馈

```
┌─────────────────────────────────────────────────────────────┐
│  导入结果                                            [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ 导入完成！                                              │
│                                                             │
│  统计信息：                                                 │
│  • 成功: 8 条                                               │
│  • 失败: 2 条                                               │
│  • 总计: 10 条                                              │
│                                                             │
│  失败详情：                                                 │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 行号 │ 设备编码 │ 错误信息                          │  │
│  ├──────┼──────────┼─────────────────────────────────┤  │
│  │  4   │ DEV004   │ 产品ID不存在: 999                 │  │
│  │  7   │ DEV007   │ 设备编码已存在                    │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  [确定]                                                     │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 响应式设计

- **桌面端（≥1440px）**: 对话框宽度 900px
- **平板端（768px-1439px）**: 对话框宽度 90%
- **移动端（<768px）**: 对话框宽度 95%，表格横向滚动

---

## 七、技术实现

### 7.1 前端实现

#### 7.1.1 依赖安装

```bash
cd frontend
npm install xlsx
```

#### 7.1.2 文件结构

```
frontend/src/views/DeviceManagement.vue
├── 批量导入按钮（工具栏）
├── 批量导入对话框组件
│   ├── 步骤1: 下载模板
│   ├── 步骤2: 上传文件
│   └── 步骤3: 预览数据
└── 导入结果反馈

frontend/src/api/device.js
├── batchImportDevices()      // 批量导入接口
└── checkDeviceExists()       // 检查设备是否存在接口
```

#### 7.1.3 核心代码模块

**1. Excel模板下载**
```javascript
// 使用 xlsx 库生成Excel文件
import * as XLSX from 'xlsx'

const downloadTemplate = () => {
  const wb = XLSX.utils.book_new()
  const headers = ['设备编码', '设备名称', '产品ID', '分组ID', '位置', '离线超时(分钟)', '备注']
  const exampleData = [
    ['DEV001', '设备1', '1', '1', '北京', '300', '测试设备'],
    ['DEV002', '设备2', '1', '1', '上海', '300', '']
  ]
  const wsData = [headers, ...exampleData]
  const ws = XLSX.utils.aoa_to_sheet(wsData)
  // 设置列宽
  ws['!cols'] = [
    { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 10 },
    { wch: 15 }, { wch: 18 }, { wch: 20 }
  ]
  XLSX.utils.book_append_sheet(wb, ws, '设备导入模板')
  XLSX.writeFile(wb, '设备导入模板.xlsx')
}
```

**2. Excel文件解析**
```javascript
const readExcelFile = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result)
        const workbook = XLSX.read(data, { type: 'array' })
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]]
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 })
        resolve(jsonData)
      } catch (error) {
        reject(error)
      }
    }
    reader.onerror = reject
    reader.readAsArrayBuffer(file)
  })
}
```

**3. 数据校验**
```javascript
const parseExcelData = (data) => {
  // 1. 解析表头
  // 2. 解析数据行
  // 3. 校验每条数据
  // 4. 检查重复
  // 5. 检查数据库是否存在
  // 6. 返回预览数据
}
```

#### 7.1.4 API接口定义

```javascript
// frontend/src/api/device.js

// 批量导入设备
export const batchImportDevices = (data) => {
  return request({
    url: '/devices/batch-import',
    method: 'post',
    data
  })
}

// 检查设备编码是否存在
export const checkDeviceExists = (data) => {
  return request({
    url: '/devices/check-exists',
    method: 'post',
    data
  })
}
```

### 7.2 后端实现

#### 7.2.1 接口定义

**1. 批量导入接口**
```java
/**
 * 批量导入设备
 * POST /devices/batch-import
 * 
 * 请求参数:
 * {
 *   "devices": [
 *     {
 *       "deviceCode": "DEV001",
 *       "deviceName": "设备1",
 *       "productId": 1,
 *       "groupId": 1,
 *       "location": "北京",
 *       "offlineTimeout": 300,
 *       "remark": "测试设备"
 *     },
 *     ...
 *   ]
 * }
 * 
 * 响应:
 * {
 *   "code": 200,
 *   "message": "导入完成: 成功8条，失败2条",
 *   "data": {
 *     "successCount": 8,
 *     "failCount": 2,
 *     "totalCount": 10,
 *     "errors": [
 *       {
 *         "row": 4,
 *         "deviceCode": "DEV004",
 *         "error": "产品ID不存在: 999"
 *       },
 *       ...
 *     ]
 *   }
 * }
 */
@PostMapping("/batch-import")
public Result<Map<String, Object>> batchImportDevices(
        @RequestHeader(value = "Authorization", required = false) String token,
        @RequestBody Map<String, Object> params)
```

**2. 检查设备是否存在接口**
```java
/**
 * 检查设备编码是否存在
 * POST /devices/check-exists
 * 
 * 请求参数:
 * {
 *   "deviceCodes": ["DEV001", "DEV002", "DEV003"]
 * }
 * 
 * 响应:
 * {
 *   "code": 200,
 *   "data": {
 *     "existingCodes": ["DEV001", "DEV003"]
 *   }
 * }
 */
@PostMapping("/check-exists")
public Result<Map<String, Object>> checkDeviceExists(@RequestBody Map<String, Object> params)
```

#### 7.2.2 业务逻辑

```java
// DeviceController.java

@PostMapping("/batch-import")
public Result<Map<String, Object>> batchImportDevices(...) {
    // 1. 获取设备列表
    List<Map<String, Object>> devices = ...
    
    // 2. 初始化统计
    int successCount = 0;
    int failCount = 0;
    List<Map<String, Object>> errors = new ArrayList<>();
    
    // 3. 逐条处理
    for (int i = 0; i < devices.size(); i++) {
        try {
            // 3.1 数据校验
            // 3.2 检查重复
            // 3.3 验证关联数据（产品、分组）
            // 3.4 创建设备
            deviceService.createDevice(device);
            successCount++;
        } catch (Exception e) {
            failCount++;
            // 记录错误信息
            errors.add(...);
        }
    }
    
    // 4. 返回结果
    return Result.success(result);
}
```

#### 7.2.3 数据校验逻辑

```java
// 设备编码校验
if (deviceCode == null || deviceCode.trim().isEmpty()) {
    throw new Exception("设备编码不能为空");
}
if (deviceCode.length() > 50) {
    throw new Exception("设备编码长度不能超过50");
}

// 检查重复
Device existing = deviceService.getByDeviceCode(deviceCode);
if (existing != null) {
    throw new Exception("设备编码已存在: " + deviceCode);
}

// 验证产品
Product product = productService.getById(productId);
if (product == null) {
    throw new Exception("产品不存在: " + productId);
}

// 验证分组
DeviceGroup group = deviceGroupService.getById(groupId);
if (group == null) {
    throw new Exception("分组不存在: " + groupId);
}
```

### 7.3 数据库操作

#### 7.3.1 批量插入策略

**方案A: 逐条插入（当前方案）**
- 优点：错误处理精确，可以知道每条数据的错误
- 缺点：性能较慢，不适合大量数据

**方案B: 批量插入（可选优化）**
- 优点：性能好，适合大量数据
- 缺点：一条失败可能影响整批

**建议**: 先使用方案A，后续如果数据量大再优化为方案B。

---

## 八、错误处理

### 8.1 前端错误处理

| 错误类型 | 错误场景 | 处理方式 |
|---------|---------|---------|
| 文件格式错误 | 上传的不是Excel文件 | 提示："请上传 .xlsx 或 .xls 格式的文件" |
| 文件过大 | 文件超过10MB | 提示："文件大小不能超过 10MB" |
| Excel解析失败 | Excel文件损坏或格式错误 | 提示："Excel文件格式错误，请检查文件是否损坏" |
| 数据校验失败 | 数据不符合要求 | 在预览表格中标记错误，显示错误信息 |
| 网络错误 | 接口调用失败 | 提示："网络错误，请稍后重试" |
| 导入部分失败 | 部分数据导入失败 | 显示成功和失败统计，列出失败详情 |

### 8.2 后端错误处理

| 错误类型 | 错误场景 | 处理方式 |
|---------|---------|---------|
| 参数错误 | 请求参数格式错误 | 返回400错误，提示参数错误 |
| 数据校验失败 | 数据不符合要求 | 记录错误信息，继续处理下一条 |
| 数据库错误 | 插入数据库失败 | 记录错误信息，继续处理下一条 |
| 关联数据不存在 | 产品或分组不存在 | 记录错误信息，继续处理下一条 |

### 8.3 错误信息格式

```json
{
  "row": 4,
  "deviceCode": "DEV004",
  "error": "产品ID不存在: 999"
}
```

---

## 九、性能考虑

### 9.1 限制条件

| 限制项 | 限制值 | 说明 |
|--------|--------|------|
| 单次导入数量 | 1000条 | 防止单次导入过多数据 |
| 文件大小 | 10MB | 防止文件过大 |
| 文件格式 | .xlsx, .xls | 只支持Excel格式 |

### 9.2 性能优化

1. **前端优化**
   - Excel解析使用异步处理，不阻塞UI
   - 大数据量预览使用虚拟滚动（如果超过100条）

2. **后端优化**
   - 批量查询已存在的设备编码（减少数据库查询）
   - 批量查询产品和分组（减少数据库查询）
   - 使用事务管理（可选，如果要求全部成功才导入）

### 9.3 大数据量处理

如果单次导入超过1000条，建议：
- 前端提示用户分批导入
- 或后端支持异步导入（返回任务ID，用户查询导入进度）

---

## 十、测试计划

### 10.1 功能测试

| 测试项 | 测试用例 | 预期结果 |
|--------|---------|---------|
| 模板下载 | 点击下载模板按钮 | 成功下载Excel模板文件 |
| 文件上传 | 上传正确格式的Excel文件 | 成功解析并显示预览 |
| 数据校验 | 上传包含错误数据的Excel | 正确标记错误数据 |
| 重复检查 | 上传包含重复编码的Excel | 正确标记重复数据 |
| 批量导入 | 导入有效数据 | 成功导入设备 |
| 导入结果 | 导入完成后 | 显示成功和失败统计 |

### 10.2 边界测试

| 测试项 | 测试用例 | 预期结果 |
|--------|---------|---------|
| 空文件 | 上传空的Excel文件 | 提示文件为空 |
| 超大文件 | 上传超过10MB的文件 | 提示文件过大 |
| 错误格式 | 上传非Excel文件 | 提示格式错误 |
| 大量数据 | 上传1000条数据 | 正常处理 |
| 超量数据 | 上传超过1000条数据 | 提示超出限制 |

### 10.3 异常测试

| 测试项 | 测试用例 | 预期结果 |
|--------|---------|---------|
| 网络中断 | 导入过程中网络中断 | 提示网络错误 |
| 服务器错误 | 后端返回500错误 | 提示服务器错误 |
| 部分失败 | 部分数据导入失败 | 显示失败详情 |

---

## 十一、待确认事项

### 11.1 功能确认

- [ ] **单次导入数量限制**: 建议1000条，是否合适？
- [ ] **文件格式支持**: 只支持 .xlsx 和 .xls，是否需要支持 CSV？
- [ ] **导入模式**: 
  - [ ] 选项A：全部成功才导入（事务回滚）
  - [ ] 选项B：部分成功（成功导入，失败记录）✅ **推荐**
- [ ] **产品/分组匹配**: 
  - [ ] 选项A：只支持ID匹配（当前方案）
  - [ ] 选项B：支持名称匹配（需要扩展）
- [ ] **导入后行为**: 
  - [ ] 自动刷新设备列表 ✅ **推荐**
  - [ ] 自动关闭对话框 ✅ **推荐**

### 11.2 技术确认

- [ ] **Excel库选择**: 使用 `xlsx` 库，是否确认？
- [ ] **批量插入策略**: 使用逐条插入，后续是否需要优化为批量插入？
- [ ] **事务处理**: 是否需要事务（全部成功才导入）？

### 11.3 UI确认

- [ ] **对话框宽度**: 900px 是否合适？
- [ ] **预览表格**: 是否需要分页（如果数据量大）？
- [ ] **导入进度**: 是否需要显示导入进度条？

---

## 十二、实施步骤

### Phase 1: 前端基础功能（预计2小时）

1. ✅ 安装 xlsx 依赖
2. ✅ 添加批量导入按钮
3. ✅ 创建批量导入对话框
4. ✅ 实现模板下载功能
5. ✅ 实现文件上传功能

### Phase 2: 数据解析和校验（预计3小时）

1. ✅ 实现Excel文件解析
2. ✅ 实现数据校验逻辑
3. ✅ 实现预览表格展示
4. ✅ 实现错误标记和提示
5. ✅ 实现重复检查（Excel内和数据库）

### Phase 3: 后端接口（预计2小时）

1. ✅ 实现批量导入接口
2. ✅ 实现检查设备存在接口
3. ✅ 添加数据校验和错误处理
4. ✅ 添加日志记录

### Phase 4: 联调和优化（预计1小时）

1. ✅ 前后端联调
2. ✅ 错误处理完善
3. ✅ 用户体验优化
4. ✅ 测试验证

**总预计时间**: 8小时

---

## 十三、后续优化（可选）

### 13.1 功能扩展

- [ ] 支持产品名称/分组名称匹配（而不只是ID）
- [ ] 支持CSV格式导入
- [ ] 支持异步导入（大数据量）
- [ ] 支持导入历史记录查询
- [ ] 支持导入模板自定义字段

### 13.2 性能优化

- [ ] 批量插入优化（使用批量SQL）
- [ ] 大数据量预览优化（虚拟滚动）
- [ ] 导入进度显示

### 13.3 用户体验优化

- [ ] 拖拽上传文件
- [ ] 导入进度条
- [ ] 导入结果导出（失败数据）

---

## 十四、风险评估

### 14.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Excel解析失败 | 中 | 完善的错误提示和异常处理 |
| 大数据量性能问题 | 低 | 限制单次导入数量 |
| 浏览器兼容性 | 低 | 使用成熟的 xlsx 库 |

### 14.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 数据错误导入 | 高 | 完善的校验机制 |
| 重复数据导入 | 中 | 重复检查机制 |
| 大量失败数据 | 中 | 清晰的错误提示 |

---

## 十五、验收标准

### 15.1 功能验收

- [x] 可以下载Excel模板
- [x] 可以上传Excel文件并解析
- [x] 可以预览和校验数据
- [x] 可以批量导入设备
- [x] 可以查看导入结果

### 15.2 质量验收

- [x] 数据校验准确
- [x] 错误提示清晰
- [x] 用户体验良好
- [x] 性能满足要求（1000条数据在30秒内完成）

---

**方案状态**: 📋 待确认  
**创建时间**: 2026-01-12  
**最后更新**: 2026-01-12
