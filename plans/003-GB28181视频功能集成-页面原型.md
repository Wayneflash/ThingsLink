# GB28181视频管理功能 - 页面原型设计

> **创建时间**：2026-01-13  
> **最后更新**：2026-01-14  
> **状态**：✅ 方案已确定，可进入开发阶段

---

## 📋 功能概述

在IoT平台中新增"视频管理"功能模块，用于管理GB28181视频设备，支持设备列表查看、状态查询、实时视频播放等功能。

---

## 🏗️ 系统架构说明

### IoT平台 与 WVP平台 的关系

```
┌──────────────────────────────────────────────────────────────┐
│                   IoT平台（你的系统）                         │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  tb_video_device 表                                    │  │
│  │  - id, name, device_id, channel_id, group_id, remark  │  │
│  │  - 用户在此管理设备的映射关系                          │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                              │
│  增删改查（本地数据库操作）：                                │
│  ✅ 添加设备 → INSERT INTO tb_video_device                  │
│  ✅ 编辑设备 → UPDATE tb_video_device                       │
│  ✅ 删除设备 → DELETE FROM tb_video_device                  │
│  ✅ 查询列表 → SELECT * FROM tb_video_device                │
└────────────────┬─────────────────────────────────────────────┘
                 │
                 │ 只在需要时调用WVP接口：
                 │
                 ├─→ 查询设备状态（详情页）
                 │   GET /api/device/query/devices/{deviceId}
                 │
                 └─→ 获取实时视频流（播放时）
                     GET /api/play/start/{deviceId}/{channelId}
                 ↓
┌──────────────────────────────────────────────────────────────┐
│                    WVP平台（已部署）                          │
│  - GB28181设备通过国标协议自动注册到WVP                      │
│  - 提供设备状态查询、实时播放等接口                          │
│  - 地址：https://lxs.fjqiaolong.com:18082 （HTTPS）         │
└──────────────────────────────────────────────────────────────┘
```

### 关键要点

1. **设备管理**：
   - ✅ 所有增删改查操作都在IoT平台本地数据库完成
   - ✅ 不调用WVP接口，只记录 `device_id` 和 `channel_id`
   - ✅ WVP平台上的设备已通过GB28181协议自动注册

2. **只有两个场景调用WVP**：
   - ⭐ 查询设备状态：详情页加载时，用 `device_id` 查询设备在线状态
   - ⭐ 获取视频流：播放视频时，用 `device_id + channel_id` 获取HLS流地址

3. **数据流向**：
   ```
   用户操作 → IoT平台数据库（tb_video_device）→ 只存储映射关系
   需要状态/播放 → IoT平台后端 → 调用WVP接口 → 返回给前端
   ```

### 核心设计决策 ✅

**列表页不显示设备状态，详情页实时查询状态**

**决策理由**：
1. **性能最优**：列表页只查询数据库，响应速度极快（< 100ms），无WVP服务器压力
2. **实现简单**：不需要Redis缓存、定时任务、并发查询等复杂实现
3. **扩展性强**：支持任意数量设备（100+也毫无压力）
4. **符合场景**：用户浏览列表时不需要实时状态，点击详情时才需要查询
5. **运维友好**：减少依赖组件，降低系统复杂度

**与其他方案对比**：
- ❌ 方案A（前端逐个查询）：20次HTTP请求，慢，WVP压力大
- ❌ 方案B（后端批量查询）：列表响应慢（2-5秒），WVP压力大
- ❌ 方案C（后端异步查询）：需要WebSocket，实现复杂
- ❌ 方案D（后端缓存+定时任务）：需要Redis，状态有延迟
- ✅ **最终方案**：列表不显示状态，详情页实时查询（最简单、最快、最稳定）

---

## 🗂️ 数据结构设计

### 1. 视频设备数据结构

**核心字段映射**：

| 页面字段 | 数据来源 | 说明 |
|---------|---------|------|
| 视频名称 | `tb_video_device.name` | 用户自定义的设备名称 |
| 视频编码 | `tb_video_device.device_id` | GB28181设备编码（20位） |
| 通道编码 | `tb_video_device.channel_id` | GB28181通道编码（20位） |
| 所属分组 | `tb_video_device.group_id` | 关联IoT平台的设备分组 |
| 备注说明 | `tb_video_device.remark` | 设备备注信息 |

**设备状态字段**（仅在详情页显示，从WVP实时查询）：

| 字段 | WVP接口字段 | 说明 |
|------|------------|------|
| 在线状态 | `onLine` | true=在线，false=离线 |
| 设备IP | `ip` | 设备IP地址 |
| 设备端口 | `port` | SIP端口 |
| 通道数量 | `channelCount` | 设备通道总数 |
| 传输协议 | `transport` | UDP/TCP |
| 注册时间 | `registerTime` | 设备首次注册时间 |
| 最后心跳 | `keepaliveTime` | 最后一次心跳时间 |

**注意**：
- 列表页只显示数据库中的基本信息（不查询WVP）
- 详情页实时查询WVP获取设备状态（只查询单个设备，响应快）
- 一个设备可能有多个通道，每个通道作为一条记录存储

---

## 📄 页面原型设计

### 页面1：视频管理列表页

**路径**：`/video/management`

**页面布局**：
```
┌─────────────────────────────────────────────────────────────┐
│  [左侧导航栏]  [视频管理]  [筛选条件] [查询] [刷新] [+添加] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  序号 │ 视频名称 │ 视频编码 │ 通道编码 │ 所属分组 │ 操作     │
├───────┼─────────┼─────────┼─────────┼─────────┼──────────┤
│   1   │ 摄像头01 │ 340200... │ 340200... │ 办公区 │详情│编辑│删除│
│   2   │ 摄像头02 │ 340200... │ 340200... │ 生产区 │详情│编辑│删除│
│   ... │   ...   │   ...   │   ...   │   ...  │  ...     │
└─────────────────────────────────────────────────────────────┘
│                      [分页控件]                              │
└─────────────────────────────────────────────────────────────┘
```

**页面元素**：

1. **顶部操作栏**：
   - 筛选条件：
     - 搜索框（搜索视频名称或编码）
     - 所属分组下拉框（使用GroupSelector组件）
   - 操作按钮：
     - 查询按钮
     - 刷新按钮
     - + 添加视频设备按钮
     - ↑ 批量导入按钮（可选）

2. **数据表格**：
   - **序号**：自动序号（分页计算）
   - **视频名称**：显示设备名称，可点击查看详情
   - **视频编码**：GB28181设备编码（20位数字），完整显示
   - **通道编码**：GB28181通道编码（20位数字），完整显示
   - **所属分组**：显示分组名称
   - **操作**：
     - 详情（跳转详情页，查看状态和播放视频）
     - 编辑（打开编辑对话框）
     - 删除（确认删除）

3. **分页控件**：底部显示分页

**数据来源**：
- 从IoT平台的视频设备表中查询（新建 `tb_video_device` 表）
- **列表页不查询设备状态**（避免性能问题）
- **点击详情时实时查询状态**（只查询单个设备，响应快）

---

### 页面2：视频设备详情页

**路径**：`/video/detail/:deviceId/:channelId`

**页面布局**：
```
┌─────────────────────────────────────────────────────────────┐
│  [返回列表]  视频设备详情                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────── 设备状态信息 ─────────────────┐        │
│  │  视频名称：摄像头01                             │        │
│  │  视频编码：340200000013202274845               │        │
│  │  通道编码：34020000001310000001                 │        │
│  │  设备状态：在线 ✓                               │        │
│  │  设备IP：192.168.1.100                          │        │
│  │  设备端口：5060                                 │        │
│  │  通道数量：4                                    │        │
│  │  注册时间：2026-01-10 10:30:00                 │        │
│  │  最后心跳：2026-01-13 14:25:30                 │        │
│  └─────────────────────────────────────────────────┘        │
│                                                             │
│  ┌─────────────── 实时视频播放 ────────────────┐          │
│  │                                               │          │
│  │          [视频播放区域]                       │          │
│  │          (16:9比例，居中显示)                 │          │
│  │                                               │          │
│  │          [▶ 点击播放] 按钮                    │          │
│  │                                               │          │
│  └───────────────────────────────────────────────┘          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**页面元素**：

1. **设备状态信息卡片**：
   - **基本信息**：
     - 视频名称
     - 视频编码（deviceId）
     - 通道编码（channelId）
     - 所属分组
   - **设备状态**（从WVP查询设备状态接口获取）：
     - 设备状态：在线/离线（带状态图标）
     - 设备IP：`ip`
     - 设备端口：`port`
     - 通道数量：`channelCount`
     - 传输协议：`transport`（UDP/TCP）
     - 注册时间：`registerTime`
     - 最后心跳：`keepaliveTime`
   - **操作按钮**：
     - 刷新状态（重新查询设备状态）

2. **实时视频播放区域**：
   - **初始状态**：显示占位图 + "点击播放"按钮
   - **播放状态**：
     - HTML5 video标签播放HLS流
     - 播放控制栏（播放/暂停、音量、全屏等）
     - 加载中提示
     - 播放错误提示
   - **播放流程**：
     1. 用户点击"播放"按钮
     2. 调用后端接口：`POST /api/video/play`
     3. 后端调用WVP实时播放接口获取HLS地址
     4. 前端接收HLS地址，使用video标签播放
     5. 显示播放器界面

**数据来源**：
- 设备状态：调用WVP查询设备状态接口 `GET /api/device/query/devices/{deviceId}`
- 视频流地址：调用WVP实时播放接口 `GET /api/play/start/{deviceId}/{channelId}`

---

### 页面3：添加/编辑视频设备对话框

**路径**：弹窗形式（在列表页打开）

**表单字段**：
```
┌─────────────────────────────────────┐
│  添加视频设备                        │
├─────────────────────────────────────┤
│  视频名称 *： [____________]        │
│  视频编码 *： [____________]        │
│  通道编码 *： [____________]        │
│  所属分组 *： [下拉选择]            │
│  备注说明  ： [____________]        │
│                                     │
│        [取消]  [确定]               │
└─────────────────────────────────────┘
```

**表单验证**：
- 视频名称：必填，1-50字符
- 视频编码：必填，20位数字（GB28181设备编码格式）
- 通道编码：必填，20位数字（GB28181通道编码格式）
- 所属分组：必填，使用GroupSelector组件

**保存逻辑**：
- **只操作自己系统的数据库**：将设备信息保存到 `tb_video_device` 表
- **不调用WVP接口**：WVP平台上的设备已通过GB28181协议自动注册
- **只是记录映射关系**：记录 device_id 和 channel_id，后续用于查询状态和播放视频

---

## 🔄 数据流程设计

### 1. 视频设备列表加载流程

#### ⭐ 最优方案：列表不查询状态，详情页实时查询

**设计理由**：
- ✅ 列表响应速度极快（< 100ms，只查数据库）
- ✅ 无WVP服务器压力（不调用WVP接口）
- ✅ 实现简单（不需要Redis、定时任务、并发查询）
- ✅ 支持任意数量设备（100+也毫无压力）
- ✅ 符合使用场景（用户浏览列表时不需要状态，点详情时才需要）

**实现逻辑**：

```
用户打开视频管理页面
    ↓
前端调用：POST /api/video/list（分页查询）
    ↓
后端从数据库查询视频设备列表（当前页20条）
  SELECT * FROM tb_video_device 
  WHERE group_id IN (用户可见分组) 
  ORDER BY create_time DESC
  LIMIT 20 OFFSET 0
    ↓
返回列表数据（不包含状态信息）
    ↓
前端渲染表格（响应速度 < 100ms）
```

**列表页不显示状态**，用户需要查看设备状态时点击"详情"按钮。

### 2. 视频设备详情页加载流程

```
用户点击"详情"
    ↓
前端跳转到详情页：/video/detail/{deviceId}/{channelId}
    ↓
页面加载时：
  1. 调用后端接口：POST /api/video/detail/{deviceId}
  2. 后端调用WVP查询设备状态接口获取设备状态
  3. 返回设备详细信息
    ↓
前端显示设备状态信息卡片
    ↓
视频播放区域显示"点击播放"按钮
```

### 3. 实时视频播放流程

```
用户点击"播放"按钮
    ↓
前端调用后端接口：POST /api/video/play
  参数：{ deviceId, channelId }
    ↓
后端处理：
  1. 检查WVP Token是否有效（如过期则重新登录）
  2. 调用WVP实时播放接口：
     GET /api/play/start/{deviceId}/{channelId}
  3. 获取HLS地址（https_hls字段）
    ↓
后端返回HLS地址给前端
    ↓
前端使用HTML5 video标签播放：
  <video controls autoplay>
    <source src="{hls_url}" type="application/x-mpegURL">
  </video>
    ↓
视频开始播放
```

---

## 🗄️ 数据库设计

### 视频设备表

**表名**：`tb_video_device`

**字段设计**：
```sql
CREATE TABLE IF NOT EXISTS `tb_video_device` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `device_id` VARCHAR(20) NOT NULL COMMENT 'GB28181设备编码',
  `channel_id` VARCHAR(20) NOT NULL COMMENT 'GB28181通道编码',
  `name` VARCHAR(100) NOT NULL COMMENT '视频设备名称',
  `group_id` BIGINT COMMENT '所属分组ID',
  `remark` VARCHAR(500) COMMENT '备注说明',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_device_channel` (`device_id`, `channel_id`),
  KEY `idx_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='视频设备表';
```

**说明**：
- 新建独立的视频设备表，与现有设备表分离，更清晰
- 一个设备可能有多个通道，使用 `(device_id, channel_id)` 作为唯一键
- 通过 `group_id` 关联IoT平台的设备分组表，实现数据权限控制
- 每个通道作为一条记录存储，便于管理和查询

---

## 🔌 后端接口设计

### 1. 视频设备列表接口

**接口**：`POST /api/video/list`

**请求参数**：
```json
{
  "page": 1,
  "pageSize": 20,
  "search": "",           // 可选：搜索关键词（视频名称或编码）
  "groupId": null         // 可选：分组ID
}
```

**响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "deviceId": "340200000013202274845",
        "channelId": "34020000001310000001",
        "name": "摄像头01",
        "groupId": 1,
        "groupName": "办公区",
        "remark": "办公区入口摄像头",
        "createTime": "2026-01-10 10:30:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20
  }
}
```

**说明**：
- 列表接口不查询设备状态（不调用WVP接口）
- 只返回数据库中存储的设备基本信息
- 用户需要查看状态时，点击"详情"进入详情页

### 2. 视频设备详情接口

**接口**：`POST /api/video/detail/{deviceId}`

**响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "deviceId": "340200000013202274845",
    "channelId": "34020000001310000001",
    "name": "摄像头01",
    "groupId": 1,
    "groupName": "办公区",
    // WVP设备状态信息（调用WVP接口获取）
    "status": {
      "onLine": true,
      "ip": "192.168.1.100",
      "port": 5060,
      "channelCount": 4,
      "transport": "UDP",
      "registerTime": "2026-01-10 10:30:00",
      "keepaliveTime": "2026-01-13 14:25:30"
    }
  }
}
```

**实现逻辑**：
1. **查询本地数据库**：从 `tb_video_device` 表查询设备基本信息
2. **⭐ 调用WVP接口**：用 `deviceId` 调用 `GET /api/device/query/devices/{deviceId}` 获取设备状态
3. **合并数据返回**：将本地信息 + WVP状态信息合并返回
4. **异常处理**：如果WVP查询失败，status 返回 null，前端显示"无法获取状态"

### 3. 实时视频播放接口

**接口**：`POST /api/video/play`

**请求参数**：
```json
{
  "deviceId": "340200000013202274845",
  "channelId": "34020000001310000001"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hlsUrl": "https://lxs.fjqiaolong.com:8443/rtp/340200000013202274845_34020000001310000001/hls.m3u8",
    "deviceId": "340200000013202274845",
    "channelId": "34020000001310000001"
  }
}
```

**实现逻辑**：
1. **数据权限校验**：查询 `tb_video_device` 表，校验该设备是否在用户可见分组内
2. **⭐ 调用WVP接口**：用 `deviceId + channelId` 调用 `GET /api/play/start/{deviceId}/{channelId}`
3. **提取HLS地址**：从WVP响应中提取 `https_hls` 字段（HTTPS的HLS流地址）
4. **返回给前端**：前端使用 `<video>` 标签播放HLS流
5. **异常处理**：设备离线或播放失败时，返回错误提示

### 4. 添加视频设备接口

**接口**：`POST /api/video/add`

**请求参数**：
```json
{
  "name": "摄像头01",
  "deviceId": "340200000013202274845",
  "channelId": "34020000001310000001",
  "groupId": 1,
  "remark": "办公区入口摄像头"
}
```

**实现逻辑**：
- **只操作本地数据库**：`INSERT INTO tb_video_device ...`
- **不调用WVP接口**：WVP上的设备已存在（GB28181自动注册）
- **数据权限校验**：校验 `groupId` 是否在用户可见分组内
- **唯一性校验**：校验 `(deviceId, channelId)` 是否已存在

### 5. 编辑视频设备接口

**接口**：`POST /api/video/update`

**请求参数**：
```json
{
  "id": 1,
  "name": "摄像头01（已修改）",
  "groupId": 2,
  "remark": "更新后的备注"
}
```

**实现逻辑**：
- **只操作本地数据库**：`UPDATE tb_video_device SET ... WHERE id = ?`
- **不调用WVP接口**：只修改IoT平台的显示信息
- **不允许修改**：`deviceId` 和 `channelId` 不允许修改（唯一标识）

### 6. 删除视频设备接口

**接口**：`POST /api/video/delete`

**请求参数**：
```json
{
  "id": 1
}
```

**实现逻辑**：
- **只操作本地数据库**：`DELETE FROM tb_video_device WHERE id = ?`
- **不调用WVP接口**：只删除IoT平台的记录，WVP上的设备仍然存在
- **数据权限校验**：校验该设备是否在用户可见分组内

---

## 🎨 UI设计要点

### 1. 列表页设计
- 参考现有"设备管理"页面的样式
- 不显示设备状态（避免性能问题）
- 表格支持搜索、分组筛选
- 点击"详情"按钮查看设备状态和播放视频

### 2. 详情页设计
- 设备状态信息卡片：使用Element Plus的Card组件
- 视频播放区域：
  - 16:9比例，最大宽度1200px，居中显示
  - 播放前显示占位图和"播放"按钮
  - 播放中显示video标签和控制栏
  - 加载中显示loading动画
  - 错误时显示错误提示

### 3. 播放器样式
- 使用HTML5 video标签原生样式
- 支持全屏播放
- 支持音量控制
- 支持播放/暂停

---

## ⚙️ 配置管理

### WVP服务器配置

#### 1. 配置存储位置

**存储表**：`system_config`（系统已有的配置表）

**表结构**（如果不存在则创建）：
```sql
CREATE TABLE IF NOT EXISTS `system_config` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `key` VARCHAR(100) NOT NULL UNIQUE COMMENT '配置键',
  `value` VARCHAR(500) NOT NULL COMMENT '配置值',
  `description` VARCHAR(200) COMMENT '配置说明',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

#### 2. 配置项定义

| 配置键 | 配置值示例 | 说明 |
|-------|-----------|------|
| `wvp.server.url` | `https://lxs.fjqiaolong.com:18082` | WVP服务器地址（HTTPS，不要带尾部斜杠） |
| `wvp.server.username` | `admin` | WVP登录用户名 |
| `wvp.server.password` | `b59c67bf196a4758191e42f76670ceba` | WVP登录密码（32位MD5小写） |

#### 3. 默认配置值（根据你的WVP环境）

```sql
-- WVP服务器地址（HTTPS）
wvp.server.url = https://lxs.fjqiaolong.com:18082

-- WVP登录用户名
wvp.server.username = admin

-- WVP登录密码（wangyq 的MD5）
wvp.server.password = b59c67bf196a4758191e42f76670ceba
```

#### 4. 配置初始化SQL

**数据库迁移脚本**：`sql/migrations/004_init_wvp_config.sql`

```sql
-- 初始化WVP配置
INSERT INTO system_config (`key`, `value`, `description`) VALUES
('wvp.server.url', 'https://lxs.fjqiaolong.com:18082', 'WVP服务器地址（HTTPS）'),
('wvp.server.username', 'admin', 'WVP登录用户名'),
('wvp.server.password', 'b59c67bf196a4758191e42f76670ceba', 'WVP登录密码（MD5加密）')
ON DUPLICATE KEY UPDATE `description` = VALUES(`description`);

-- 记录迁移历史
INSERT INTO tb_migration_history (migration_file, status, executed_at) 
VALUES ('004_init_wvp_config.sql', 'success', NOW())
ON DUPLICATE KEY UPDATE status = 'success', executed_at = NOW();
```

#### 5. 配置读取方式

**后端实现**（Spring Boot）：

```java
@Service
public class WvpConfigService {
    
    @Autowired
    private SystemConfigMapper systemConfigMapper;
    
    // 缓存配置，避免频繁查询数据库
    private Map<String, String> configCache = new ConcurrentHashMap<>();
    
    /**
     * 获取WVP服务器地址
     */
    public String getWvpServerUrl() {
        return getConfig("wvp.server.url", "https://lxs.fjqiaolong.com:18082");
    }
    
    /**
     * 获取WVP用户名
     */
    public String getWvpUsername() {
        return getConfig("wvp.server.username", "admin");
    }
    
    /**
     * 获取WVP密码（MD5）
     */
    public String getWvpPassword() {
        return getConfig("wvp.server.password", "b59c67bf196a4758191e42f76670ceba");
    }
    
    /**
     * 获取配置（带缓存和默认值）
     */
    private String getConfig(String key, String defaultValue) {
        if (configCache.containsKey(key)) {
            return configCache.get(key);
        }
        
        SystemConfig config = systemConfigMapper.selectByKey(key);
        String value = (config != null) ? config.getValue() : defaultValue;
        configCache.put(key, value);
        return value;
    }
    
    /**
     * 刷新配置缓存
     */
    public void refreshCache() {
        configCache.clear();
    }
}
```

#### 6. 配置修改方式

**开发阶段**（当前）：
- 直接执行SQL修改 `system_config` 表
- 修改后调用 `WvpConfigService.refreshCache()` 刷新缓存

**生产阶段**（后期扩展）：
- 在系统配置管理页面提供界面修改
- 修改后自动刷新缓存

---

## 📝 方案确认

### 1. 设备列表来源 ✅ **已确定**
**方案**：新建视频设备表 `tb_video_device`，手动添加设备
**理由**：
- 更灵活可控，不依赖WVP设备列表接口
- 可自定义设备名称、分组等信息
- 避免WVP平台设备变更影响IoT平台

### 2. 通道管理 ✅ **已确定**
**方案**：每个通道作为一条记录存储，`(device_id, channel_id)` 作为唯一键
**理由**：
- 一个设备可能有多个通道（channelCount）
- 每个通道独立管理，可单独播放
- 数据结构清晰，便于查询和展示

### 3. 列表页状态显示 ✅ **已确定**
**方案**：列表页不显示状态，只在详情页实时查询
**理由**：
- 避免性能问题（不需要批量查询WVP）
- 列表响应速度极快（< 100ms）
- 符合使用场景（浏览列表时不需要实时状态）

### 4. 播放权限控制 ✅ **已确定**
**方案**：使用现有的数据权限体系（按分组过滤）
**理由**：
- 与现有设备管理权限体系一致
- 通过 `group_id` 字段实现权限控制
- 超级管理员可查看所有设备，普通用户只能查看本分组及下级分组设备

### 5. 视频播放协议 ✅ **已确定**
**方案**：使用HLS（HTTP Live Streaming）协议，通过HTTPS传输
**理由**：
- ✅ **HTTPS传输更安全**：视频流加密传输，防止劫持
- ✅ **浏览器支持好**：现代浏览器完美支持HTTPS视频流
- ✅ **避免Mixed Content警告**：IoT平台如果是HTTPS，视频流也应该是HTTPS
- ✅ **服务器性能要求低**：WVP已转码为HLS格式
- ✅ **浏览器原生支持**：HTML5 video标签或HLS.js库
- ✅ **跨平台兼容性好**：PC、移动端都支持
- ✅ **延迟可接受**：2-5秒延迟，监控场景完全可接受

---

## 🛠️ 开发准备

### 技术栈确认
- **后端**：Spring Boot + OkHttp（调用WVP接口）
- **前端**：Vue 3 + Element Plus + HLS.js（视频播放库）
- **数据库**：MySQL 5.7+（新增 `tb_video_device` 表）
- **外部依赖**：WVP平台（已部署在 `lxs.fjqiaolong.com:18080`）

### 依赖包
**后端新增依赖**（`pom.xml`）：
```xml
<!-- OkHttp for HTTP client -->
<dependency>
    <groupId>com.squareup.okhttp3</groupId>
    <artifactId>okhttp</artifactId>
    <version>4.10.0</version>
</dependency>
```

**前端新增依赖**（`package.json`）：
```json
{
  "hls.js": "^1.4.12"
}
```

### 环境配置
1. **WVP服务器配置**：需要在 `system_config` 表中配置WVP服务器地址、用户名、密码
2. **网络访问**：确保IoT平台服务器可以访问WVP服务器（`https://lxs.fjqiaolong.com:18082`）
3. **视频流访问**：
   - ✅ **HTTPS更佳**：WVP返回HTTPS视频流地址，前端完全支持，更安全
   - 前端浏览器需要能访问WVP的HTTPS视频流（如 `https://lxs.fjqiaolong.com:8443`）
   - 如果使用自签名证书，浏览器首次访问时需要信任证书
4. **CORS配置**：WVP需要配置允许跨域访问（如果IoT平台和WVP不同域）
5. **后端HTTPS客户端**：
   - 如果WVP使用自签名证书，后端OkHttp需要信任该证书
   - 生产环境建议使用正式SSL证书

---

## 🎯 开发优先级

### 第一阶段：核心基础功能（必须）
1. **数据库迁移脚本**：创建 `tb_video_device` 表
2. **WVP配置管理**：在 `system_config` 表中添加WVP服务器配置
3. **WVP服务封装**：封装WVP登录、设备状态查询、实时播放等接口
4. **后端接口开发**：
   - 视频设备列表接口（分页、搜索、分组筛选）
   - 视频设备详情接口（查询WVP设备状态）
   - 添加/编辑/删除视频设备接口
5. **前端页面开发**：
   - 视频管理列表页（参考设备管理页面样式）
   - 添加/编辑视频设备对话框

### 第二阶段：视频播放功能（必须）
1. **后端播放接口**：封装WVP实时播放接口，返回HLS地址
2. **前端详情页**：
   - 设备状态信息卡片
   - 实时视频播放器（HTML5 video + HLS.js）
   - 播放控制（播放/暂停、全屏、音量）
3. **异常处理**：
   - 设备离线提示
   - 播放失败提示
   - WVP服务连接失败处理

### 第三阶段：功能完善（可选）
1. **批量导入**：支持Excel批量导入视频设备
2. **播放历史记录**：记录用户播放记录
3. **视频快照**：支持视频截图功能
4. **录像回放**：对接WVP录像回放接口（如有需求）

---

## ✅ 文档状态

- **创建时间**：2026-01-13
- **最后更新**：2026-01-14
- **文档状态**：方案已确定，可进入开发阶段
- **下一步**：开始第一阶段开发（数据库迁移 + 后端接口）

---

*最后更新：2026-01-14*
