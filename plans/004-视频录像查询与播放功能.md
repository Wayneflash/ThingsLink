# è§†é¢‘å½•åƒæŸ¥è¯¢ä¸æ’­æ”¾åŠŸèƒ½å¼€å‘æ–¹æ¡ˆ

> **åŠŸèƒ½åç§°**: è§†é¢‘å½•åƒæŸ¥è¯¢ä¸æ’­æ”¾  
> **åˆ›å»ºæ—¶é—´**: 2026-01-16  
> **çŠ¶æ€**: å¾…ç¡®è®¤

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨ç°æœ‰çš„è§†é¢‘è®¾å¤‡è¯¦æƒ…é¡µé¢åŸºç¡€ä¸Šï¼Œæ–°å¢å½•åƒæŸ¥è¯¢å’Œæ’­æ”¾åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢è®¾å¤‡å½•åƒåˆ—è¡¨ï¼Œå¹¶æ”¯æŒæ’­æ”¾é€‰ä¸­çš„å½•åƒç‰‡æ®µã€‚

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

### 1. å½•åƒæŸ¥è¯¢åŠŸèƒ½
- **åŠŸèƒ½æè¿°**: æ ¹æ®è®¾å¤‡ç¼–ç ã€é€šé“ç¼–ç å’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢å½•åƒåˆ—è¡¨
- **æŸ¥è¯¢æ¡ä»¶**:
  - è®¾å¤‡ç¼–ç ï¼ˆdeviceIdï¼‰
  - é€šé“ç¼–ç ï¼ˆchannelIdï¼‰
  - å¼€å§‹æ—¶é—´ï¼ˆstartTimeï¼‰
  - ç»“æŸæ—¶é—´ï¼ˆendTimeï¼‰
- **è¿”å›æ•°æ®**: å½•åƒåˆ—è¡¨ï¼ŒåŒ…å«æ¯æ¡å½•åƒçš„å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€ç±»å‹ã€æ–‡ä»¶å¤§å°ç­‰ä¿¡æ¯

### 2. å½•åƒæ’­æ”¾åŠŸèƒ½
- **åŠŸèƒ½æè¿°**: æ’­æ”¾é€‰ä¸­çš„å½•åƒç‰‡æ®µ
- **æ’­æ”¾æ–¹å¼**: å¾…ç¡®è®¤WVPå½•åƒå›æ”¾æ¥å£

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ä¸€ã€WVPæ¥å£è¯´æ˜

#### 1. å½•åƒæŸ¥è¯¢æ¥å£
- **æ¥å£è·¯å¾„**: `GET /api/gb_record/query/{deviceId}/{channelId}`
- **è¯·æ±‚å‚æ•°**:
  - `deviceId` (path): è®¾å¤‡å›½æ ‡ç¼–å·
  - `channelId` (path): é€šé“å›½æ ‡ç¼–å·
  - `startTime` (query): å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ `yyyy-MM-dd HH:mm:ss`
  - `endTime` (query): ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ `yyyy-MM-dd HH:mm:ss`
- **è®¤è¯æ–¹å¼**: Headerä¸­æºå¸¦ `access-token`
- **å“åº”æ ¼å¼**:
```json
{
  "code": 0,
  "msg": "æˆåŠŸ",
  "data": {
    "deviceId": "...",
    "channelId": "...",
    "sn": "...",
    "name": "...",
    "sumNum": 4,
    "count": 4,
    "lastTime": null,
    "recordList": [
      {
        "deviceId": "...",
        "name": "...",
        "filePath": "",
        "fileSize": null,
        "address": "",
        "startTime": "2026-01-16 07:49:57",  // è®¾å¤‡æ—¶é—´ï¼Œæ— éœ€è½¬æ¢
        "endTime": "2026-01-16 07:51:10",    // è®¾å¤‡æ—¶é—´ï¼Œæ— éœ€è½¬æ¢
        "secrecy": 0,
        "type": "time",
        "recorderId": ""
      }
    ]
  }
}
```

#### 2. å½•åƒå›æ”¾æ¥å£
- **æ¥å£è·¯å¾„**: `GET /api/playback/start/{deviceId}/{channelId}`
- **è¯·æ±‚å‚æ•°**:
  - `deviceId` (path): è®¾å¤‡å›½æ ‡ç¼–å·
  - `channelId` (path): é€šé“å›½æ ‡ç¼–å·
  - `startTime` (query): å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ `yyyy-MM-dd HH:mm:ss`ï¼ˆè®¾å¤‡æ—¶é—´ï¼‰
  - `endTime` (query): ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ `yyyy-MM-dd HH:mm:ss`ï¼ˆè®¾å¤‡æ—¶é—´ï¼‰
- **è®¤è¯æ–¹å¼**: Headerä¸­æºå¸¦ `access-token`
- **å“åº”æ ¼å¼**: ä¸å®æ—¶æ’­æ”¾ç±»ä¼¼ï¼Œè¿”å›æµåœ°å€ä¿¡æ¯ï¼ˆåŒ…å« `https_hls` å­—æ®µï¼‰

### äºŒã€æ—¶é—´å¤„ç†è¯´æ˜

**é‡è¦**: å½•åƒæŸ¥è¯¢è¿”å›çš„æ—¶é—´æ˜¯**è®¾å¤‡æœ¬åœ°æ—¶é—´**ï¼Œ**ä¸éœ€è¦æ—¶åŒºè½¬æ¢**ï¼

- å‰ç«¯ä¼ å…¥ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´ï¼ˆ`yyyy-MM-dd HH:mm:ss`ï¼‰
- åç«¯è°ƒç”¨WVPï¼šç›´æ¥ä¼ é€’å‰ç«¯ä¼ å…¥çš„æ—¶é—´ï¼Œä¸åšè½¬æ¢
- WVPè¿”å›ï¼šç›´æ¥è¿”å›ç»™å‰ç«¯ï¼Œä¸åšè½¬æ¢

---

## ğŸ“ æ¶‰åŠæ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

1. **`backend/src/main/java/com/iot/platform/service/WvpService.java`**
   - æ–°å¢æ–¹æ³•ï¼š`queryRecord(String deviceId, String channelId, String startTime, String endTime)`
   - åŠŸèƒ½ï¼šè°ƒç”¨WVPå½•åƒæŸ¥è¯¢æ¥å£
   - æ–°å¢æ–¹æ³•ï¼š`getPlaybackUrl(String deviceId, String channelId, String startTime, String endTime)`
   - åŠŸèƒ½ï¼šè°ƒç”¨WVPå½•åƒå›æ”¾æ¥å£ï¼Œè·å–å›æ”¾æµåœ°å€

2. **`backend/src/main/java/com/iot/platform/service/VideoDeviceService.java`**
   - æ–°å¢æ–¹æ³•ï¼š`queryRecord(String deviceId, String channelId, String startTime, String endTime, List<Long> userGroupIds)`
   - åŠŸèƒ½ï¼šæ•°æ®æƒé™æ ¡éªŒ + è°ƒç”¨WvpServiceæŸ¥è¯¢å½•åƒåˆ—è¡¨
   - æ–°å¢æ–¹æ³•ï¼š`getPlaybackUrl(String deviceId, String channelId, String startTime, String endTime, List<Long> userGroupIds)`
   - åŠŸèƒ½ï¼šæ•°æ®æƒé™æ ¡éªŒ + è°ƒç”¨WvpServiceè·å–å›æ”¾æµåœ°å€

3. **`backend/src/main/java/com/iot/platform/controller/VideoController.java`**
   - æ–°å¢æ¥å£ï¼š`POST /api/video/record/query`
   - åŠŸèƒ½ï¼šæ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œè¿”å›å½•åƒåˆ—è¡¨
   - æ–°å¢æ¥å£ï¼š`POST /api/video/record/playback`
   - åŠŸèƒ½ï¼šæ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œè¿”å›å½•åƒå›æ”¾æµåœ°å€

4. **`backend/src/main/java/com/iot/platform/dto/video/VideoRecordQueryRequest.java`**ï¼ˆæ–°å»ºï¼‰
   - DTOç±»ï¼šå½•åƒæŸ¥è¯¢è¯·æ±‚å‚æ•°

5. **`backend/src/main/java/com/iot/platform/dto/video/VideoRecordPlaybackRequest.java`**ï¼ˆæ–°å»ºï¼‰
   - DTOç±»ï¼šå½•åƒå›æ”¾è¯·æ±‚å‚æ•°

5. **`docs/API.md`**
   - æ–°å¢æ¥å£æ–‡æ¡£ï¼š16.7 æŸ¥è¯¢å½•åƒåˆ—è¡¨

### å‰ç«¯æ–‡ä»¶

1. **`frontend/src/api/video.js`**
   - æ–°å¢æ–¹æ³•ï¼š`queryRecord(params)`
   - åŠŸèƒ½ï¼šè°ƒç”¨åç«¯å½•åƒæŸ¥è¯¢æ¥å£

2. **`frontend/src/views/VideoDetail.vue`**
   - æ–°å¢"å½•åƒæŸ¥è¯¢"æ ‡ç­¾é¡µ
   - æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
   - å½•åƒåˆ—è¡¨è¡¨æ ¼
   - æ’­æ”¾æŒ‰é’®

---

## ğŸ”¨ è¯¦ç»†å®ç°æ–¹æ¡ˆ

### åç«¯å®ç°

#### 1. WvpService.java - æ–°å¢å½•åƒæŸ¥è¯¢æ–¹æ³•

```java
/**
 * æŸ¥è¯¢å½•åƒåˆ—è¡¨
 * 
 * @param deviceId GB28181è®¾å¤‡ç¼–ç 
 * @param channelId GB28181é€šé“ç¼–ç 
 * @param startTime å¼€å§‹æ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @param endTime ç»“æŸæ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @return å½•åƒä¿¡æ¯
 */
public JSONObject queryRecord(String deviceId, String channelId, String startTime, String endTime) {
    try {
        // æ„å»ºURLï¼Œå‚æ•°é€šè¿‡queryä¼ é€’
        String baseUrl = wvpConfigService.getWvpServerUrl() + "/api/gb_record/query/" + deviceId + "/" + channelId;
        HttpUrl url = HttpUrl.parse(baseUrl).newBuilder()
                .addQueryParameter("startTime", startTime)
                .addQueryParameter("endTime", endTime)
                .build();
        
        Request request = new Request.Builder()
                .url(url)
                .addHeader("access-token", getAccessToken())
                .get()
                .build();
        
        Response response = httpClient.newCall(request).execute();
        String responseBody = response.body().string();
        
        log.info("WVPå½•åƒæŸ¥è¯¢å“åº”: deviceId={}, channelId={}, response={}", deviceId, channelId, responseBody);
        
        JSONObject json = JSON.parseObject(responseBody);
        if (json.getInteger("code") == 0) {
            return json.getJSONObject("data");
        } else {
            String errorMsg = json.getString("msg");
            log.error("æŸ¥è¯¢å½•åƒå¤±è´¥: deviceId={}, channelId={}, error={}", deviceId, channelId, errorMsg);
            throw new RuntimeException("WVPæŸ¥è¯¢å½•åƒå¤±è´¥: " + errorMsg);
        }
    } catch (Exception e) {
        log.error("æŸ¥è¯¢å½•åƒå¼‚å¸¸: deviceId={}, channelId={}", deviceId, channelId, e);
        throw new RuntimeException("æŸ¥è¯¢å½•åƒå¼‚å¸¸: " + e.getMessage(), e);
    }
}
```

#### 2. VideoDeviceService.java - æ–°å¢å½•åƒæŸ¥è¯¢æ–¹æ³•ï¼ˆå«æƒé™æ ¡éªŒï¼‰

```java
/**
 * æŸ¥è¯¢å½•åƒåˆ—è¡¨ï¼ˆå«æƒé™æ ¡éªŒï¼‰
 * 
 * @param deviceId GB28181è®¾å¤‡ç¼–ç 
 * @param channelId GB28181é€šé“ç¼–ç 
 * @param startTime å¼€å§‹æ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @param endTime ç»“æŸæ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @param userGroupIds ç”¨æˆ·å¯è§åˆ†ç»„IDåˆ—è¡¨
 * @return å½•åƒä¿¡æ¯
 */
public JSONObject queryRecord(String deviceId, String channelId, String startTime, String endTime, List<Long> userGroupIds) {
    // æ ¡éªŒè®¾å¤‡æƒé™
    LambdaQueryWrapper<VideoDevice> query = new LambdaQueryWrapper<>();
    query.eq(VideoDevice::getDeviceId, deviceId)
         .eq(VideoDevice::getChannelId, channelId);
    
    // æ•°æ®æƒé™è¿‡æ»¤
    if (userGroupIds != null && !userGroupIds.isEmpty()) {
        query.in(VideoDevice::getGroupId, userGroupIds);
    }
    
    VideoDevice device = this.getOne(query);
    if (device == null) {
        throw new RuntimeException("è®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®");
    }
    
    // è°ƒç”¨WVPæŸ¥è¯¢å½•åƒ
    return wvpService.queryRecord(deviceId, channelId, startTime, endTime);
}
```

#### 3. VideoRecordQueryRequest.java - æ–°å»ºDTOç±»

```java
package com.iot.platform.dto.video;

import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Pattern;

/**
 * å½•åƒæŸ¥è¯¢è¯·æ±‚DTO
 */
@Data
public class VideoRecordQueryRequest {
    @NotBlank(message = "è®¾å¤‡ç¼–ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d+$", message = "è®¾å¤‡ç¼–ç å¿…é¡»ä¸ºæ•°å­—")
    private String deviceId;
    
    @NotBlank(message = "é€šé“ç¼–ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d+$", message = "é€šé“ç¼–ç å¿…é¡»ä¸ºæ•°å­—")
    private String channelId;
    
    @NotBlank(message = "å¼€å§‹æ—¶é—´ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$", message = "å¼€å§‹æ—¶é—´æ ¼å¼é”™è¯¯")
    private String startTime;
    
    @NotBlank(message = "ç»“æŸæ—¶é—´ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$", message = "ç»“æŸæ—¶é—´æ ¼å¼é”™è¯¯")
    private String endTime;
}
```

#### 4. WvpService.java - æ–°å¢å½•åƒå›æ”¾æ–¹æ³•

```java
/**
 * è·å–å½•åƒå›æ”¾æµåœ°å€
 * 
 * @param deviceId GB28181è®¾å¤‡ç¼–ç 
 * @param channelId GB28181é€šé“ç¼–ç 
 * @param startTime å¼€å§‹æ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @param endTime ç»“æŸæ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @return è§†é¢‘æµä¿¡æ¯
 */
public JSONObject getPlaybackUrl(String deviceId, String channelId, String startTime, String endTime) {
    try {
        // æ„å»ºURLï¼Œå‚æ•°é€šè¿‡queryä¼ é€’
        String baseUrl = wvpConfigService.getWvpServerUrl() + "/api/playback/start/" + deviceId + "/" + channelId;
        HttpUrl url = HttpUrl.parse(baseUrl).newBuilder()
                .addQueryParameter("startTime", startTime)
                .addQueryParameter("endTime", endTime)
                .build();
        
        Request request = new Request.Builder()
                .url(url)
                .addHeader("access-token", getAccessToken())
                .get()
                .build();
        
        Response response = httpClient.newCall(request).execute();
        String responseBody = response.body().string();
        
        log.debug("WVPå›æ”¾åœ°å€å“åº”: deviceId={}, channelId={}, response={}", deviceId, channelId, responseBody);
        
        JSONObject json = JSON.parseObject(responseBody);
        if (json.getInteger("code") == 0) {
            return json.getJSONObject("data");
        } else {
            String errorMsg = json.getString("msg");
            log.error("è·å–å›æ”¾åœ°å€å¤±è´¥: deviceId={}, channelId={}, error={}", deviceId, channelId, errorMsg);
            throw new RuntimeException("WVPè·å–å›æ”¾åœ°å€å¤±è´¥: " + errorMsg);
        }
    } catch (Exception e) {
        log.error("è·å–å›æ”¾åœ°å€å¼‚å¸¸: deviceId={}, channelId={}", deviceId, channelId, e);
        throw new RuntimeException("è·å–å›æ”¾åœ°å€å¤±è´¥: " + e.getMessage(), e);
    }
}
```

#### 5. VideoDeviceService.java - æ–°å¢å½•åƒå›æ”¾æ–¹æ³•ï¼ˆå«æƒé™æ ¡éªŒï¼‰

```java
/**
 * è·å–å½•åƒå›æ”¾æµåœ°å€ï¼ˆå«æƒé™æ ¡éªŒï¼‰
 * 
 * @param deviceId GB28181è®¾å¤‡ç¼–ç 
 * @param channelId GB28181é€šé“ç¼–ç 
 * @param startTime å¼€å§‹æ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @param endTime ç»“æŸæ—¶é—´ï¼ˆè®¾å¤‡æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
 * @param userGroupIds ç”¨æˆ·å¯è§åˆ†ç»„IDåˆ—è¡¨
 * @return å›æ”¾æµåœ°å€ä¿¡æ¯
 */
public JSONObject getPlaybackUrl(String deviceId, String channelId, String startTime, String endTime, List<Long> userGroupIds) {
    // æ ¡éªŒè®¾å¤‡æƒé™
    LambdaQueryWrapper<VideoDevice> query = new LambdaQueryWrapper<>();
    query.eq(VideoDevice::getDeviceId, deviceId)
         .eq(VideoDevice::getChannelId, channelId);
    
    // æ•°æ®æƒé™è¿‡æ»¤
    if (userGroupIds != null && !userGroupIds.isEmpty()) {
        query.in(VideoDevice::getGroupId, userGroupIds);
    }
    
    VideoDevice device = this.getOne(query);
    if (device == null) {
        throw new RuntimeException("è®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®");
    }
    
    // è°ƒç”¨WVPè·å–å›æ”¾åœ°å€
    JSONObject playbackInfo = wvpService.getPlaybackUrl(deviceId, channelId, startTime, endTime);
    
    // æå–HTTPS HLSåœ°å€ï¼ˆä¼˜å…ˆä½¿ç”¨HTTPS HLSï¼Œä¸å®æ—¶æ’­æ”¾ä¿æŒä¸€è‡´ï¼‰
    // å“åº”å­—æ®µï¼šhttps_hls = "https://lxs.fjqiaolong.com:8443/rtp/.../hls.m3u8"
    String hlsUrl = playbackInfo.getString("https_hls");
    if (!StringUtils.hasText(hlsUrl)) {
        // å¦‚æœæ²¡æœ‰HTTPS HLSï¼Œå°è¯•ä½¿ç”¨æ™®é€šHLS
        hlsUrl = playbackInfo.getString("hls");
    }
    
    // æ„å»ºå“åº”
    JSONObject result = new JSONObject();
    result.put("hlsUrl", hlsUrl);
    result.put("deviceId", deviceId);
    result.put("channelId", channelId);
    result.put("startTime", startTime);
    result.put("endTime", endTime);
    
    return result;
}
```

#### 6. VideoRecordPlaybackRequest.java - æ–°å»ºDTOç±»

```java
package com.iot.platform.dto.video;

import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Pattern;

/**
 * å½•åƒå›æ”¾è¯·æ±‚DTO
 */
@Data
public class VideoRecordPlaybackRequest {
    @NotBlank(message = "è®¾å¤‡ç¼–ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d+$", message = "è®¾å¤‡ç¼–ç å¿…é¡»ä¸ºæ•°å­—")
    private String deviceId;
    
    @NotBlank(message = "é€šé“ç¼–ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d+$", message = "é€šé“ç¼–ç å¿…é¡»ä¸ºæ•°å­—")
    private String channelId;
    
    @NotBlank(message = "å¼€å§‹æ—¶é—´ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$", message = "å¼€å§‹æ—¶é—´æ ¼å¼é”™è¯¯")
    private String startTime;
    
    @NotBlank(message = "ç»“æŸæ—¶é—´ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$", message = "ç»“æŸæ—¶é—´æ ¼å¼é”™è¯¯")
    private String endTime;
}
```

#### 7. VideoController.java - æ–°å¢å½•åƒæŸ¥è¯¢å’Œå›æ”¾æ¥å£

```java
/**
 * 16.7 æŸ¥è¯¢å½•åƒåˆ—è¡¨
 */
@PostMapping("/record/query")
public Result<?> queryRecord(@Validated @RequestBody VideoRecordQueryRequest request,
                            @RequestHeader(value = "Authorization", required = false) String token) {
    try {
        // è·å–å½“å‰ç”¨æˆ·
        User user = getCurrentUser(token);
        if (user == null) {
            return Result.error("æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ");
        }
        
        // è·å–ç”¨æˆ·å¯è§åˆ†ç»„
        List<Long> userGroupIds = getUserVisibleGroupIds(user);
        
        // æŸ¥è¯¢å½•åƒåˆ—è¡¨ï¼ˆæ—¶é—´ç›´æ¥ä¼ é€’ï¼Œä¸åšè½¬æ¢ï¼‰
        JSONObject recordInfo = videoDeviceService.queryRecord(
                request.getDeviceId(),
                request.getChannelId(),
                request.getStartTime(),
                request.getEndTime(),
                userGroupIds
        );
        
        return Result.success(recordInfo);
    } catch (Exception e) {
        log.error("æŸ¥è¯¢å½•åƒå¤±è´¥: deviceId={}, channelId={}", 
                request.getDeviceId(), request.getChannelId(), e);
        return Result.error(e.getMessage());
    }
}

/**
 * 16.8 è·å–å½•åƒå›æ”¾æµåœ°å€
 */
@PostMapping("/record/playback")
public Result<?> playbackRecord(@Validated @RequestBody VideoRecordPlaybackRequest request,
                                @RequestHeader(value = "Authorization", required = false) String token) {
    try {
        // è·å–å½“å‰ç”¨æˆ·
        User user = getCurrentUser(token);
        if (user == null) {
            return Result.error("æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ");
        }
        
        // è·å–ç”¨æˆ·å¯è§åˆ†ç»„
        List<Long> userGroupIds = getUserVisibleGroupIds(user);
        
        // è·å–å›æ”¾æµåœ°å€ï¼ˆæ—¶é—´ç›´æ¥ä¼ é€’ï¼Œä¸åšè½¬æ¢ï¼‰
        JSONObject playbackInfo = videoDeviceService.getPlaybackUrl(
                request.getDeviceId(),
                request.getChannelId(),
                request.getStartTime(),
                request.getEndTime(),
                userGroupIds
        );
        
        return Result.success(playbackInfo);
    } catch (Exception e) {
        log.error("è·å–å½•åƒå›æ”¾æµå¤±è´¥: deviceId={}, channelId={}", 
                request.getDeviceId(), request.getChannelId(), e);
        return Result.error(e.getMessage());
    }
}
```

### å‰ç«¯å®ç°

#### 1. frontend/src/api/video.js - æ–°å¢å½•åƒæŸ¥è¯¢å’Œå›æ”¾API

```javascript
/**
 * æŸ¥è¯¢å½•åƒåˆ—è¡¨
 */
export function queryRecord(params) {
  return request({
    url: '/video/record/query',
    method: 'post',
    data: params
  })
}

/**
 * è·å–å½•åƒå›æ”¾æµåœ°å€
 */
export function playbackRecord(params) {
  return request({
    url: '/video/record/playback',
    method: 'post',
    data: params
  })
}
```

#### 2. frontend/src/views/VideoDetail.vue - æ–°å¢å†å²å½•åƒæ ‡ç­¾é¡µ

åœ¨ç°æœ‰çš„"å®æ—¶è§†é¢‘"æ ‡ç­¾é¡µåŸºç¡€ä¸Šï¼Œæ–°å¢"å†å²å½•åƒ"æ ‡ç­¾é¡µï¼ˆå‚è€ƒåŸå‹ `prototypes/video-record.html`ï¼‰ï¼š

- **å·¦ä¾§é¢æ¿**:
  - æ—¥æœŸé€‰æ‹©å™¨ï¼ˆé»˜è®¤å½“å¤©ï¼‰
  - å½•åƒç‰‡æ®µåˆ—è¡¨ï¼ˆæ˜¾ç¤ºæ—¶é—´æ®µå’Œæ—¶é•¿ï¼‰
  - ç‚¹å‡»åˆ—è¡¨é¡¹å¯é€‰ä¸­å¹¶è®¾ç½®æ’­æ”¾æ—¶é—´

- **å³ä¾§é¢æ¿**:
  - è§†é¢‘æ’­æ”¾å™¨ï¼ˆä½¿ç”¨VideoPlayerç»„ä»¶ï¼‰
  - æ’­æ”¾æ§åˆ¶æ ï¼ˆæ’­æ”¾/æš‚åœ/åœæ­¢/é™éŸ³/å…¨å±ç­‰ï¼‰
  - æ—¶é—´è½´ï¼ˆ24å°æ—¶ï¼Œè“è‰²æ®µè¡¨ç¤ºå½•åƒç‰‡æ®µï¼‰
  - æ—¶é—´æ§åˆ¶ï¼ˆå¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´è¾“å…¥æ¡†ã€æ’­æ”¾æŒ‰é’®ã€å€é€Ÿé€‰æ‹©ï¼‰

- **æ ¸å¿ƒåŠŸèƒ½**:
  - è¿›å…¥é¡µé¢è‡ªåŠ¨æŸ¥è¯¢å½“å¤©å½•åƒ
  - æ—¶é—´è½´å¯è§†åŒ–æ˜¾ç¤ºå½•åƒç‰‡æ®µ
  - ç‚¹å‡»å½•åƒç‰‡æ®µæˆ–æ—¶é—´è½´æ’­æ”¾
  - æ”¯æŒæ‰‹åŠ¨è¾“å…¥æ—¶é—´èŒƒå›´æ’­æ”¾

---

## ğŸ“ APIæ–‡æ¡£æ›´æ–°

### 16.7 æŸ¥è¯¢å½•åƒåˆ—è¡¨

**æ¥å£è·¯å¾„**: `POST /api/video/record/query`

**æ¥å£è¯´æ˜**: æŸ¥è¯¢è§†é¢‘è®¾å¤‡çš„å½•åƒåˆ—è¡¨

**æƒé™è¦æ±‚**: éœ€è¦è®¤è¯ï¼Œæ•°æ®æƒé™æ ¡éªŒ

**è¯·æ±‚å‚æ•°**:

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| deviceId | String | æ˜¯ | GB28181è®¾å¤‡ç¼–ç  |
| channelId | String | æ˜¯ | GB28181é€šé“ç¼–ç  |
| startTime | String | æ˜¯ | å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼ˆè®¾å¤‡æ—¶é—´ï¼‰ |
| endTime | String | æ˜¯ | ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼ˆè®¾å¤‡æ—¶é—´ï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
  "deviceId": "43000000801218000197",
  "channelId": "43000000801320004237",
  "startTime": "2026-01-16 00:00:00",
  "endTime": "2026-01-16 23:59:59"
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deviceId": "43000000801218000197",
    "channelId": "43000000801320004237",
    "sn": "248596",
    "name": "Camera 01",
    "sumNum": 4,
    "count": 4,
    "lastTime": null,
    "recordList": [
      {
        "deviceId": "43000000801320004237",
        "name": "Camera 01",
        "filePath": "",
        "fileSize": null,
        "address": "",
        "startTime": "2026-01-16 07:49:57",
        "endTime": "2026-01-16 07:51:10",
        "secrecy": 0,
        "type": "time",
        "recorderId": ""
      }
    ]
  }
}
```

**é”™è¯¯å“åº”**ï¼ˆè®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™ï¼‰:

```json
{
  "code": 404,
  "message": "è®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®",
  "data": null
}
```

**ç‰¹æ®Šè¯´æ˜**:
- è°ƒç”¨WVPæ¥å£ `GET /api/gb_record/query/{deviceId}/{channelId}` æŸ¥è¯¢å½•åƒ
- æ—¶é—´å‚æ•°ç›´æ¥ä¼ é€’ï¼Œä¸åšæ—¶åŒºè½¬æ¢ï¼ˆè®¾å¤‡æ—¶é—´ï¼‰
- WVPè¿”å›çš„æ—¶é—´ä¹Ÿæ˜¯è®¾å¤‡æ—¶é—´ï¼Œç›´æ¥è¿”å›ç»™å‰ç«¯
- æ•°æ®æƒé™ï¼šæ ¡éªŒè¯¥è®¾å¤‡æ˜¯å¦åœ¨ç”¨æˆ·å¯è§åˆ†ç»„å†…

---

### 16.8 è·å–å½•åƒå›æ”¾æµåœ°å€

**æ¥å£è·¯å¾„**: `POST /api/video/record/playback`

**æ¥å£è¯´æ˜**: è·å–è§†é¢‘è®¾å¤‡çš„å½•åƒå›æ”¾HLSæµåœ°å€ï¼ˆHTTPSï¼‰

**æƒé™è¦æ±‚**: éœ€è¦è®¤è¯ï¼Œæ•°æ®æƒé™æ ¡éªŒ

**è¯·æ±‚å‚æ•°**:

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| deviceId | String | æ˜¯ | GB28181è®¾å¤‡ç¼–ç  |
| channelId | String | æ˜¯ | GB28181é€šé“ç¼–ç  |
| startTime | String | æ˜¯ | å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼ˆè®¾å¤‡æ—¶é—´ï¼‰ |
| endTime | String | æ˜¯ | ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼ˆè®¾å¤‡æ—¶é—´ï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
  "deviceId": "43000000801218000197",
  "channelId": "43000000801320004237",
  "startTime": "2026-01-16 07:49:57",
  "endTime": "2026-01-16 07:51:10"
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hlsUrl": "https://lxs.fjqiaolong.com:8443/rtp/43000000801218000197_43000000801320004237_20260116074957_20260116075110/hls.m3u8",
    "deviceId": "43000000801218000197",
    "channelId": "43000000801320004237",
    "startTime": "2026-01-16 07:49:57",
    "endTime": "2026-01-16 07:51:10"
  }
}
```

**é”™è¯¯å“åº”**ï¼ˆè®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™ï¼‰:

```json
{
  "code": 404,
  "message": "è®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®",
  "data": null
}
```

**é”™è¯¯å“åº”**ï¼ˆå›æ”¾å¤±è´¥ï¼‰:

```json
{
  "code": 500,
  "message": "è·å–å›æ”¾æµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
  "data": null
}
```

**ç‰¹æ®Šè¯´æ˜**:
- è°ƒç”¨WVPæ¥å£ `GET /api/playback/start/{deviceId}/{channelId}` è·å–å›æ”¾æµ
- ä»WVPå“åº”ä¸­æå– `https_hls` å­—æ®µï¼ˆHTTPSçš„HLSæµåœ°å€ï¼‰
  - å“åº”ç¤ºä¾‹ï¼š`"https_hls": "https://lxs.fjqiaolong.com:8443/rtp/43000000801218000197_43000000801320004237_20260116074957_20260116075110/hls.m3u8"`
  - å¦‚æœæ²¡æœ‰ `https_hls`ï¼Œåˆ™fallbackåˆ° `hls` å­—æ®µ
- å‰ç«¯ä½¿ç”¨HTML5 videoæ ‡ç­¾æˆ–HLS.jsæ’­æ”¾è¯¥åœ°å€ï¼ˆå¤ç”¨VideoPlayerç»„ä»¶ï¼‰
- æ—¶é—´å‚æ•°ç›´æ¥ä¼ é€’ï¼Œä¸åšæ—¶åŒºè½¬æ¢ï¼ˆè®¾å¤‡æ—¶é—´ï¼‰
- æ•°æ®æƒé™ï¼šæ ¡éªŒè¯¥è®¾å¤‡æ˜¯å¦åœ¨ç”¨æˆ·å¯è§åˆ†ç»„å†…

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ—¶é—´å¤„ç†**: 
   - âœ… å½•åƒæ—¶é—´ä¸éœ€è¦æ—¶åŒºè½¬æ¢
   - âœ… å‰ç«¯ä¼ å…¥çš„æ—¶é—´ç›´æ¥ä¼ ç»™WVP
   - âœ… WVPè¿”å›çš„æ—¶é—´ç›´æ¥è¿”å›ç»™å‰ç«¯

2. **æ•°æ®æƒé™**: 
   - âœ… å¤ç”¨ç°æœ‰çš„æƒé™æ ¡éªŒé€»è¾‘
   - âœ… æ ¡éªŒè®¾å¤‡æ˜¯å¦åœ¨ç”¨æˆ·å¯è§åˆ†ç»„å†…

3. **é”™è¯¯å¤„ç†**: 
   - âœ… WVPæ¥å£è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
   - âœ… è®¾å¤‡ä¸å­˜åœ¨æˆ–æ— æƒé™æ—¶ï¼Œè¿”å›404é”™è¯¯

4. **å½•åƒå›æ”¾**: 
   - âœ… WVPå½•åƒå›æ”¾æ¥å£å·²ç¡®è®¤ï¼š`GET /api/playback/start/{deviceId}/{channelId}`
   - âœ… éœ€è¦ä¼ é€’ `startTime` å’Œ `endTime` å‚æ•°ï¼ˆè®¾å¤‡æ—¶é—´ï¼‰
   - âœ… è¿”å›æµåœ°å€æ ¼å¼ä¸å®æ—¶æ’­æ”¾ç›¸åŒï¼ˆåŒ…å« `https_hls` å­—æ®µï¼‰

---

## âœ… å·²ç¡®è®¤äº‹é¡¹

1. **å½•åƒå›æ”¾æ¥å£**: âœ… å·²ç¡®è®¤
   - æ¥å£è·¯å¾„ï¼š`GET /api/playback/start/{deviceId}/{channelId}`
   - å‚æ•°ï¼š`startTime` å’Œ `endTime`ï¼ˆqueryå‚æ•°ï¼‰
   - è®¤è¯ï¼š`access-token` header
   - è¿”å›ï¼šæµåœ°å€ä¿¡æ¯ï¼ˆåŒ…å« `https_hls` å­—æ®µï¼‰

2. **UIè®¾è®¡**: âœ… å·²ç¡®è®¤
   - å½•åƒæŸ¥è¯¢æ”¾åœ¨è§†é¢‘è¯¦æƒ…é¡µçš„æ–°æ ‡ç­¾é¡µï¼ˆ"å†å²å½•åƒ"ï¼‰
   - é»˜è®¤æŸ¥è¯¢å½“å¤©å½•åƒ
   - å‚è€ƒåŸå‹ï¼š`prototypes/video-record.html`

3. **åŠŸèƒ½ç»†èŠ‚**: 
   - å½•åƒä¸‹è½½åŠŸèƒ½ï¼šæš‚ä¸å®ç°ï¼ˆåç»­å¯æ‰©å±•ï¼‰
   - å½•åƒåˆ—è¡¨ï¼šä¸éœ€è¦åˆ†é¡µï¼ˆå•å¤©æ•°æ®é‡ä¸å¤§ï¼‰

---

## ğŸ“‹ å¼€å‘æ­¥éª¤

1. âœ… æ›´æ–°APIæ–‡æ¡£ï¼ˆ`docs/API.md`ï¼‰
2. â³ ç­‰å¾…ç”¨æˆ·ç¡®è®¤æ–¹æ¡ˆ
3. â³ åˆ›å»ºDTOç±»ï¼ˆ`VideoRecordQueryRequest.java`ã€`VideoRecordPlaybackRequest.java`ï¼‰
4. â³ å®ç°WvpServiceå½•åƒæŸ¥è¯¢æ–¹æ³•ï¼ˆ`queryRecord`ï¼‰
5. â³ å®ç°WvpServiceå½•åƒå›æ”¾æ–¹æ³•ï¼ˆ`getPlaybackUrl`ï¼‰
6. â³ å®ç°VideoDeviceServiceå½•åƒæŸ¥è¯¢æ–¹æ³•ï¼ˆå«æƒé™æ ¡éªŒï¼‰
7. â³ å®ç°VideoDeviceServiceå½•åƒå›æ”¾æ–¹æ³•ï¼ˆå«æƒé™æ ¡éªŒï¼‰
8. â³ å®ç°VideoControllerå½•åƒæŸ¥è¯¢æ¥å£ï¼ˆ`POST /api/video/record/query`ï¼‰
9. â³ å®ç°VideoControllerå½•åƒå›æ”¾æ¥å£ï¼ˆ`POST /api/video/record/playback`ï¼‰
10. â³ å‰ç«¯APIå°è£…ï¼ˆ`video.js`ï¼š`queryRecord`ã€`playbackRecord`ï¼‰
11. â³ å‰ç«¯UIå®ç°ï¼ˆ`VideoDetail.vue`ï¼šæ–°å¢"å†å²å½•åƒ"æ ‡ç­¾é¡µï¼‰
12. â³ æµ‹è¯•éªŒè¯

---

*æœ€åæ›´æ–°ï¼š2026-01-16*
