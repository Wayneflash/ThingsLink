# 完整修复指南 - 首页和消息通知功能

## 🔍 问题分析

从错误信息看，有两个主要问题：

1. **405 Method Not Allowed** - `/devices/statistics`
   - 原因：后端服务没有重启，还在使用旧的GET方法
   - 解决：重启后端服务

2. **404 Not Found** - `/notification/list`
   - 原因1：后端服务没有重启，新代码没有加载
   - 原因2：数据库表未创建，导致服务启动失败
   - 解决：创建数据库表 + 重启后端服务

## ✅ 修复步骤

### 步骤1：创建数据库表

```bash
# 方法1：使用修复脚本（推荐）
修复通知功能.bat

# 方法2：手动执行
docker exec -i iot-mysql mysql -uroot -proot123456 iot_platform < migration_add_notification_table.sql
```

### 步骤2：重启后端服务

**重要：必须重启后端服务才能生效！**

```bash
# 如果使用Docker运行后端
docker restart iot-backend

# 如果直接运行JAR包
# 1. 停止当前运行的后端服务（Ctrl+C）
# 2. 重新启动：
java -jar backend/target/iot-platform.jar

# 如果使用IDE运行
# 1. 停止当前运行
# 2. 重新运行 IotPlatformApplication
```

### 步骤3：验证修复

1. **检查后端日志**，确认：
   - 没有数据库表相关的错误
   - NotificationController已加载
   - 服务启动成功

2. **刷新前端页面**（Ctrl+F5强制刷新）

3. **打开浏览器开发者工具**（F12）
   - Network标签页
   - 点击通知图标
   - 查看请求状态应该是200

## 🐛 常见问题

### Q1: 重启后端后还是405错误？
**A:** 检查后端日志，确认代码是否真的重新编译了。可能需要：
- 清理并重新编译：`cd backend && mvn clean package -DskipTests`
- 确保使用的是新编译的JAR包

### Q2: 重启后端后还是404错误？
**A:** 检查：
1. 数据库表是否创建成功
2. 后端日志是否有错误
3. NotificationController是否被Spring扫描到

### Q3: 如何确认数据库表已创建？
**A:** 执行：
```sql
docker exec -it iot-mysql mysql -uroot -proot123456 iot_platform -e "SHOW TABLES LIKE 'tb_notification';"
```

## 📝 验证清单

- [ ] 数据库表 `tb_notification` 已创建
- [ ] 后端服务已重启
- [ ] 后端日志无错误
- [ ] 前端页面已刷新
- [ ] `/devices/statistics` 返回200（不再是405）
- [ ] `/notification/list` 返回200（不再是404）

## 🚀 快速修复命令（一键执行）

```bash
# Windows PowerShell
docker exec -i iot-mysql mysql -uroot -proot123456 iot_platform < migration_add_notification_table.sql
echo "数据库表创建完成，请重启后端服务！"
```
