<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²ç®¡ç† - ç‰©è”ç½‘å¹³å°</title>
    <link rel="stylesheet" href="common-style.css">
    <style>
        .role-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .permission-tree { background: #f5f5f7; padding: 16px; border-radius: 8px; max-height: 400px; overflow-y: auto; }
        .tree-node { padding: 8px; margin: 4px 0; }
        .tree-node input { margin-right: 8px; }
        .tree-child { margin-left: 24px; }
        
        /* è§’è‰²åˆ—è¡¨é€‰ä¸­æ•ˆæœ */
        .role-row { cursor: pointer; transition: background-color 0.2s; }
        .role-row:hover { background-color: #f5f5f7; }
        .role-row.selected { background-color: #007aff; color: white; }
        .role-row.selected .btn { background: white; color: #007aff; }
        .role-row.selected .badge { background: rgba(255,255,255,0.3); color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ğŸš€ ç‰©è”ç½‘å¹³å°</div>
        <div class="user-info"><span>ğŸ‘¤ admin</span><a href="login.html">é€€å‡º</a></div>
    </div>

    <div class="container">
        <div class="sidebar">
            <a href="dashboard.html" class="menu-item"><span class="icon">ğŸ“Š</span> æ•°æ®ç›‘æ§</a>
            <a href="device-group.html" class="menu-item"><span class="icon">ğŸ—‚ï¸</span> è®¾å¤‡åˆ†ç»„</a>
            <a href="device-list.html" class="menu-item"><span class="icon">ğŸ“±</span> è®¾å¤‡ç®¡ç†</a>
            <a href="product-manage.html" class="menu-item"><span class="icon">ğŸ“¦</span> äº§å“ç®¡ç†</a>
            <!-- <a href="data-query.html" class="menu-item"><span class="icon">ğŸ”</span> æ•°æ®æŸ¥è¯¢</a> -->
            <div class="menu-divider"></div>
            <a href="user-manage.html" class="menu-item"><span class="icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="role-manage.html" class="menu-item active" id="roleMenuItem"><span class="icon">ğŸ­</span> è§’è‰²ç®¡ç†</a>
            <div class="menu-divider"></div>
            <a href="index.html" class="menu-item"><span class="icon">ğŸ </span> è¿”å›å¯¼èˆª</a>
        </div>

        <div class="main-content">
            <h1 class="page-title">è§’è‰²ç®¡ç†</h1>

            <div class="prototype-note">
                <strong>ğŸ“‹ åŸå‹è¯´æ˜</strong><br>
                è§’è‰²ç®¡ç†ç”¨äºé…ç½®ä¸åŒè§’è‰²çš„èœå•æƒé™<br>
                â€¢ è§’è‰²æ˜¯æƒé™çš„é›†åˆï¼Œç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—æƒé™<br>
                â€¢ å‹¾é€‰èœå•æƒé™åï¼Œè¯¥è§’è‰²çš„ç”¨æˆ·ç™»å½•ååªèƒ½çœ‹åˆ°å‹¾é€‰çš„èœå•<br>
                â€¢ æ”¯æŒåˆ›å»ºä»»æ„è‡ªå®šä¹‰è§’è‰²ï¼ˆå¦‚ï¼šè¿ç»´ã€å®¢æœã€åªè¯»ç”¨æˆ·ç­‰ï¼‰<br>
                <br>
                <strong>ğŸ”’ æƒé™è¯´æ˜ï¼š</strong><br>
                <span style="color: #ff3b30;">â€¢ åªæœ‰è¶…çº§ç®¡ç†å‘˜æ‰èƒ½åˆ›å»º/ç¼–è¾‘/åˆ é™¤è§’è‰²</span><br>
                â€¢ å…¶ä»–è§’è‰²å¯ä»¥æŸ¥çœ‹è§’è‰²åˆ—è¡¨ï¼Œä½†æ— æ³•ä¿®æ”¹ï¼ˆåªè¯»æ¨¡å¼ï¼‰
            </div>

            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <button class="btn btn-primary" id="createRoleBtn" onclick="alert('æ‰“å¼€åˆ›å»ºè§’è‰²å¼¹çª—')">+ åˆ›å»ºè§’è‰²</button>
            </div>

            <div class="role-container">
                <div class="card">
                    <div class="card-title">è§’è‰²åˆ—è¡¨</div>
                    <table>
                        <thead>
                            <tr>
                                <th>è§’è‰²åç§°</th>
                                <th>ç”¨æˆ·æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="role-row" onclick="selectRole(1, 'admin', this)">
                                <td>è¶…çº§ç®¡ç†å‘˜</td>
                                <td>1</td>
                                <td>
                                    <span class="badge badge-info">ç³»ç»Ÿé¢„è®¾</span>
                                </td>
                            </tr>
                            <tr class="role-row" onclick="selectRole(2, 'device', this)">
                                <td>è®¾å¤‡ç®¡ç†å‘˜</td>
                                <td>3</td>
                                <td>
                                    <button class="btn btn-danger role-delete-btn" onclick="event.stopPropagation(); alert('åˆ é™¤è§’è‰²')">åˆ é™¤</button>
                                </td>
                            </tr>
                            <tr class="role-row" onclick="selectRole(3, 'viewer', this)">
                                <td>æ•°æ®æŸ¥çœ‹å‘˜</td>
                                <td>5</td>
                                <td>
                                    <button class="btn btn-danger role-delete-btn" onclick="event.stopPropagation(); alert('åˆ é™¤è§’è‰²')">åˆ é™¤</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">æƒé™é…ç½®</div>
                    
                    <!-- æœªé€‰æ‹©è§’è‰²æ—¶çš„æç¤º -->
                    <div id="noRoleSelected" style="text-align: center; padding: 60px 20px; color: #86868b;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ­</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²</div>
                        <div style="font-size: 14px;">ç‚¹å‡»å·¦ä¾§è§’è‰²åˆ—è¡¨çš„"ç¼–è¾‘æƒé™"æŒ‰é’®</div>
                    </div>
                    
                    <!-- é€‰æ‹©è§’è‰²åæ˜¾ç¤ºçš„æƒé™é…ç½®åŒºåŸŸ -->
                    <div id="permissionConfig" style="display: none;">
                        <div style="padding: 12px; background: #f5f5f7; border-radius: 6px; margin-bottom: 16px;">
                            <strong>å½“å‰é…ç½®è§’è‰²ï¼š</strong><span id="currentRoleName" style="color: #007aff;">è®¾å¤‡ç®¡ç†å‘˜</span>
                        </div>
                        
                        <div class="permission-tree" id="permissionTree">
                            <div class="tree-node">
                                <input type="checkbox" checked> <strong>æ•°æ®ç›‘æ§</strong>
                            </div>
                            
                            <div class="tree-node">
                                <input type="checkbox" checked> <strong>è®¾å¤‡åˆ†ç»„</strong>
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox" checked> æŸ¥çœ‹åˆ†ç»„
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox" checked> åˆ›å»ºåˆ†ç»„
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox"> åˆ é™¤åˆ†ç»„
                            </div>
                            
                            <div class="tree-node">
                                <input type="checkbox" checked> <strong>è®¾å¤‡ç®¡ç†</strong>
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox" checked> æŸ¥çœ‹è®¾å¤‡
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox" checked> åˆ›å»ºè®¾å¤‡
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox" checked> ä¸‹å‘å‘½ä»¤
                            </div>
                            <div class="tree-node tree-child">
                                <input type="checkbox"> åˆ é™¤è®¾å¤‡
                            </div>
                            
                            <div class="tree-node">
                                <input type="checkbox"> <strong>äº§å“ç®¡ç†</strong>
                            </div>
                            
                            <div class="tree-node">
                                <input type="checkbox" checked> <strong>æ•°æ®æŸ¥è¯¢</strong>
                            </div>
                            
                            <div class="tree-node">
                                <input type="checkbox"> <strong>ç”¨æˆ·ç®¡ç†</strong>
                            </div>
                            
                            <div class="tree-node">
                                <input type="checkbox"> <strong>è§’è‰²ç®¡ç†</strong>
                            </div>
                        </div>
                        
                        <div class="prototype-note" style="margin-top: 16px;">
                            <strong>ğŸ’¡ æƒé™è¯´æ˜</strong><br>
                            â€¢ å‹¾é€‰çˆ¶èœå•ï¼šè¯¥è§’è‰²å¯ä»¥çœ‹åˆ°è¿™ä¸ªèœå•<br>
                            â€¢ å‹¾é€‰å­æƒé™ï¼šæ§åˆ¶å…·ä½“çš„å¢åˆ æ”¹æŸ¥æ“ä½œ<br>
                            â€¢ ä¿®æ”¹åéœ€ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
                        </div>
                        
                        <button class="btn btn-primary" id="savePermissionBtn" style="margin-top: 16px;" onclick="savePermissions()">ä¿å­˜æƒé™é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆæ¨¡æ‹Ÿï¼‰
        let currentUser = { id: 1, username: 'admin', roleIds: [1] }; // é»˜è®¤è¶…çº§ç®¡ç†å‘˜
        
        const availableRoles = [
            { id: 1, name: 'è¶…çº§ç®¡ç†å‘˜', isSuperAdmin: true },
            { id: 2, name: 'è®¾å¤‡ç®¡ç†å‘˜', isSuperAdmin: false },
            { id: 3, name: 'æ•°æ®æŸ¥çœ‹å‘˜', isSuperAdmin: false },
            { id: 4, name: 'è¿ç»´äººå‘˜', isSuperAdmin: false }
        ];
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æƒé™
        window.onload = function() {
            checkPagePermission();
        };
        
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ç¼–è¾‘è§’è‰²
        function checkPagePermission() {
            const isSuperAdmin = currentUser.roleIds.some(roleId => {
                const role = availableRoles.find(r => r.id === roleId);
                return role && role.isSuperAdmin;
            });
            
            if (!isSuperAdmin) {
                // éè¶…çº§ç®¡ç†å‘˜ï¼Œè¿›å…¥åªè¯»æ¨¡å¼
                setReadOnlyMode();
            }
        }
        
        // è®¾ç½®åªè¯»æ¨¡å¼
        function setReadOnlyMode() {
            // éšè—â€œåˆ›å»ºè§’è‰²â€æŒ‰é’®
            const createBtn = document.getElementById('createRoleBtn');
            if (createBtn) createBtn.style.display = 'none';
            
            // éšè—â€œç¼–è¾‘æƒé™â€å’Œâ€œåˆ é™¤â€æŒ‰é’®
            document.querySelectorAll('.role-edit-btn, .role-delete-btn').forEach(btn => {
                btn.style.display = 'none';
            });
            
            // éšè—â€œä¿å­˜æƒé™é…ç½®â€æŒ‰é’®
            const saveBtn = document.getElementById('savePermissionBtn');
            if (saveBtn) saveBtn.style.display = 'none';
            
            // ç¦ç”¨æ‰€æœ‰å¤é€‰æ¡†
            document.querySelectorAll('.permission-tree input[type="checkbox"]').forEach(cb => {
                cb.disabled = true;
            });
            
            // æ˜¾ç¤ºåªè¯»æ¨¡å¼æç¤º
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                pageTitle.innerHTML = 'è§’è‰²ç®¡ç† <span class="badge badge-warning" style="font-size: 14px; vertical-align: middle;">åªè¯»æ¨¡å¼</span>';
            }
        }
        
        // å½“å‰é€‰ä¸­çš„è§’è‰²
        let currentSelectedRole = null;
        let currentSelectedRow = null;
        
        // é€‰æ‹©è§’è‰²
        function selectRole(roleId, roleCode, rowElement) {
            // ç§»é™¤ä¹Šå‰çš„é€‰ä¸­æ•ˆæœ
            if (currentSelectedRow) {
                currentSelectedRow.classList.remove('selected');
            }
            
            // æ·»åŠ æ–°çš„é€‰ä¸­æ•ˆæœ
            rowElement.classList.add('selected');
            currentSelectedRow = rowElement;
            
            // æ˜¾ç¤ºæƒé™é…ç½®
            showPermissions(roleId, roleCode);
        }
        
        function showPermissions(roleId, roleCode) {
            // æ¨¡æ‹Ÿï¼šæ ¹æ®è§’è‰²codeè·å–è§’è‰²è¯¦æƒ…å’Œæƒé™é…ç½®
            const roleNames = {
                'admin': 'è¶…çº§ç®¡ç†å‘˜',
                'device': 'è®¾å¤‡ç®¡ç†å‘˜',
                'viewer': 'æ•°æ®æŸ¥çœ‹å‘˜'
            };
            
            currentSelectedRole = roleCode;
            
            // éšè—"æœªé€‰æ‹©è§’è‰²"æç¤º
            document.getElementById('noRoleSelected').style.display = 'none';
            
            // æ˜¾ç¤ºæƒé™é…ç½®åŒºåŸŸ
            document.getElementById('permissionConfig').style.display = 'block';
            
            // æ›´æ–°å½“å‰è§’è‰²åç§°
            document.getElementById('currentRoleName').textContent = roleNames[roleCode] || roleCode;
            
            // æ¨¡æ‹Ÿï¼šæ ¹æ®è§’è‰²åŠ è½½ä¸åŒçš„æƒé™é…ç½®
            loadRolePermissions(roleCode);
        }
        
        function loadRolePermissions(roleCode) {
            // è¿™é‡Œæ¨¡æ‹Ÿè°ƒç”¨æ¥å£ï¼šPOST /roles/detail { id: roleId }
            // æ ¹æ®è¿”å›çš„ permissions å’Œ menuPermissions æ¥å‹¾é€‰å¤é€‰æ¡†
            
            const checkboxes = document.querySelectorAll('#permissionTree input[type="checkbox"]');
            
            // å…ˆå…¨éƒ¨å–æ¶ˆå‹¾é€‰
            checkboxes.forEach(cb => cb.checked = false);
            
            // æ ¹æ®ä¸åŒè§’è‰²å‹¾é€‰ä¸åŒçš„æƒé™ï¼ˆæ¨¡æ‹Ÿï¼‰
            if (roleCode === 'admin') {
                // è¶…çº§ç®¡ç†å‘˜ï¼šå…¨éƒ¨å‹¾é€‰
                checkboxes.forEach(cb => cb.checked = true);
            } else if (roleCode === 'device') {
                // è®¾å¤‡ç®¡ç†å‘˜ï¼šéƒ¨åˆ†æƒé™
                checkboxes[0].checked = true; // æ•°æ®ç›‘æ§
                checkboxes[1].checked = true; // è®¾å¤‡åˆ†ç»„
                checkboxes[2].checked = true; // æŸ¥çœ‹åˆ†ç»„
                checkboxes[3].checked = true; // åˆ›å»ºåˆ†ç»„
                checkboxes[5].checked = true; // è®¾å¤‡ç®¡ç†
                checkboxes[6].checked = true; // æŸ¥çœ‹è®¾å¤‡
                checkboxes[7].checked = true; // åˆ›å»ºè®¾å¤‡
                checkboxes[8].checked = true; // ä¸‹å‘å‘½ä»¤
                checkboxes[11].checked = true; // æ•°æ®æŸ¥è¯¢
            } else if (roleCode === 'viewer') {
                // æ•°æ®æŸ¥çœ‹å‘˜ï¼šåªè¯»æƒé™
                checkboxes[0].checked = true; // æ•°æ®ç›‘æ§
                checkboxes[1].checked = true; // è®¾å¤‡åˆ†ç»„
                checkboxes[2].checked = true; // æŸ¥çœ‹åˆ†ç»„
                checkboxes[5].checked = true; // è®¾å¤‡ç®¡ç†
                checkboxes[6].checked = true; // æŸ¥çœ‹è®¾å¤‡
                checkboxes[11].checked = true; // æ•°æ®æŸ¥è¯¢
            }
        }
        
        function savePermissions() {
            if (!currentSelectedRole) {
                alert('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }
            
            // æ”¶é›†å‹¾é€‰çš„æƒé™
            const checkedPermissions = [];
            document.querySelectorAll('#permissionTree input[type="checkbox"]:checked').forEach(cb => {
                checkedPermissions.push(cb.parentElement.textContent.trim());
            });
            
            // æ¨¡æ‹Ÿè°ƒç”¨æ¥å£ï¼šPOST /roles/update
            alert('âœ… æƒé™é…ç½®å·²ä¿å­˜ï¼\n\nè§’è‰²ï¼š' + currentSelectedRole + '\nå‹¾é€‰çš„æƒé™ï¼š\n' + checkedPermissions.join('\n'));
        }
    </script>
</body>
</html>
