<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†é¢‘ç®¡ç† - ThingsLink IoTå¹³å°</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.3.14/dist/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-plus@2.3.14/dist/index.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
    }

    .video-management-page {
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1d1d1f;
    }

    .card-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      background: #fafafa;
      border-bottom: 1px solid #e5e5e7;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
      margin-right: auto;
    }

    .card-body {
      padding: 20px;
    }

    .el-table {
      margin-top: 20px;
    }

    .el-table th.el-table__cell {
      background-color: #f5f7fa;
      color: #606266;
      font-weight: 600;
    }

    .el-table .el-table__cell {
      padding: 12px 0;
    }

    .pagination-container {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e5e7;
      display: flex;
      justify-content: flex-end;
    }

    /* è¯¦æƒ…é¡µ */
    .detail-page {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .info-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .info-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e5e7;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .info-label {
      font-size: 12px;
      color: #999;
    }

    .info-value {
      font-size: 14px;
      color: #1d1d1f;
      font-weight: 500;
    }

    .video-container {
      background: #000;
      border-radius: 10px;
      padding: 40px;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .video-placeholder {
      text-align: center;
      color: #999;
    }

    .video-placeholder-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .video-placeholder-text {
      font-size: 16px;
      margin-bottom: 20px;
    }

    .play-button {
      padding: 12px 32px;
      font-size: 16px;
      border-radius: 8px;
      background: #007aff;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .play-button:hover {
      background: #0051d5;
    }

    .video-player {
      width: 100%;
      max-width: 1200px;
      height: auto;
      border-radius: 8px;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- åˆ—è¡¨é¡µ -->
    <div v-if="currentPage === 'list'" class="video-management-page">
      <h1 class="page-title">è§†é¢‘ç®¡ç†</h1>

      <div class="card-container">
        <div class="card-header">
          <div class="panel-header">
            <div class="panel-title">å…¨éƒ¨è§†é¢‘è®¾å¤‡ ({{ videoList.length }})</div>
            <el-input
              v-model="searchQuery"
              placeholder="ğŸ” æœç´¢è§†é¢‘åç§°æˆ–ç¼–ç "
              clearable
              style="width: 250px"
              @keyup.enter="handleSearch"
            />
            <el-select v-model="filterGroup" placeholder="æ‰€å±åˆ†ç»„" clearable style="width: 150px">
              <el-option label="å…¨éƒ¨åˆ†ç»„" value="" />
              <el-option label="åŠå…¬åŒº" value="åŠå…¬åŒº" />
              <el-option label="ç”Ÿäº§åŒº" value="ç”Ÿäº§åŒº" />
              <el-option label="ä»“åº“åŒº" value="ä»“åº“åŒº" />
            </el-select>
            <el-button type="primary" @click="handleSearch">æŸ¥è¯¢</el-button>
            <el-button @click="refreshList">åˆ·æ–°</el-button>
            <el-button type="primary" @click="openAddDialog">+ æ·»åŠ è§†é¢‘è®¾å¤‡</el-button>
            <el-button type="primary" plain @click="openBatchImport">â†‘ æ‰¹é‡å¯¼å…¥</el-button>
          </div>
        </div>

        <div class="card-body">
          <el-table :data="displayList" stripe v-loading="loading" border style="width: 100%">
            <el-table-column type="index" label="åºå·" width="80" align="center" />
            <el-table-column prop="name" label="è§†é¢‘åç§°" min-width="150" show-overflow-tooltip />
            <el-table-column prop="deviceId" label="è§†é¢‘ç¼–ç " min-width="200" show-overflow-tooltip />
            <el-table-column prop="channelId" label="é€šé“ç¼–ç " min-width="200" show-overflow-tooltip />
            <el-table-column prop="groupName" label="æ‰€å±åˆ†ç»„" min-width="120" />
            <el-table-column label="æ“ä½œ" width="240" align="center">
              <template #default="scope">
                <el-button size="small" type="primary" link @click="viewDetail(scope.row)">è¯¦æƒ…</el-button>
                <el-button size="small" type="primary" link @click="editDevice(scope.row)">ç¼–è¾‘</el-button>
                <el-button size="small" type="danger" link @click="deleteDevice(scope.row)">åˆ é™¤</el-button>
              </template>
            </el-table-column>
          </el-table>

          <div class="pagination-container">
            <el-pagination
              v-model:current-page="currentPageNum"
              v-model:page-size="pageSize"
              :page-sizes="[10, 20, 50, 100]"
              :total="displayList.length"
              layout="total, sizes, prev, pager, next, jumper"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- è¯¦æƒ…é¡µ -->
    <div v-if="currentPage === 'detail'" class="detail-page">
      <el-button @click="currentPage = 'list'" style="margin-bottom: 20px">
        â† è¿”å›åˆ—è¡¨
      </el-button>

      <h1 class="page-title">è§†é¢‘è®¾å¤‡è¯¦æƒ…</h1>

      <div class="info-card">
        <div class="info-card-title">è®¾å¤‡çŠ¶æ€ä¿¡æ¯</div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">è§†é¢‘åç§°</div>
            <div class="info-value">{{ currentDevice.name }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">è§†é¢‘ç¼–ç </div>
            <div class="info-value">{{ currentDevice.deviceId }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">é€šé“ç¼–ç </div>
            <div class="info-value">{{ currentDevice.channelId }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">æ‰€å±åˆ†ç»„</div>
            <div class="info-value">{{ currentDevice.groupName }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">è®¾å¤‡çŠ¶æ€</div>
            <div class="info-value">
              <span :class="['status-tag', currentDevice.status === 'online' ? 'status-online' : 'status-offline']">
                {{ currentDevice.status === 'online' ? 'åœ¨çº¿ âœ“' : 'ç¦»çº¿' }}
              </span>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">è®¾å¤‡IP</div>
            <div class="info-value">{{ deviceStatus.ip }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">è®¾å¤‡ç«¯å£</div>
            <div class="info-value">{{ deviceStatus.port }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">é€šé“æ•°é‡</div>
            <div class="info-value">{{ deviceStatus.channelCount }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">ä¼ è¾“åè®®</div>
            <div class="info-value">{{ deviceStatus.transport }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">æ³¨å†Œæ—¶é—´</div>
            <div class="info-value">{{ formatDateTime(deviceStatus.registerTime) }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">æœ€åå¿ƒè·³</div>
            <div class="info-value">{{ formatDateTime(deviceStatus.keepaliveTime) }}</div>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <el-button type="primary" @click="refreshDeviceStatus">åˆ·æ–°çŠ¶æ€</el-button>
        </div>
      </div>

      <div class="info-card">
        <div class="info-card-title">å®æ—¶è§†é¢‘æ’­æ”¾</div>
        <div class="video-container">
          <div v-if="!isPlaying && !isLoading" class="video-placeholder">
            <div class="video-placeholder-icon">ğŸ“¹</div>
            <div class="video-placeholder-text">ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾å®æ—¶è§†é¢‘</div>
            <button class="play-button" @click="startPlay">â–¶ ç‚¹å‡»æ’­æ”¾</button>
          </div>

          <div v-if="isLoading" class="loading-overlay">
            <div>æ­£åœ¨åŠ è½½è§†é¢‘æµ...</div>
          </div>

          <video
            v-if="isPlaying && hlsUrl"
            ref="videoPlayer"
            class="video-player"
            controls
            autoplay
            muted
            @error="handleVideoError"
            @loadstart="isLoading = true"
            @canplay="isLoading = false"
          >
            <source :src="hlsUrl" type="application/x-mpegURL">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
          </video>

          <div v-if="playError" class="video-placeholder">
            <div class="video-placeholder-icon">âš ï¸</div>
            <div class="video-placeholder-text" style="color: #ff3b30;">{{ playError }}</div>
            <button class="play-button" @click="startPlay" style="margin-top: 10px;">é‡è¯•æ’­æ”¾</button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¯¹è¯æ¡† -->
    <el-dialog v-model="dialogVisible" :title="dialogTitle" width="600px">
      <el-form :model="form" label-width="100px">
        <el-form-item label="è§†é¢‘åç§°" required>
          <el-input v-model="form.name" placeholder="è¯·è¾“å…¥è§†é¢‘è®¾å¤‡åç§°" />
        </el-form-item>
        <el-form-item label="è§†é¢‘ç¼–ç " required>
          <el-input v-model="form.deviceId" placeholder="è¯·è¾“å…¥GB28181è®¾å¤‡ç¼–ç ï¼ˆ20ä½ï¼‰" maxlength="20" />
        </el-form-item>
        <el-form-item label="é€šé“ç¼–ç " required>
          <el-input v-model="form.channelId" placeholder="è¯·è¾“å…¥GB28181é€šé“ç¼–ç ï¼ˆ20ä½ï¼‰" maxlength="20" />
        </el-form-item>
        <el-form-item label="æ‰€å±åˆ†ç»„" required>
          <el-select v-model="form.groupName" placeholder="è¯·é€‰æ‹©åˆ†ç»„" style="width: 100%">
            <el-option label="åŠå…¬åŒº" value="åŠå…¬åŒº" />
            <el-option label="ç”Ÿäº§åŒº" value="ç”Ÿäº§åŒº" />
            <el-option label="ä»“åº“åŒº" value="ä»“åº“åŒº" />
          </el-select>
        </el-form-item>
        <el-form-item label="å¤‡æ³¨è¯´æ˜">
          <el-input v-model="form.remark" type="textarea" :rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨è¯´æ˜" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleSave">ç¡®å®š</el-button>
      </template>
    </el-dialog>
  </div>

  <script>
    const App = {
      data() {
        return {
          currentPage: 'list',
          loading: false,
          currentPageNum: 1,
          pageSize: 20,
          searchQuery: '',
          filterGroup: '',
          videoList: [
            { id: 1, name: 'åŠå…¬åŒºå…¥å£æ‘„åƒå¤´', deviceId: '340200000013202274845', channelId: '34020000001310000001', groupName: 'åŠå…¬åŒº' },
            { id: 2, name: 'ç”Ÿäº§è½¦é—´æ‘„åƒå¤´01', deviceId: '340200000013202274846', channelId: '34020000001310000002', groupName: 'ç”Ÿäº§åŒº' },
            { id: 3, name: 'ç”Ÿäº§è½¦é—´æ‘„åƒå¤´02', deviceId: '340200000013202274846', channelId: '34020000001310000003', groupName: 'ç”Ÿäº§åŒº' },
            { id: 4, name: 'ä»“åº“å…¥å£æ‘„åƒå¤´', deviceId: '340200000013202274847', channelId: '34020000001310000004', groupName: 'ä»“åº“åŒº' },
            { id: 5, name: 'åœè½¦åœºæ‘„åƒå¤´01', deviceId: '340200000013202274848', channelId: '34020000001310000005', groupName: 'åŠå…¬åŒº' },
            { id: 6, name: 'åœè½¦åœºæ‘„åƒå¤´02', deviceId: '340200000013202274848', channelId: '34020000001310000006', groupName: 'åŠå…¬åŒº' },
            { id: 7, name: 'ä¼šè®®å®¤æ‘„åƒå¤´', deviceId: '340200000013202274849', channelId: '34020000001310000007', groupName: 'åŠå…¬åŒº' },
            { id: 8, name: 'å®éªŒå®¤æ‘„åƒå¤´', deviceId: '340200000013202274850', channelId: '34020000001310000008', groupName: 'ç”Ÿäº§åŒº' }
          ],
          currentDevice: {},
          deviceStatus: {
            ip: '192.168.1.100',
            port: 5060,
            channelCount: 4,
            transport: 'UDP',
            registerTime: '2026-01-10T10:30:00.000Z',
            keepaliveTime: new Date().toISOString()
          },
          isPlaying: false,
          isLoading: false,
          hlsUrl: '',
          playError: '',
          dialogVisible: false,
          dialogTitle: 'æ·»åŠ è§†é¢‘è®¾å¤‡',
          form: {
            name: '',
            deviceId: '',
            channelId: '',
            groupName: '',
            remark: ''
          }
        };
      },
      computed: {
        displayList() {
          let list = [...this.videoList];
          
          if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            list = list.filter(item => 
              item.name.toLowerCase().includes(query) ||
              item.deviceId.includes(query) ||
              item.channelId.includes(query)
            );
          }
          
          if (this.filterGroup) {
            list = list.filter(item => item.groupName === this.filterGroup);
          }
          
          return list;
        }
      },
      methods: {
        handleSearch() {
          ElementPlus.ElMessage.success('æŸ¥è¯¢å®Œæˆ');
        },
        refreshList() {
          this.loading = true;
          setTimeout(() => {
            this.loading = false;
            ElementPlus.ElMessage.success('åˆ·æ–°æˆåŠŸ');
          }, 500);
        },
        viewDetail(row) {
          this.currentDevice = { ...row };
          this.currentPage = 'detail';
          this.isPlaying = false;
          this.hlsUrl = '';
          this.playError = '';
          this.refreshDeviceStatus();
        },
        refreshDeviceStatus() {
          ElementPlus.ElMessage.info('æ­£åœ¨æŸ¥è¯¢è®¾å¤‡çŠ¶æ€...');
          setTimeout(() => {
            this.deviceStatus = {
              ip: '192.168.1.' + Math.floor(Math.random() * 255),
              port: 5060,
              channelCount: Math.floor(Math.random() * 8) + 1,
              transport: Math.random() > 0.5 ? 'UDP' : 'TCP',
              registerTime: '2026-01-10T10:30:00.000Z',
              keepaliveTime: new Date().toISOString()
            };
            ElementPlus.ElMessage.success('è®¾å¤‡çŠ¶æ€å·²æ›´æ–°');
          }, 500);
        },
        formatDateTime(utcTimeString) {
          if (!utcTimeString) return '-';
          try {
            const date = new Date(utcTimeString);
            if (isNaN(date.getTime())) return utcTimeString;
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
          } catch (e) {
            return utcTimeString;
          }
        },
        startPlay() {
          this.isLoading = true;
          this.isPlaying = false;
          this.playError = '';
          setTimeout(() => {
            this.hlsUrl = 'https://lxs.fjqiaolong.com:8443/rtp/340200000013202274845_34020000001310000001/hls.m3u8';
            this.isPlaying = true;
            this.isLoading = false;
            ElementPlus.ElMessage.success('è§†é¢‘æµåŠ è½½æˆåŠŸ');
          }, 1500);
        },
        handleVideoError() {
          this.isLoading = false;
          this.playError = 'è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è®¾å¤‡çŠ¶æ€';
          ElementPlus.ElMessage.error('è§†é¢‘æ’­æ”¾å¤±è´¥');
        },
        openAddDialog() {
          this.dialogTitle = 'æ·»åŠ è§†é¢‘è®¾å¤‡';
          this.form = { name: '', deviceId: '', channelId: '', groupName: '', remark: '' };
          this.dialogVisible = true;
        },
        editDevice(row) {
          this.dialogTitle = 'ç¼–è¾‘è§†é¢‘è®¾å¤‡';
          this.form = { ...row, remark: '' };
          this.dialogVisible = true;
        },
        deleteDevice(row) {
          ElementPlus.ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤è§†é¢‘è®¾å¤‡"${row.name}"å—ï¼Ÿ`, 'ç¡®è®¤åˆ é™¤', {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }).then(() => {
            ElementPlus.ElMessage.success('åˆ é™¤æˆåŠŸ');
          }).catch(() => {
            ElementPlus.ElMessage.info('å·²å–æ¶ˆåˆ é™¤');
          });
        },
        handleSave() {
          if (!this.form.name || !this.form.deviceId || !this.form.channelId || !this.form.groupName) {
            ElementPlus.ElMessage.warning('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
          }
          ElementPlus.ElMessage.success(this.dialogTitle + 'æˆåŠŸ');
          this.dialogVisible = false;
        },
        openBatchImport() {
          ElementPlus.ElMessage.info('æ‰¹é‡å¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­...');
        }
      }
    };

    const app = Vue.createApp(App);
    app.use(ElementPlus);
    app.mount('#app');
  </script>
</body>
</html>
