<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡åˆ†ç»„ - ç‰©è”ç½‘å¹³å°</title>
    <link rel="stylesheet" href="common-style.css">
    <style>
        .content-wrapper { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
        .content-main { min-width: 0; }
        .content-sidebar { position: sticky; top: 76px; height: fit-content; }
        
        .group-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .tree-panel { background: white; border-radius: 12px; padding: 16px; border: 0.5px solid rgba(0,0,0,0.08); }
        .tree-item { padding: 8px 12px; margin: 2px 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; }
        .tree-item:hover { background: #f5f5f7; }
        .tree-item.active { background: #0071e3; color: white; }
        .tree-item.child { margin-left: 24px; }
        .device-panel { background: white; border-radius: 12px; padding: 20px; border: 0.5px solid rgba(0,0,0,0.08); }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 0.5px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 20px; font-weight: 600; color: #1d1d1f; }
        .modal-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            background: #f5f5f7;
            cursor: pointer;
            font-size: 18px;
            color: #86868b;
        }
        .modal-close:hover { background: #e5e5e7; color: #1d1d1f; }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 0.5px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f5f5f7;
        }
        .input-hint { font-size: 12px; color: #86868b; margin-top: 4px; }
        .required { color: #ff3b30; }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ç‰©è”ç½‘å¹³å°</div>
        <div class="user-info"><span>ğŸ‘¤ admin</span><a href="login.html">é€€å‡º</a></div>
    </div>

    <div class="container">
        <div class="sidebar">
            <a href="dashboard.html" class="menu-item"><span class="icon">ğŸ“Š</span> æ•°æ®ç›‘æ§</a>
            <a href="device-group.html" class="menu-item active"><span class="icon">ğŸ—‚ï¸</span> è®¾å¤‡åˆ†ç»„</a>
            <a href="device-list.html" class="menu-item"><span class="icon">ğŸ“±</span> è®¾å¤‡ç®¡ç†</a>
            <a href="product-manage.html" class="menu-item"><span class="icon">ğŸ“¦</span> äº§å“ç®¡ç†</a>
            <!-- <a href="data-query.html" class="menu-item"><span class="icon">ğŸ”</span> æ•°æ®æŸ¥è¯¢</a> -->
            <div class="menu-divider"></div>
            <a href="user-manage.html" class="menu-item"><span class="icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="role-manage.html" class="menu-item"><span class="icon">ğŸ­</span> è§’è‰²ç®¡ç†</a>
            <div class="menu-divider"></div>
            <a href="index.html" class="menu-item"><span class="icon">ğŸ </span> è¿”å›å¯¼èˆª</a>
        </div>

        <div class="main-content">
            <h1 class="page-title">è®¾å¤‡åˆ†ç»„</h1>

            <div class="content-wrapper">
                <div class="content-main">
                    <div class="group-container">
                <div class="tree-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong>åˆ†ç»„æ ‘</strong>
                        <button class="btn btn-primary" style="font-size: 12px; padding: 4px 12px;" onclick="openGroupModal()">+ æ–°å»º</button>
                    </div>
                    
                    <div id="groupTree">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                    <div class="device-panel">
                        <h3 style="margin-bottom: 16px;" id="groupTitle">ğŸ“ å…¨éƒ¨è®¾å¤‡</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>è®¾å¤‡åç§°</th>
                                    <th>è®¾å¤‡ç¼–ç </th>
                                    <th>äº§å“ç±»å‹</th>
                                    <th>æ‰€å±åˆ†ç»„</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="deviceList">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- å³ä¾§å¤‡æ³¨æ  -->
                <div class="content-sidebar">
                    <div class="prototype-note">
                        <strong>ğŸ“Œ é«˜ä¿çœŸåŸå‹è¯´æ˜</strong><br><br>
                        è®¾å¤‡åˆ†ç»„ç”¨äºç»„ç»‡å’Œç®¡ç†è®¾å¤‡çš„å±‚çº§ç»“æ„<br>
                        <br>
                        <strong>âœ… å·²å®ç°åŠŸèƒ½ï¼š</strong><br>
                        â€¢ åˆ›å»ºåˆ†ç»„ï¼šå¼¹çª—å½¢å¼åˆ›å»ºï¼Œæ”¯æŒçˆ¶å­çº§å…³ç³»<br>
                        â€¢ ç¼–è¾‘åˆ†ç»„ï¼šå³ä¾§æŒ‰é’®ç‚¹å‡»ç¼–è¾‘<br>
                        â€¢ åˆ é™¤åˆ†ç»„ï¼šåˆ é™¤æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å­åˆ†ç»„<br>
                        â€¢ æŸ¥çœ‹è®¾å¤‡ï¼šç‚¹å‡»åˆ†ç»„æŸ¥çœ‹è¯¥ç»„ä¸‹çš„è®¾å¤‡<br>
                        â€¢ æ•°æ®æŒä¹…åŒ–ï¼šä½¿ç”¨ localStorage å­˜å‚¨<br>
                        <br>
                        <strong>ğŸ’¡ æ“ä½œæç¤ºï¼š</strong><br>
                        â€¢ ç‚¹å‡»åˆ†ç»„åç§°æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨<br>
                        â€¢ æ”¯æŒæœ€å¤š5çº§åˆ†ç»„åµŒå¥—<br>
                        â€¢ å¯æŒ‰åœ°åŸŸã€ä¸šåŠ¡ã€æ¥¼å±‚ç­‰ç»´åº¦åˆ†ç»„<br>
                        â€¢ åŒä¸€çˆ¶åˆ†ç»„ä¸‹åç§°å¿…é¡»å”¯ä¸€ï¼Œä½†ä¸åŒçˆ¶åˆ†ç»„ä¸‹å¯ä»¥åŒå<br>
                        â€¢ åˆ é™¤çˆ¶åˆ†ç»„ä¼šåŒæ—¶åˆ é™¤æ‰€æœ‰å­åˆ†ç»„
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘åˆ†ç»„å¼¹çª— -->
    <div class="modal-overlay" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åˆ›å»ºåˆ†ç»„</div>
                <button class="modal-close" onclick="closeGroupModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>åˆ†ç»„åç§° <span class="required">*</span></label>
                    <input type="text" id="groupName" placeholder="å¦‚ï¼šåŠå…¬åŒºåŸŸã€ç”Ÿäº§è½¦é—´ã€Aæ ‹1æ¥¼">
                    <div class="input-hint">ğŸ’¡ åŒä¸€çˆ¶åˆ†ç»„ä¸‹åç§°å¿…é¡»å”¯ä¸€ï¼Œä½†ä¸åŒçˆ¶åˆ†ç»„ä¸‹å¯ä»¥æœ‰åŒåå­åˆ†ç»„ï¼ˆå¦‚â€œåŠå…¬åŒºåŸŸ/Aæ ‹1æ¥¼â€å’Œâ€œç”Ÿäº§åŒºåŸŸ/Aæ ‹1æ¥¼â€ï¼‰</div>
                </div>
                <div class="form-group">
                    <label>çˆ¶çº§åˆ†ç»„</label>
                    <select id="parentGroup">
                        <option value="0">æ— ï¼ˆé¡¶çº§åˆ†ç»„ï¼‰</option>
                    </select>
                    <div class="input-hint">ğŸ’¡ é€‰æ‹©çˆ¶çº§åˆ†ç»„å¯å»ºç«‹å±‚çº§å…³ç³»ï¼Œä¸é€‰åˆ™ä¸ºé¡¶çº§åˆ†ç»„</div>
                </div>
                <div class="form-group">
                    <label>åˆ†ç»„å›¾æ ‡</label>
                    <select id="groupIcon">
                        <option value="ğŸ“">ğŸ“ æ–‡ä»¶å¤¹</option>
                        <option value="ğŸ¢">ğŸ¢ åŠå…¬æ¥¼</option>
                        <option value="ğŸ­">ğŸ­ å·¥å‚</option>
                        <option value="ğŸ—ï¸">ğŸ—ï¸ æ¥¼å±‚</option>
                        <option value="âš™ï¸">âš™ï¸ è½¦é—´</option>
                        <option value="ğŸŒ">ğŸŒ åŒºåŸŸ</option>
                    </select>
                    <div class="input-hint">ğŸ’¡ é€‰æ‹©åˆé€‚çš„å›¾æ ‡è®©åˆ†ç»„æ ‘æ›´ç›´è§‚</div>
                </div>
                <div class="form-group">
                    <label>åˆ†ç»„æè¿°</label>
                    <textarea id="groupDesc" rows="3" placeholder="æè¿°è¯¥åˆ†ç»„çš„ç”¨é€”ã€èŒƒå›´ç­‰..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="closeGroupModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveGroup()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        let groups = [];
        let currentGroupId = 'all';
        let editingGroupId = null;

        window.onload = function() {
            loadGroups();
            renderGroupTree();
            renderDevices();
        };

        // åŠ è½½åˆ†ç»„æ•°æ®
        function loadGroups() {
            const data = localStorage.getItem('iot_groups');
            if (data) {
                groups = JSON.parse(data);
            } else {
                // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
                groups = [
                    { id: 1, name: 'åŠå…¬åŒºåŸŸ', parentId: 0, icon: 'ğŸ¢', desc: 'å…¬å¸åŠå…¬æ¥¼åŒºåŸŸ', deviceCount: 89 },
                    { id: 2, name: 'Aæ ‹1æ¥¼', parentId: 1, icon: 'ğŸ—ï¸', desc: '', deviceCount: 45 },
                    { id: 3, name: 'Aæ ‹2æ¥¼', parentId: 1, icon: 'ğŸ—ï¸', desc: '', deviceCount: 44 },
                    { id: 4, name: 'ç”Ÿäº§åŒºåŸŸ', parentId: 0, icon: 'ğŸ­', desc: 'ç”Ÿäº§è½¦é—´åŒºåŸŸ', deviceCount: 67 },
                    { id: 5, name: 'è½¦é—´1', parentId: 4, icon: 'âš™ï¸', desc: '', deviceCount: 32 },
                    { id: 6, name: 'è½¦é—´2', parentId: 4, icon: 'âš™ï¸', desc: '', deviceCount: 35 }
                ];
                saveGroups();
            }
        }

        // ä¿å­˜åˆ†ç»„æ•°æ®
        function saveGroups() {
            localStorage.setItem('iot_groups', JSON.stringify(groups));
        }

        // æ¸²æŸ“åˆ†ç»„æ ‘
        function renderGroupTree() {
            const container = document.getElementById('groupTree');
            const totalDevices = groups.reduce((sum, g) => sum + (g.deviceCount || 0), 0);
            
            let html = `
                <div class="tree-item ${currentGroupId === 'all' ? 'active' : ''}" onclick="selectGroup('all')">
                    <span>ğŸ“ å…¨éƒ¨è®¾å¤‡</span>
                    <span style="font-size: 12px; opacity: 0.7;">${totalDevices}</span>
                </div>
            `;
            
            // æ¸²æŸ“é¡¶çº§åˆ†ç»„
            const topGroups = groups.filter(g => g.parentId === 0);
            topGroups.forEach(group => {
                html += renderGroupItem(group, 0);
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“åˆ†ç»„é¡¹
        function renderGroupItem(group, level) {
            const childClass = level > 0 ? 'child' : '';
            const activeClass = currentGroupId === group.id ? 'active' : '';
            let html = `
                <div class="tree-item ${childClass} ${activeClass}" onclick="selectGroup(${group.id})">
                    <span>${group.icon} ${group.name}</span>
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <span style="font-size: 12px; opacity: 0.7;">${group.deviceCount || 0}</span>
                        <button class="btn btn-default" style="font-size: 11px; padding: 2px 6px;" onclick="event.stopPropagation(); editGroup(${group.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger" style="font-size: 11px; padding: 2px 6px;" onclick="event.stopPropagation(); deleteGroup(${group.id})">åˆ é™¤</button>
                    </div>
                </div>
            `;
            
            // é€’å½’æ¸²æŸ“å­åˆ†ç»„
            const children = groups.filter(g => g.parentId === group.id);
            children.forEach(child => {
                html += renderGroupItem(child, level + 1);
            });
            
            return html;
        }

        // é€‰æ‹©åˆ†ç»„
        function selectGroup(id) {
            currentGroupId = id;
            renderGroupTree();
            renderDevices();
        }

        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderDevices() {
            const titleEle = document.getElementById('groupTitle');
            const listEle = document.getElementById('deviceList');
            
            if (currentGroupId === 'all') {
                const totalDevices = groups.reduce((sum, g) => sum + (g.deviceCount || 0), 0);
                titleEle.textContent = `ğŸ“ å…¨éƒ¨è®¾å¤‡ (${totalDevices}å°)`;
            } else {
                const group = groups.find(g => g.id === currentGroupId);
                if (group) {
                    titleEle.textContent = `${group.icon} ${group.name} (${group.deviceCount || 0}å°)`;
                }
            }
            
            // ç¤ºä¾‹è®¾å¤‡æ•°æ®
            listEle.innerHTML = `
                <tr>
                    <td>æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨-01</td>
                    <td>TEM1111</td>
                    <td>æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨</td>
                    <td>Aæ ‹1æ¥¼</td>
                    <td><span class="badge badge-success">åœ¨çº¿</span></td>
                </tr>
                <tr>
                    <td>æ™ºèƒ½é—¨é”-ä¼šè®®å®¤</td>
                    <td>LOCK2001</td>
                    <td>æ™ºèƒ½é—¨é”</td>
                    <td>Aæ ‹1æ¥¼</td>
                    <td><span class="badge badge-success">åœ¨çº¿</span></td>
                </tr>
                <tr>
                    <td>æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨-02</td>
                    <td>TEM1112</td>
                    <td>æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨</td>
                    <td>Aæ ‹2æ¥¼</td>
                    <td><span class="badge badge-danger">ç¦»çº¿</span></td>
                </tr>
            `;
        }

        // æ‰“å¼€åˆ›å»ºåˆ†ç»„å¼¹çª—
        function openGroupModal() {
            editingGroupId = null;
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºåˆ†ç»„';
            document.getElementById('groupName').value = '';
            document.getElementById('groupIcon').value = 'ğŸ“';
            document.getElementById('groupDesc').value = '';
            
            // å¡«å……çˆ¶çº§åˆ†ç»„é€‰é¡¹
            const parentSelect = document.getElementById('parentGroup');
            parentSelect.innerHTML = '<option value="0">æ— ï¼ˆé¡¶çº§åˆ†ç»„ï¼‰</option>';
            groups.forEach(g => {
                parentSelect.innerHTML += `<option value="${g.id}">${g.icon} ${g.name}</option>`;
            });
            
            document.getElementById('groupModal').classList.add('show');
        }

        // å…³é—­å¼¹çª—
        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('show');
        }

        // ä¿å­˜åˆ†ç»„
        function saveGroup() {
            const name = document.getElementById('groupName').value.trim();
            const parentId = parseInt(document.getElementById('parentGroup').value);
            const icon = document.getElementById('groupIcon').value;
            const desc = document.getElementById('groupDesc').value.trim();
            
            if (!name) {
                alert('âŒ è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            
            if (editingGroupId) {
                // ç¼–è¾‘æ¨¡å¼
                const group = groups.find(g => g.id === editingGroupId);
                if (group) {
                    group.name = name;
                    group.icon = icon;
                    group.desc = desc;
                    // æ³¨æ„ï¼šç¼–è¾‘æ—¶ä¸å…è®¸ä¿®æ”¹çˆ¶çº§ï¼Œé¿å…å¾ªç¯å¼•ç”¨
                }
                alert('âœ… åˆ†ç»„ä¿®æ”¹æˆåŠŸ');
            } else {
                // åˆ›å»ºæ¨¡å¼
                const newGroup = {
                    id: groups.length > 0 ? Math.max(...groups.map(g => g.id)) + 1 : 1,
                    name,
                    parentId,
                    icon,
                    desc,
                    deviceCount: 0
                };
                groups.push(newGroup);
                alert('âœ… åˆ†ç»„åˆ›å»ºæˆåŠŸ');
            }
            
            saveGroups();
            closeGroupModal();
            renderGroupTree();
        }

        // ç¼–è¾‘åˆ†ç»„
        function editGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;
            
            editingGroupId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘åˆ†ç»„';
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupIcon').value = group.icon;
            document.getElementById('groupDesc').value = group.desc || '';
            document.getElementById('parentGroup').value = group.parentId;
            document.getElementById('parentGroup').disabled = true; // ç¼–è¾‘æ—¶ç¦æ­¢ä¿®æ”¹çˆ¶çº§
            
            document.getElementById('groupModal').classList.add('show');
        }

        // åˆ é™¤åˆ†ç»„
        function deleteGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å­åˆ†ç»„
            const hasChildren = groups.some(g => g.parentId === id);
            if (hasChildren) {
                if (!confirm(`åˆ†ç»„"${group.name}"ä¸‹è¿˜æœ‰å­åˆ†ç»„ï¼Œåˆ é™¤åæ‰€æœ‰å­åˆ†ç»„ä¹Ÿå°†è¢«åˆ é™¤ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) {
                    return;
                }
                // é€’å½’åˆ é™¤æ‰€æœ‰å­åˆ†ç»„
                deleteGroupRecursive(id);
            } else {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${group.name}"å—ï¼Ÿ`)) {
                    return;
                }
                groups = groups.filter(g => g.id !== id);
            }
            
            saveGroups();
            renderGroupTree();
            alert('âœ… åˆ†ç»„å·²åˆ é™¤');
        }

        // é€’å½’åˆ é™¤åˆ†ç»„
        function deleteGroupRecursive(id) {
            const children = groups.filter(g => g.parentId === id);
            children.forEach(child => deleteGroupRecursive(child.id));
            groups = groups.filter(g => g.id !== id);
        }
    </script>
</body>
</html>
