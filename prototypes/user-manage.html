<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - ç‰©è”ç½‘å¹³å°</title>
    <link rel="stylesheet" href="common-style.css">
    <style>
        .content-wrapper { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
        .content-main { min-width: 0; }
        .content-sidebar { position: sticky; top: 76px; height: fit-content; }
        
        /* ç”¨æˆ·ç®¡ç†å¸ƒå±€ */
        .user-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .tree-panel { background: white; border-radius: 12px; padding: 16px; border: 0.5px solid rgba(0,0,0,0.08); }
        .tree-item { padding: 8px 12px; margin: 2px 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; }
        .tree-item:hover { background: #f5f5f7; }
        .tree-item.active { background: #0071e3; color: white; }
        .tree-item.child { margin-left: 24px; }
        .user-panel { background: white; border-radius: 12px; padding: 20px; border: 0.5px solid rgba(0,0,0,0.08); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s; }
        .modal-header { padding: 20px 24px; border-bottom: 0.5px solid rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: 600; color: #1d1d1f; }
        .modal-close { width: 28px; height: 28px; border-radius: 50%; border: none; background: #f5f5f7; cursor: pointer; font-size: 18px; color: #86868b; }
        .modal-close:hover { background: #e5e5e7; color: #1d1d1f; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 0.5px solid rgba(0,0,0,0.08); display: flex; justify-content: flex-end; gap: 12px; background: #f5f5f7; }
        .input-hint { font-size: 12px; color: #86868b; margin-top: 4px; }
        .required { color: #ff3b30; }
        
        .role-select { background: #f5f5f7; padding: 12px; border-radius: 8px; max-height: 200px; overflow-y: auto; }
        .role-option { padding: 8px; margin: 4px 0; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .role-option:hover { background: white; }
        .role-option input { margin: 0; }
        
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ç‰©è”ç½‘å¹³å°</div>
        <div class="user-info"><span>ğŸ‘¤ admin</span><a href="login.html">é€€å‡º</a></div>
    </div>

    <div class="container">
        <div class="sidebar">
            <a href="dashboard.html" class="menu-item"><span class="icon">ğŸ“Š</span> æ•°æ®ç›‘æ§</a>
            <a href="device-group.html" class="menu-item"><span class="icon">ğŸ—‚ï¸</span> è®¾å¤‡åˆ†ç»„</a>
            <a href="device-list.html" class="menu-item"><span class="icon">ğŸ“±</span> è®¾å¤‡ç®¡ç†</a>
            <a href="product-manage.html" class="menu-item"><span class="icon">ğŸ“¦</span> äº§å“ç®¡ç†</a>
            <!-- <a href="data-query.html" class="menu-item"><span class="icon">ğŸ”</span> æ•°æ®æŸ¥è¯¢</a> -->
            <div class="menu-divider"></div>
            <a href="user-manage.html" class="menu-item active"><span class="icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="role-manage.html" class="menu-item"><span class="icon">ğŸ­</span> è§’è‰²ç®¡ç†</a>
            <div class="menu-divider"></div>
            <a href="index.html" class="menu-item"><span class="icon">ğŸ </span> è¿”å›å¯¼èˆª</a>
        </div>

        <div class="main-content">
            <h1 class="page-title">ç”¨æˆ·ç®¡ç†</h1>

            <div class="content-wrapper">
                <div class="content-main">
                    <div class="user-container">
                        <!-- å·¦ä¾§åˆ†ç»„æ ‘ -->
                        <div class="tree-panel">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong>è®¾å¤‡åˆ†ç»„</strong>
                            </div>
                            
                            <div id="groupTree">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            
                            <div class="prototype-note" style="margin-top: 16px; font-size: 12px;">
                                ğŸ’¡ ç‚¹å‡»åˆ†ç»„æŸ¥çœ‹è¯¥åˆ†ç»„ä¸‹çš„ç”¨æˆ·
                            </div>
                        </div>

                        <!-- å³ä¾§ç”¨æˆ·åˆ—è¡¨ -->
                        <div class="user-panel">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 id="groupTitle" style="margin: 0;">ğŸ“ å…¨éƒ¨ç”¨æˆ·</h3>
                                <div style="display: flex; gap: 12px;">
                                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç”¨æˆ·åæˆ–å§“å..." onkeyup="searchUsers()" style="padding: 6px 12px; border: 0.5px solid rgba(0,0,0,0.2); border-radius: 8px; width: 200px;">
                                    <button class="btn btn-primary" onclick="openUserModal()">+ åˆ›å»ºç”¨æˆ·</button>
                                </div>
                            </div>

                            <table id="userTable">
                                <thead>
                                    <tr>
                                        <th>ç”¨æˆ·ID</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>å§“å</th>
                                        <th>æ‰€å±åˆ†ç»„</th>
                                        <th>è§’è‰²</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="userList">
                                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="content-sidebar">
                    <div class="prototype-note">
                        <strong>ğŸ“Œ é«˜ä¿çœŸåŸå‹è¯´æ˜</strong><br><br>
                        ç”¨æˆ·ç®¡ç†é‡‡ç”¨åˆ†ç»„æ ‘+ç”¨æˆ·åˆ—è¡¨çš„å¸ƒå±€<br>
                        <br>
                        <strong>âœ… å·²å®ç°åŠŸèƒ½ï¼š</strong><br>
                        â€¢ åˆ†ç»„æ ‘ï¼šæ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡åˆ†ç»„<br>
                        â€¢ ç‚¹å‡»åˆ†ç»„ï¼šæŸ¥çœ‹è¯¥åˆ†ç»„ä¸‹çš„ç”¨æˆ·<br>
                        â€¢ åˆ›å»ºç”¨æˆ·ï¼šåœ¨æŒ‡å®šåˆ†ç»„ä¸‹åˆ›å»º<br>
                        â€¢ æ•°æ®æƒé™ï¼šç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€å±åˆ†ç»„åŠå­åˆ†ç»„çš„è®¾å¤‡<br>
                        â€¢ æœç´¢ç”¨æˆ·ï¼šæŒ‰ç”¨æˆ·åæˆ–å§“åæœç´¢<br>
                        â€¢ ç¼–è¾‘ç”¨æˆ·ï¼šä¿®æ”¹ä¿¡æ¯å’Œè§’è‰²<br>
                        â€¢ å¯ç”¨/ç¦ç”¨ï¼šæ§åˆ¶ç™»å½•æƒé™<br>
                        â€¢ åˆ é™¤ç”¨æˆ·ï¼šç§»é™¤è´¦æˆ·<br>
                        <br>
                        <strong>ğŸ’¡ æ•°æ®æƒé™è¯´æ˜ï¼š</strong><br>
                        â€¢ è¶…ç®¡ï¼šå¯ä»¥çœ‹åˆ°æ‰€æœ‰åˆ†ç»„çš„è®¾å¤‡<br>
                        â€¢ æ™®é€šç”¨æˆ·ï¼šåªèƒ½çœ‹åˆ°æ‰€å±åˆ†ç»„åŠå…¶å­åˆ†ç»„çš„è®¾å¤‡<br>
                        â€¢ ä¾‹å¦‚ï¼šå±äºâ€œåŠå…¬åŒºåŸŸâ€çš„ç”¨æˆ·å¯ä»¥çœ‹åˆ°â€œAæ ‹1æ¥¼â€ã€â€œAæ ‹2æ¥¼â€çš„è®¾å¤‡<br>
                        â€¢ å±äºâ€œAæ ‹1æ¥¼â€çš„ç”¨æˆ·åªèƒ½çœ‹åˆ°è¯¥æ¥¼å±‚çš„è®¾å¤‡<br>
                        <br>
                        <strong>ğŸ”’ è¶…çº§ç®¡ç†å‘˜æƒé™ï¼š</strong><br>
                        â€¢ <span style="color: #ff3b30;">åªæœ‰è¶…çº§ç®¡ç†å‘˜è§’è‰²æ‰èƒ½åˆ›å»º/ç¼–è¾‘/ç¦ç”¨ç”¨æˆ·</span><br>
                        â€¢ å…¶ä»–è§’è‰²æ— æ³•çœ‹åˆ°â€œåˆ›å»ºç”¨æˆ·â€æŒ‰é’®å’Œæ“ä½œåˆ—<br>
                        â€¢ è¶…çº§ç®¡ç†å‘˜ç”¨æˆ·è‡ªåŠ¨å½’å±æœ€é¡¶çº§åˆ†ç»„<br>
                        â€¢ åˆ›å»ºç”¨æˆ·æ—¶ï¼Œè‹¥é€‰æ‹©è¶…çº§ç®¡ç†å‘˜è§’è‰²ï¼Œåˆ†ç»„è‡ªåŠ¨è®¾ä¸ºæ ¹åˆ†ç»„<br>
                        <br>
                        <strong>ğŸ” æƒé™æ§åˆ¶ï¼š</strong><br>
                        â€¢ ç”¨æˆ· = æ‰€å±åˆ†ç»„ + è§’è‰²<br>
                        â€¢ åˆ†ç»„å†³å®šèƒ½çœ‹åˆ°å“ªäº›è®¾å¤‡ï¼ˆæ•°æ®æƒé™ï¼‰<br>
                        â€¢ è§’è‰²å†³å®šèƒ½è¿›è¡Œå“ªäº›æ“ä½œï¼ˆåŠŸèƒ½æƒé™ï¼‰
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘ç”¨æˆ·å¼¹çª— -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åˆ›å»ºç”¨æˆ·</div>
                <button class="modal-close" onclick="closeUserModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç”¨æˆ·å <span class="required">*</span></label>
                    <input type="text" id="username" placeholder="å¦‚ï¼šzhangsanã€lisi">
                    <div class="input-hint">ğŸ’¡ ç”¨äºç™»å½•çš„è´¦å·ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡ï¼Œåˆ›å»ºåä¸å¯ä¿®æ”¹</div>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label>å¯†ç  <span class="required">*</span></label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <div class="input-hint">ğŸ’¡ å¯†ç å°†é‡‡ç”¨ BCrypt åŠ å¯†å­˜å‚¨ï¼Œå»ºè®® 6 ä½ä»¥ä¸Š</div>
                </div>
                <div class="form-group">
                    <label>å§“å <span class="required">*</span></label>
                    <input type="text" id="realname" placeholder="å¦‚ï¼šå¼ ä¸‰ã€æå››">
                    <div class="input-hint">ğŸ’¡ ç”¨æˆ·çš„çœŸå®å§“åï¼Œç”¨äºæ˜¾ç¤ºå’Œè¯†åˆ«</div>
                </div>
                <div class="form-group">
                    <label>æ‰€å±åˆ†ç»„ <span class="required">*</span></label>
                    <select id="userGroup">
                        <option value="">è¯·é€‰æ‹©æ‰€å±åˆ†ç»„</option>
                    </select>
                    <div class="input-hint" id="groupHint">ğŸ’¡ å†³å®šç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›è®¾å¤‡æ•°æ®ï¼Œç”¨æˆ·å¯æŸ¥çœ‹æ‰€å±åˆ†ç»„åŠå…¶å­åˆ†ç»„çš„è®¾å¤‡</div>
                </div>
                <div class="form-group">
                    <label>è§’è‰² <span class="required">*</span></label>
                    <div class="role-select" id="roleSelect">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="input-hint">ğŸ’¡ é€‰æ‹©ç”¨æˆ·çš„è§’è‰²ï¼Œè§’è‰²å†³å®šäº†ç”¨æˆ·çš„èœå•æƒé™</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="closeUserModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUser()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        let users = [];
        let groups = [];
        let currentGroupId = 'all';
        let editingUserId = null;
        const availableRoles = [
            { id: 1, name: 'è¶…çº§ç®¡ç†å‘˜', color: 'danger', isSuperAdmin: true },
            { id: 2, name: 'è®¾å¤‡ç®¡ç†å‘˜', color: 'info', isSuperAdmin: false },
            { id: 3, name: 'æ•°æ®æŸ¥çœ‹å‘˜', color: 'info', isSuperAdmin: false },
            { id: 4, name: 'è¿ç»´äººå‘˜', color: 'warning', isSuperAdmin: false }
        ];
        
        // å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆæ¨¡æ‹Ÿï¼‰
        let currentUser = { id: 1, username: 'admin', roleIds: [1] }; // é»˜è®¤è¶…çº§ç®¡ç†å‘˜

        window.onload = function() {
            loadGroups();
            loadUsers();
            renderGroupTree();
            renderUsers();
            checkUserPermission();
        };
        
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç”¨æˆ·ç®¡ç†æƒé™
        function checkUserPermission() {
            const isSuperAdmin = currentUser.roleIds.some(roleId => {
                const role = availableRoles.find(r => r.id === roleId);
                return role && role.isSuperAdmin;
            });
            
            // éè¶…çº§ç®¡ç†å‘˜éšè—åˆ›å»ºæŒ‰é’®å’Œæ“ä½œåˆ—
            if (!isSuperAdmin) {
                const createBtn = document.querySelector('.btn-primary');
                if (createBtn && createBtn.textContent.includes('åˆ›å»ºç”¨æˆ·')) {
                    createBtn.style.display = 'none';
                }
                
                // éšè—æ“ä½œåˆ—æ ‡é¢˜
                const headers = document.querySelectorAll('#userTable th');
                headers.forEach(th => {
                    if (th.textContent === 'æ“ä½œ') {
                        th.style.display = 'none';
                    }
                });
            }
        }

        // åŠ è½½åˆ†ç»„æ•°æ®
        function loadGroups() {
            const data = localStorage.getItem('iot_groups');
            if (data) {
                groups = JSON.parse(data);
            } else {
                groups = [
                    { id: 1, name: 'åŠå…¬åŒºåŸŸ', parentId: 0, icon: 'ğŸ¢' },
                    { id: 2, name: 'Aæ ‹1æ¥¼', parentId: 1, icon: 'ğŸ—ï¸' },
                    { id: 3, name: 'Aæ ‹2æ¥¼', parentId: 1, icon: 'ğŸ—ï¸' },
                    { id: 4, name: 'ç”Ÿäº§åŒºåŸŸ', parentId: 0, icon: 'ğŸ­' },
                    { id: 5, name: 'è½¦é—´1', parentId: 4, icon: 'âš™ï¸' },
                    { id: 6, name: 'è½¦é—´2', parentId: 4, icon: 'âš™ï¸' }
                ];
            }
        }

        // æ¸²æŸ“åˆ†ç»„æ ‘
        function renderGroupTree() {
            const container = document.getElementById('groupTree');
            const totalUsers = users.length;
            
            let html = `
                <div class="tree-item ${currentGroupId === 'all' ? 'active' : ''}" onclick="selectGroup('all')">
                    <span>ğŸ“ å…¨éƒ¨ç”¨æˆ·</span>
                    <span style="font-size: 12px; opacity: 0.7;">${totalUsers}</span>
                </div>
            `;
            
            const topGroups = groups.filter(g => g.parentId === 0);
            topGroups.forEach(group => {
                html += renderGroupItem(group, 0);
            });
            
            container.innerHTML = html;
        }

        function renderGroupItem(group, level) {
            const childClass = level > 0 ? 'child' : '';
            const activeClass = currentGroupId === group.id ? 'active' : '';
            const userCount = users.filter(u => u.groupId === group.id).length;
            
            let html = `
                <div class="tree-item ${childClass} ${activeClass}" onclick="selectGroup(${group.id})">
                    <span>${group.icon} ${group.name}</span>
                    <span style="font-size: 12px; opacity: 0.7;">${userCount}</span>
                </div>
            `;
            
            const children = groups.filter(g => g.parentId === group.id);
            children.forEach(child => {
                html += renderGroupItem(child, level + 1);
            });
            
            return html;
        }

        // é€‰æ‹©åˆ†ç»„
        function selectGroup(id) {
            currentGroupId = id;
            renderGroupTree();
            renderUsers();
        }

        function loadUsers() {
            const data = localStorage.getItem('iot_users');
            if (data) {
                users = JSON.parse(data);
            } else {
                users = [
                    { id: 1, username: 'admin', realname: 'è¶…çº§ç®¡ç†å‘˜', groupId: 0, roleIds: [1], status: 'active', createTime: '2025-01-01 00:00', isSuper: true },
                    { id: 2, username: 'zhangsan', realname: 'å¼ ä¸‰', groupId: 1, roleIds: [2], status: 'active', createTime: '2025-12-20 10:30' },
                    { id: 3, username: 'lisi', realname: 'æå››', groupId: 2, roleIds: [3], status: 'disabled', createTime: '2025-12-22 14:20' },
                    { id: 4, username: 'wangwu', realname: 'ç‹äº”', groupId: 4, roleIds: [2], status: 'active', createTime: '2025-12-23 09:15' }
                ];
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('iot_users', JSON.stringify(users));
        }

        function renderUsers(filteredUsers = null) {
            let list = filteredUsers || users;
            
            // æŒ‰é€‰ä¸­çš„åˆ†ç»„ç­›é€‰
            if (currentGroupId !== 'all') {
                // è·å–å½“å‰åˆ†ç»„åŠå…¶æ‰€æœ‰å­åˆ†ç»„çš„ID
                const groupIds = getGroupWithChildren(currentGroupId);
                list = list.filter(u => groupIds.includes(u.groupId));
            }
            
            const tbody = document.getElementById('userList');
            const titleEle = document.getElementById('groupTitle');
            
            // æ›´æ–°æ ‡é¢˜
            if (currentGroupId === 'all') {
                titleEle.textContent = `ğŸ“ å…¨éƒ¨ç”¨æˆ· (${list.length}äºº)`;
            } else {
                const group = groups.find(g => g.id === currentGroupId);
                if (group) {
                    titleEle.textContent = `${group.icon} ${group.name} (${list.length}äºº)`;
                }
            }
            
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 60px; color: #86868b;">ğŸ‘¥ è¯¥åˆ†ç»„æš‚æ— ç”¨æˆ·</td></tr>';
                return;
            }
            
            tbody.innerHTML = list.map(u => {
                const roles = u.roleIds.map(rid => availableRoles.find(r => r.id === rid)).filter(r => r);
                const roleHtml = roles.map(r => `<span class="badge badge-${r.color}">${r.name}</span>`).join(' ');
                const statusHtml = u.status === 'active' ? '<span class="badge badge-success">å¯ç”¨</span>' : '<span class="badge badge-warning">ç¦ç”¨</span>';
                
                // è·å–åˆ†ç»„åç§°
                let groupName = 'å…¨éƒ¨';
                if (u.groupId) {
                    const group = groups.find(g => g.id === u.groupId);
                    if (group) groupName = group.name;
                }
                
                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
                const isSuperAdmin = currentUser.roleIds.some(roleId => {
                    const role = availableRoles.find(r => r.id === roleId);
                    return role && role.isSuperAdmin;
                });
                
                let actions = '';
                if (!isSuperAdmin) {
                    // éè¶…çº§ç®¡ç†å‘˜ä¸æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                    actions = '<td style="display:none;"></td>';
                } else if (u.isSuper) {
                    actions = '<td><button class="btn btn-default" disabled style="opacity: 0.5; font-size: 12px; padding: 4px 8px;">ä¸å¯æ“ä½œ</button></td>';
                } else {
                    actions = `<td>
                        <button class="btn btn-default" onclick="editUser(${u.id})" style="font-size: 12px; padding: 4px 8px;">ç¼–è¾‘</button>
                        ${u.status === 'active' ? 
                            `<button class="btn btn-warning" onclick="toggleUserStatus(${u.id})" style="font-size: 12px; padding: 4px 8px;">ç¦ç”¨</button>` :
                            `<button class="btn btn-success" onclick="toggleUserStatus(${u.id})" style="font-size: 12px; padding: 4px 8px;">å¯ç”¨</button>`
                        }
                        <button class="btn btn-danger" onclick="deleteUser(${u.id})" style="font-size: 12px; padding: 4px 8px;">åˆ é™¤</button>
                    </td>`;
                }
                
                return `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.realname}</td>
                        <td>${groupName}</td>
                        <td>${roleHtml}</td>
                        <td>${statusHtml}</td>
                        ${actions}
                    </tr>
                `;
            }).join('');
        }

        // è·å–åˆ†ç»„åŠå…¶æ‰€æœ‰å­åˆ†ç»„çš„ID
        function getGroupWithChildren(groupId) {
            let result = [groupId];
            const children = groups.filter(g => g.parentId === groupId);
            children.forEach(child => {
                result = result.concat(getGroupWithChildren(child.id));
            });
            return result;
        }

        function searchUsers() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            if (!keyword) {
                renderUsers();
                return;
            }
            const filtered = users.filter(u => 
                u.username.toLowerCase().includes(keyword) || 
                u.realname.toLowerCase().includes(keyword)
            );
            renderUsers(filtered);
        }

        function openUserModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºç”¨æˆ·';
            document.getElementById('username').value = '';
            document.getElementById('username').disabled = false;
            document.getElementById('password').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('realname').value = '';
            
            // å¡«å……åˆ†ç»„ä¸‹æ‹‰é€‰é¡¹
            const groupSelect = document.getElementById('userGroup');
            groupSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‰€å±åˆ†ç»„</option>' +
                groups.map(g => `<option value="${g.id}">${g.icon} ${g.name}</option>`).join('');
            
            // å¦‚æœå½“å‰é€‰ä¸­äº†æŸä¸ªåˆ†ç»„ï¼Œé»˜è®¤é€‰ä¸­
            if (currentGroupId !== 'all') {
                groupSelect.value = currentGroupId;
            }
            
            // æ¸²æŸ“è§’è‰²é€‰æ‹©
            const roleSelect = document.getElementById('roleSelect');
            roleSelect.innerHTML = availableRoles.map(role => `
                <label class="role-option">
                    <input type="checkbox" value="${role.id}" class="role-checkbox" onchange="handleRoleChange()">
                    <span class="badge badge-${role.color}">${role.name}</span>
                </label>
            `).join('');
            
            document.getElementById('userModal').classList.add('show');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }

        function saveUser() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const realname = document.getElementById('realname').value.trim();
            const groupId = parseInt(document.getElementById('userGroup').value);
            const selectedRoles = Array.from(document.querySelectorAll('.role-checkbox:checked')).map(cb => parseInt(cb.value));
            
            if (!username) { alert('âŒ è¯·è¾“å…¥ç”¨æˆ·å'); return; }
            if (!editingUserId && !password) { alert('âŒ è¯·è¾“å…¥å¯†ç '); return; }
            if (!realname) { alert('âŒ è¯·è¾“å…¥å§“å'); return; }
            if (!groupId) { alert('âŒ è¯·é€‰æ‹©æ‰€å±åˆ†ç»„'); return; }
            if (selectedRoles.length === 0) { alert('âŒ è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªè§’è‰²'); return; }
            
            if (editingUserId) {
                const user = users.find(u => u.id === editingUserId);
                if (user) {
                    user.realname = realname;
                    user.groupId = groupId;
                    user.roleIds = selectedRoles;
                    if (password) user.password = password;
                }
                alert('âœ… ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°');
            } else {
                if (users.some(u => u.username === username)) {
                    alert('âŒ ç”¨æˆ·åå·²å­˜åœ¨');
                    return;
                }
                const newUser = {
                    id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                    username,
                    password,
                    realname,
                    groupId,
                    roleIds: selectedRoles,
                    status: 'active',
                    createTime: new Date().toLocaleString('zh-CN', { hour12: false })
                };
                users.push(newUser);
                alert('âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
            }
            
            saveUsers();
            closeUserModal();
            renderGroupTree();
            renderUsers();
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            editingUserId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('username').value = user.username;
            document.getElementById('username').disabled = true;
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('realname').value = user.realname;
            
            // å¡«å……åˆ†ç»„
            const groupSelect = document.getElementById('userGroup');
            groupSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‰€å±åˆ†ç»„</option>' +
                groups.map(g => `<option value="${g.id}">${g.icon} ${g.name}</option>`).join('');
            groupSelect.value = user.groupId;
            
            // æ¸²æŸ“è§’è‰²å¹¶é€‰ä¸­
            const roleSelect = document.getElementById('roleSelect');
            roleSelect.innerHTML = availableRoles.map(role => `
                <label class="role-option">
                    <input type="checkbox" value="${role.id}" class="role-checkbox" ${user.roleIds.includes(role.id) ? 'checked' : ''} onchange="handleRoleChange()">
                    <span class="badge badge-${role.color}">${role.name}</span>
                </label>
            `).join('');
            
            // å¦‚æœå·²ç»æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œè§¦å‘ä¸€æ¬¡è§’è‰²å˜åŒ–å¤„ç†
            if (user.roleIds.some(rid => availableRoles.find(r => r.id === rid)?.isSuperAdmin)) {
                handleRoleChange();
            }
            
            document.getElementById('userModal').classList.add('show');
        }

        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            user.status = user.status === 'active' ? 'disabled' : 'active';
            saveUsers();
            renderUsers();
            alert(`âœ… å·²${user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}ç”¨æˆ·`);
        }

        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ·"${user.realname}"å—ï¼Ÿ`)) return;
            
            users = users.filter(u => u.id !== id);
            saveUsers();
            renderGroupTree();
            renderUsers();
            alert('âœ… ç”¨æˆ·å·²åˆ é™¤');
        }
        
        // è§’è‰²é€‰æ‹©å˜åŒ–æ—¶çš„å¤„ç†
        function handleRoleChange() {
            const checkboxes = document.querySelectorAll('.role-checkbox');
            const selectedRoleIds = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è¶…çº§ç®¡ç†å‘˜è§’è‰²
            const hasSuperAdmin = selectedRoleIds.some(roleId => {
                const role = availableRoles.find(r => r.id === roleId);
                return role && role.isSuperAdmin;
            });
            
            const groupSelect = document.getElementById('userGroup');
            const groupHint = document.getElementById('groupHint');
            
            if (hasSuperAdmin) {
                // æ‰¾åˆ°æœ€é¡¶çº§çš„åˆ†ç»„ï¼ˆparentIdä¸º0çš„åˆ†ç»„ï¼‰
                const rootGroup = groups.find(g => g.parentId === 0);
                if (rootGroup) {
                    groupSelect.value = rootGroup.id;
                    groupSelect.disabled = true;
                    groupHint.innerHTML = 'ğŸ”’ è¶…çº§ç®¡ç†å‘˜è‡ªåŠ¨å½’å±æœ€é¡¶çº§åˆ†ç»„ï¼Œæ‹¥æœ‰å…¨å±€æ•°æ®æƒé™';
                    groupHint.style.color = '#0071e3';
                    groupHint.style.fontWeight = '500';
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ¹åˆ†ç»„ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªåˆ†ç»„
                    if (groups.length > 0) {
                        groupSelect.value = groups[0].id;
                        groupSelect.disabled = true;
                        groupHint.innerHTML = 'ğŸ”’ è¶…çº§ç®¡ç†å‘˜è‡ªåŠ¨å½’å±é¡¶çº§åˆ†ç»„ï¼Œæ‹¥æœ‰å…¨å±€æ•°æ®æƒé™';
                        groupHint.style.color = '#0071e3';
                        groupHint.style.fontWeight = '500';
                    }
                }
            } else {
                groupSelect.disabled = false;
                groupHint.innerHTML = 'ğŸ’¡ å†³å®šç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›è®¾å¤‡æ•°æ®ï¼Œç”¨æˆ·å¯æŸ¥çœ‹æ‰€å±åˆ†ç»„åŠå…¶å­åˆ†ç»„çš„è®¾å¤‡';
                groupHint.style.color = '#86868b';
                groupHint.style.fontWeight = 'normal';
            }
        }
    </script>
</body>
</html>
