# MQTT通信协议说明文档

本文档详细说明了IoT物联网设备管理平台的MQTT通信协议，包括设备上报数据和平台下发命令的格式规范。**所有设备厂商必须严格按照此格式进行数据上报和命令接收**。

---

## 目录

1. [MQTT连接配置](#mqtt连接配置)
2. [设备上报数据格式](#设备上报数据格式)
3. [平台下发命令格式](#平台下发命令格式)
4. [MQTT主题规范](#mqtt主题规范)
5. [数据示例](#数据示例)
6. [注意事项](#注意事项)

---

## MQTT连接配置

### 连接参数

- **协议**: MQTT 3.1.1
- **Broker地址**: 由平台管理员配置（默认：`tcp://localhost:1883`）
- **用户名/密码**: 由平台管理员配置
- **客户端ID**: 设备端需使用唯一ID（建议格式：`device_{deviceCode}_{随机字符串}`）
- **Keep Alive**: 60秒
- **Clean Session**: 建议使用 `true`
- **QoS等级**: 
  - 设备上报：**QoS=1**（至少一次送达）
  - 平台下发：**QoS=1**（至少一次送达）

### 连接步骤

1. 使用MQTT客户端连接到Broker
2. 使用用户名和密码进行认证
3. 订阅命令主题（见下方主题规范）
4. 开始上报数据

---

## 设备上报数据格式

### MQTT主题

```
ssc/{deviceCode}/report
```

**说明**：
- `{deviceCode}` 为设备的唯一编码（在平台中注册的设备编码）
- 平台会订阅 `ssc/+/report` 来接收所有设备的上报数据

### JSON消息格式

```json
{
  "did": "设备编码",
  "content": [
    {
      "addr": "属性标识符",
      "addrv": "属性值",
      "ctime": "采集时间",
      "pid": "设备编码"
    }
  ]
}
```

### 字段说明

#### 根对象字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `did` | String | ✅ | 设备ID（Device ID），必须与设备编码一致 |
| `content` | Array | ✅ | 上报内容数组，可包含多个属性数据 |

#### content数组元素字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `addr` | String | ✅ | 属性标识符，对应产品物模型中定义的属性地址（如：`tem`、`hum`、`voltage`等） |
| `addrv` | String | ✅ | 属性值，字符串格式（数值需转换为字符串，如：`"25.5"`、`"1"`） |
| `ctime` | String | ✅ | 采集时间，格式：`yyyy/MM/dd HH:mm:ss`（UTC时间）<br>示例：`"2024/01/15 14:30:25"` |
| `pid` | String | ✅ | 设备编码（Product ID），必须与`did`一致 |

### 上报规则

1. **上报频率**：建议每3-5分钟上报一次，或根据业务需求调整
2. **批量上报**：一次消息可以上报多个属性，将多个属性放在`content`数组中
3. **时间格式**：`ctime`字段必须严格按照 `yyyy/MM/dd HH:mm:ss` 格式
4. **数据类型**：所有数值类型的属性值必须以字符串形式传递（`addrv`字段为String类型）

---

## 平台下发命令格式

### MQTT主题

```
ssc/{deviceCode}/command
```

**说明**：
- `{deviceCode}` 为设备的唯一编码
- **设备必须订阅此主题才能接收平台下发的命令**
- 订阅格式：`ssc/{deviceCode}/command`（使用具体的设备编码）

### JSON消息格式

```json
{
  "did": "设备编码",
  "content": [
    {
      "addr": "属性标识符",
      "addrv": "控制值",
      "pid": "设备编码"
    }
  ],
  "utime": "平台发送时间"
}
```

### 字段说明

#### 根对象字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `did` | String | ✅ | 设备ID（Device ID），目标设备的编码 |
| `content` | Array | ✅ | 命令内容数组，可包含多个控制命令 |
| `utime` | String | ✅ | 平台发送时间，格式：`yyyy/MM/dd HH:mm:ss`<br>示例：`"2024/01/15 14:30:25"` |

#### content数组元素字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `addr` | String | ✅ | 属性标识符，对应产品物模型中定义的命令地址（如：`window`、`valve_status`等） |
| `addrv` | String | ✅ | 控制值，字符串格式（数值需转换为字符串，如：`"1"`、`"0"`） |
| `pid` | String | ✅ | 设备编码（Product ID），必须与`did`一致 |

### 命令处理规则

1. **订阅主题**：设备连接MQTT后，必须立即订阅 `ssc/{deviceCode}/command` 主题
2. **命令执行**：设备收到命令后，应立即执行相应的控制操作
3. **状态反馈**：建议设备执行命令后，通过上报主题上报最新的状态（可选）
4. **批量命令**：一次消息可能包含多个命令，设备需依次处理`content`数组中的所有命令

---

## MQTT主题规范

### 主题命名规则

所有MQTT主题遵循以下命名规范：

```
ssc/{deviceCode}/{messageType}
```

- `ssc`：固定前缀（System Service Center）
- `{deviceCode}`：设备编码（替换为实际设备编码）
- `{messageType}`：消息类型
  - `report`：设备上报数据
  - `command`：平台下发命令

### 主题列表

| 主题 | 方向 | 说明 | 订阅方式 |
|------|------|------|----------|
| `ssc/{deviceCode}/report` | 设备→平台 | 设备上报数据 | 平台订阅：`ssc/+/report` |
| `ssc/{deviceCode}/command` | 平台→设备 | 平台下发命令 | 设备订阅：`ssc/{deviceCode}/command` |

### 通配符说明

- `+`：单级通配符，匹配一个主题层级
  - `ssc/+/report` 可以匹配 `ssc/DEVICE001/report`、`ssc/DEVICE002/report` 等
- `#`：多级通配符，匹配多个主题层级（本协议中不使用）

---

## 数据示例

### 示例1：环境监测设备上报数据

```json
{
  "did": "888866666",
  "content": [
    {
      "addr": "tem",
      "addrv": "25.5",
      "ctime": "2024/01/15 14:30:25",
      "pid": "888866666"
    },
    {
      "addr": "hum",
      "addrv": "60.2",
      "ctime": "2024/01/15 14:30:25",
      "pid": "888866666"
    },
    {
      "addr": "window",
      "addrv": "0",
      "ctime": "2024/01/15 14:30:25",
      "pid": "888866666"
    }
  ]
}
```

**说明**：
- `tem`：温度（单位：℃）
- `hum`：湿度（单位：%）
- `window`：窗户状态（0=关闭，1=打开）

### 示例2：智能电表上报数据

```json
{
  "did": "DIANBIAO1",
  "content": [
    {
      "addr": "voltage",
      "addrv": "220.5",
      "ctime": "2024/01/15 14:30:25",
      "pid": "DIANBIAO1"
    },
    {
      "addr": "current",
      "addrv": "15.8",
      "ctime": "2024/01/15 14:30:25",
      "pid": "DIANBIAO1"
    },
    {
      "addr": "active_power",
      "addrv": "3.456",
      "ctime": "2024/01/15 14:30:25",
      "pid": "DIANBIAO1"
    },
    {
      "addr": "total_energy",
      "addrv": "1500.123",
      "ctime": "2024/01/15 14:30:25",
      "pid": "DIANBIAO1"
    }
  ]
}
```

**说明**：
- `voltage`：电压（单位：V）
- `current`：电流（单位：A）
- `active_power`：有功功率（单位：kW）
- `total_energy`：累计电量（单位：kWh）

### 示例3：平台下发控制命令（打开窗户）

```json
{
  "did": "888866666",
  "content": [
    {
      "addr": "window",
      "addrv": "1",
      "pid": "888866666"
    }
  ],
  "utime": "2024/01/15 14:35:10"
}
```

**说明**：
- 命令设备将`window`属性设置为`1`（打开窗户）
- 设备收到后应执行操作，并可通过上报主题反馈最新状态

### 示例4：平台下发批量命令（水表控制）

```json
{
  "did": "SHUIBIAO1",
  "content": [
    {
      "addr": "valve_status",
      "addrv": "0",
      "pid": "SHUIBIAO1"
    }
  ],
  "utime": "2024/01/15 14:40:20"
}
```

**说明**：
- 命令水表关闭阀门（`valve_status`设置为`0`）

---

## 注意事项

### ⚠️ 重要提醒

1. **设备编码一致性**
   - 上报数据中的`did`和`pid`必须一致
   - 下发命令中的`did`和`pid`必须一致
   - 设备编码必须与平台中注册的设备编码完全一致（区分大小写）

2. **时间格式**
   - 上报时间（`ctime`）和下发时间（`utime`）必须严格按照 `yyyy/MM/dd HH:mm:ss` 格式
   - 建议使用UTC时间，避免时区问题

3. **数据类型**
   - 所有数值类型的属性值必须以**字符串**形式传递（`addrv`字段）
   - 例如：温度`25.5`应传递为`"25.5"`，状态`1`应传递为`"1"`

4. **属性标识符**
   - `addr`字段必须与产品物模型中定义的属性地址完全一致
   - 平台会根据`addr`匹配对应的属性定义
   - 不存在的`addr`将被忽略或记录为错误

5. **MQTT连接**
   - 设备应保持MQTT长连接，避免频繁断开重连
   - 建议实现自动重连机制
   - 使用QoS=1确保消息至少送达一次

6. **错误处理**
   - 设备应验证收到的命令格式是否正确
   - 如果命令格式错误或无法执行，建议记录日志
   - 平台不会等待设备响应，命令下发为异步操作

7. **性能建议**
   - 避免过于频繁的上报（建议间隔≥3分钟）
   - 批量上报多个属性时，使用同一个`ctime`时间戳
   - 上报数据量较大时，考虑分批上报

### 📋 开发检查清单

设备厂商在开发时，请确保：

- [ ] MQTT连接配置正确（Broker地址、用户名、密码）
- [ ] 订阅了正确的命令主题：`ssc/{deviceCode}/command`
- [ ] 上报主题格式正确：`ssc/{deviceCode}/report`
- [ ] JSON格式符合规范（字段名、类型、必填项）
- [ ] 时间格式正确：`yyyy/MM/dd HH:mm:ss`
- [ ] 所有数值以字符串形式传递
- [ ] `did`和`pid`字段一致
- [ ] `addr`字段与物模型定义一致
- [ ] 实现了MQTT自动重连机制
- [ ] 使用QoS=1确保消息可靠性

---

## 技术支持

如有疑问或需要技术支持，请联系平台管理员。

**文档版本**: v1.0  
**最后更新**: 2024年1月
