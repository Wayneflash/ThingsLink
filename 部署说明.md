# ğŸš€ IoT ç‰©è”ç½‘å¹³å° - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“¦ é¡¹ç›®æ¦‚è§ˆ

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„è½»é‡çº§ç‰©è”ç½‘å¹³å°ï¼ŒæŠ€æœ¯æ ˆï¼š
- **åç«¯**: Spring Boot 2.7 + MyBatis-Plus + MQTT (Eclipse Paho)
- **å‰ç«¯**: Vue 3 + Element Plus + ECharts
- **æ¶ˆæ¯**: EMQX 5.3.0
- **æ•°æ®åº“**: MySQL 8.0 + Redis 7
- **éƒ¨ç½²**: Docker Compose

---

## ğŸ› ï¸ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡

**Linux æœåŠ¡å™¨è¦æ±‚:**
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04+ / CentOS 7+
- CPU: 2æ ¸å¿ƒ
- å†…å­˜: è‡³å°‘ 2GB (æ¨è 4GB)
- ç¡¬ç›˜: 20GB å¯ç”¨ç©ºé—´

**å®‰è£… Docker å’Œ Docker Compose:**

```bash
# å®‰è£… Docker
curl -fsSL https://get.docker.com | sh
sudo systemctl start docker
sudo systemctl enable docker

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### 2. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

```bash
# å°†æ•´ä¸ªé¡¹ç›®ä¸Šä¼ åˆ° Linux æœåŠ¡å™¨
scp -r ./Freetalk root@your-server-ip:/opt/

# æˆ–è€…ä½¿ç”¨ Git
cd /opt
git clone <your-repo-url> Freetalk
cd Freetalk
```

### 3. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
cd /opt/Freetalk

# å¯åŠ¨æ‰€æœ‰å®¹å™¨
docker-compose up -d

# æŸ¥çœ‹å¯åŠ¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨
docker ps

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹å®¹å™¨è¿è¡Œ:
# - iot-mysql (MySQL æ•°æ®åº“)
# - iot-redis (Redis ç¼“å­˜)
# - iot-emqx (MQTT Broker)
# - iot-backend (Spring Boot åç«¯)
# - iot-frontend (Nginx + Vue å‰ç«¯)
```

---

## ğŸŒ è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | è´¦å·å¯†ç  |
|------|------|---------|
| **å‰ç«¯ç•Œé¢** | http://your-ip | - |
| **åç«¯ API** | http://your-ip:8080 | - |
| **EMQX æ§åˆ¶å°** | http://your-ip:18083 | admin / public |
| **MQTT ç«¯å£** | tcp://your-ip:1883 | - |

---

## ğŸ“ ä½¿ç”¨æµç¨‹æ¼”ç¤º

### æ­¥éª¤ 1: åˆ›å»ºäº§å“

```bash
curl -X POST http://localhost:8080/product/create \
  -H "Content-Type: application/json" \
  -d '{
    "productName": "æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨",
    "productModel": "TEM",
    "protocol": "MQTT",
    "description": "ç”¨äºç›‘æµ‹ç¯å¢ƒæ¸©æ¹¿åº¦"
  }'
```

### æ­¥éª¤ 2: æ·»åŠ äº§å“å±æ€§

```bash
# æ·»åŠ æ¸©åº¦å±æ€§
curl -X POST http://localhost:8080/product/attribute/create \
  -H "Content-Type: application/json" \
  -d '{
    "productId": 1,
    "addr": "tem",
    "attrName": "æ¸©åº¦",
    "dataType": "float",
    "unit": "â„ƒ"
  }'

# æ·»åŠ æ¹¿åº¦å±æ€§
curl -X POST http://localhost:8080/product/attribute/create \
  -H "Content-Type: application/json" \
  -d '{
    "productId": 1,
    "addr": "hum",
    "attrName": "æ¹¿åº¦",
    "dataType": "float",
    "unit": "%"
  }'
```

### æ­¥éª¤ 3: åˆ›å»ºè®¾å¤‡

```bash
curl -X POST http://localhost:8080/device/create \
  -H "Content-Type: application/json" \
  -d '{
    "deviceCode": "TEM1111",
    "deviceName": "1å·æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨",
    "productId": 1,
    "location": "åŠå…¬å®¤AåŒº"
  }'
```

### æ­¥éª¤ 4: è¿è¡Œè®¾å¤‡æ¨¡æ‹Ÿå™¨

```bash
# å®‰è£… Python MQTT å®¢æˆ·ç«¯
pip3 install paho-mqtt

# è¿è¡Œæ¨¡æ‹Ÿå™¨
python3 device_simulator.py
```

**æ¨¡æ‹Ÿå™¨è¾“å‡ºç¤ºä¾‹:**
```
============================================================
     IoT è®¾å¤‡æ¨¡æ‹Ÿå™¨ - æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ (TEM1111)
============================================================
âœ… å·²è¿æ¥åˆ° MQTT Broker: localhost:1883
âœ… å·²è®¢é˜…å‘½ä»¤ä¸»é¢˜: ssc/TEM1111/command

ğŸ“¤ æ•°æ®ä¸ŠæŠ¥æˆåŠŸ:
   æ¸©åº¦: 25.34â„ƒ
   æ¹¿åº¦: 65.78%
   çª—æˆ·: å…³é—­
   æ—¶é—´: 2025/12/25 10:30:25
```

### æ­¥éª¤ 5: æŸ¥çœ‹æ•°æ®

```bash
# è·å–è®¾å¤‡æœ€æ–°æ•°æ®
curl http://localhost:8080/data/latest/TEM1111?limit=10
```

### æ­¥éª¤ 6: ä¸‹å‘å‘½ä»¤

```bash
# æ‰“å¼€çª—æˆ·
curl -X POST http://localhost:8080/command/send \
  -H "Content-Type: application/json" \
  -d '{
    "deviceCode": "TEM1111",
    "addr": "window",
    "addrv": "1"
  }'
```

---

## ğŸ¨ å‰ç«¯å¼€å‘æ¨¡å¼ (å¯é€‰)

å¦‚æœéœ€è¦ä¿®æ”¹å‰ç«¯ä»£ç å¹¶å®æ—¶é¢„è§ˆ:

```bash
cd frontend

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# è®¿é—® http://localhost:3000
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### 1. MySQL è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MySQL å®¹å™¨
docker logs iot-mysql

# æ‰‹åŠ¨è¿æ¥æµ‹è¯•
docker exec -it iot-mysql mysql -uroot -proot123456
```

### 2. EMQX è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ EMQX æ—¥å¿—
docker logs iot-emqx

# æŸ¥çœ‹ MQTT å®¢æˆ·ç«¯è¿æ¥
docker exec -it iot-emqx emqx_ctl clients list
```

### 3. åç«¯å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
docker logs -f iot-backend

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8080

# é‡å¯åç«¯æœåŠ¡
docker-compose restart backend
```

### 4. è®¾å¤‡æ¨¡æ‹Ÿå™¨è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ EMQX æ˜¯å¦å¯åŠ¨
docker ps | grep emqx

# æ£€æŸ¥é˜²ç«å¢™
sudo firewall-cmd --list-ports
sudo firewall-cmd --add-port=1883/tcp --permanent
sudo firewall-cmd --reload
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. é’ˆå¯¹ 1W è®¾å¤‡å¹¶å‘

#### MySQL ä¼˜åŒ–

```sql
-- å®šæœŸæ¸…ç†å†å²æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªæœˆï¼‰
DELETE FROM tb_device_data 
WHERE ctime < DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_device_ctime ON tb_device_data(device_id, ctime DESC);
```

#### Redis é…ç½®

```bash
# ä¿®æ”¹ docker-compose.yml ä¸­ Redis é…ç½®
redis:
  command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
```

#### JVM è°ƒä¼˜

```bash
# ä¿®æ”¹ docker-compose.yml ä¸­åç«¯ç¯å¢ƒå˜é‡
environment:
  JVM_OPTS: -Xms512m -Xmx1024m -XX:+UseG1GC
```

---

## ğŸ” å®‰å…¨åŠ å›º

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

```bash
# MySQL
docker exec -it iot-mysql mysql -uroot -proot123456
ALTER USER 'root'@'%' IDENTIFIED BY 'your_strong_password';

# EMQX (è®¿é—® http://your-ip:18083 ä¿®æ”¹)
```

### 2. å¯ç”¨ SSL/TLS (ç”Ÿäº§ç¯å¢ƒå¿…é¡»)

```bash
# ä¸º EMQX é…ç½® SSL è¯ä¹¦
# ä¿®æ”¹ docker-compose.yml æŒ‚è½½è¯ä¹¦æ–‡ä»¶
```

---

## ğŸ“ˆ ç›‘æ§å‘Šè­¦

### æŸ¥çœ‹ç³»ç»Ÿèµ„æºå ç”¨

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºå ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

---

## ğŸ¯ å¿«é€Ÿæµ‹è¯•è„šæœ¬

åˆ›å»º `test.sh` æ–‡ä»¶ï¼š

```bash
#!/bin/bash
echo "=== æµ‹è¯• IoT å¹³å° ==="

# 1. åˆ›å»ºäº§å“
echo "1. åˆ›å»ºäº§å“..."
curl -s -X POST http://localhost:8080/product/create \
  -H "Content-Type: application/json" \
  -d '{"productName":"æµ‹è¯•ä¼ æ„Ÿå™¨","productModel":"TEST001","protocol":"MQTT"}' | jq

# 2. åˆ›å»ºè®¾å¤‡
echo "2. åˆ›å»ºè®¾å¤‡..."
curl -s -X POST http://localhost:8080/device/create \
  -H "Content-Type: application/json" \
  -d '{"deviceCode":"TEST001","deviceName":"æµ‹è¯•è®¾å¤‡","productId":1}' | jq

# 3. æŸ¥è¯¢è®¾å¤‡åˆ—è¡¨
echo "3. æŸ¥è¯¢è®¾å¤‡åˆ—è¡¨..."
curl -s http://localhost:8080/device/list | jq

echo "=== æµ‹è¯•å®Œæˆ ==="
```

è¿è¡Œæµ‹è¯•:
```bash
chmod +x test.sh
./test.sh
```

---

## âœ… éƒ¨ç½²æˆåŠŸæ ‡å¿—

1. âœ… æ‰€æœ‰ 5 ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œ
2. âœ… å‰ç«¯é¡µé¢å¯ä»¥è®¿é—®
3. âœ… EMQX æ§åˆ¶å°å¯ä»¥ç™»å½•
4. âœ… è®¾å¤‡æ¨¡æ‹Ÿå™¨å¯ä»¥è¿æ¥å¹¶ä¸ŠæŠ¥æ•°æ®
5. âœ… æ•°æ®åº“ä¸­æœ‰æ•°æ®è®°å½•

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥:
1. Docker å®¹å™¨æ—¥å¿—: `docker-compose logs`
2. ç³»ç»Ÿèµ„æº: `docker stats`
3. ç½‘ç»œè¿æ¥: `telnet localhost 1883`

**æ­å–œï¼ç‰©è”ç½‘å¹³å°éƒ¨ç½²å®Œæˆï¼** ğŸ‰
