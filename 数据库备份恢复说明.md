# æ•°æ®åº“å¤‡ä»½å’Œæ¢å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜è¯´æ˜

**ä¸ºä»€ä¹ˆæ•°æ®ä¼šä¸¢å¤±ï¼Ÿ**

Dockerå®¹å™¨çš„æ•°æ®å­˜å‚¨åœ¨æ•°æ®å·ï¼ˆVolumeï¼‰ä¸­ã€‚å¦‚æœï¼š
- åˆ é™¤äº†å®¹å™¨å’Œæ•°æ®å·ï¼š`docker-compose down -v`
- é‡æ–°åˆ›å»ºå®¹å™¨ï¼šæ•°æ®å·è¢«é‡æ–°åˆ›å»ºï¼Œä¼šæ‰§è¡Œ `init.sql` åˆå§‹åŒ–

**è§£å†³æ–¹æ¡ˆï¼š**
1. âœ… ä½¿ç”¨æ•°æ®å·æŒä¹…åŒ–ï¼ˆå·²é…ç½®ï¼‰
2. âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“
3. âœ… éœ€è¦æ—¶æ¢å¤å¤‡ä»½

---

## ğŸ”§ æ•°æ®æŒä¹…åŒ–é…ç½®

### Docker Compose é…ç½®

`docker-compose.yml` ä¸­å·²é…ç½®æ•°æ®å·ï¼š
```yaml
volumes:
  - mysql-data:/var/lib/mysql  # æ•°æ®æŒä¹…åŒ–
```

**æ•°æ®å·ä½ç½®ï¼š**
- Windows: `\\wsl$\docker-desktop-data\data\docker\volumes\iot_mysql-data\_data`
- Linux: `/var/lib/docker/volumes/iot_mysql-data/_data`

### é‡è¦æç¤º

âš ï¸ **ä¸è¦ä½¿ç”¨ `docker-compose down -v`**ï¼ˆä¼šåˆ é™¤æ•°æ®å·ï¼‰
âœ… **ä½¿ç”¨ `docker-compose down`**ï¼ˆä¿ç•™æ•°æ®å·ï¼‰

---

## ğŸ’¾ å¤‡ä»½æ•°æ®åº“

### æ–¹æ³•1ï¼šä½¿ç”¨å¤‡ä»½è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åŒå‡»è¿è¡Œæˆ–åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ
backup-database.bat
```

**åŠŸèƒ½ï¼š**
- âœ… è‡ªåŠ¨æ£€æµ‹MySQLå®¹å™¨
- âœ… åˆ›å»ºå¤‡ä»½ç›®å½• `backups/`
- âœ… ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶
- âœ… åŒæ—¶ä¿å­˜ä¸º `iot_platform_latest.sql`ï¼ˆæœ€æ–°å¤‡ä»½ï¼‰

**å¤‡ä»½æ–‡ä»¶ä½ç½®ï¼š**
```
backups/
  â”œâ”€â”€ iot_platform_20260108_120000.sql  (å¸¦æ—¶é—´æˆ³)
  â””â”€â”€ iot_platform_latest.sql           (æœ€æ–°å¤‡ä»½)
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir backups

# æ‰§è¡Œå¤‡ä»½
docker exec iot-mysql mysqldump -uroot -proot123456 --single-transaction --routines --triggers iot_platform > backups\iot_platform_backup.sql
```

---

## ğŸ“¥ æ¢å¤æ•°æ®åº“

### æ–¹æ³•1ï¼šä½¿ç”¨æ¢å¤è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æ¢å¤æœ€æ–°å¤‡ä»½
restore-database.bat

# æ¢å¤æŒ‡å®šå¤‡ä»½æ–‡ä»¶
restore-database.bat backups\iot_platform_20260108_120000.sql
```

**åŠŸèƒ½ï¼š**
- âœ… è‡ªåŠ¨æ£€æµ‹MySQLå®¹å™¨
- âœ… å®‰å…¨ç¡®è®¤ï¼ˆéœ€è¦è¾“å…¥ yesï¼‰
- âœ… åˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ•°æ®åº“ï¼ˆç¡®ä¿å¹²å‡€æ¢å¤ï¼‰
- âœ… ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æ¢å¤

```bash
# åˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ•°æ®åº“
docker exec iot-mysql mysql -uroot -proot123456 -e "DROP DATABASE IF EXISTS iot_platform;"
docker exec iot-mysql mysql -uroot -proot123456 -e "CREATE DATABASE iot_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# æ¢å¤å¤‡ä»½
docker exec -i iot-mysql mysql -uroot -proot123456 iot_platform < backups\iot_platform_latest.sql
```

---

## ğŸ”„ å¸¸è§åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸é‡å¯å®¹å™¨ï¼ˆæ•°æ®ä¿ç•™ï¼‰

```bash
# åœæ­¢å®¹å™¨ï¼ˆä¿ç•™æ•°æ®å·ï¼‰
docker-compose down

# å¯åŠ¨å®¹å™¨ï¼ˆæ•°æ®è¿˜åœ¨ï¼‰
docker-compose up -d
```

âœ… **æ•°æ®ä¸ä¼šä¸¢å¤±**ï¼ˆæ•°æ®å·ä¿ç•™ï¼‰

---

### åœºæ™¯2ï¼šåˆ é™¤å®¹å™¨å’Œæ•°æ®å·ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰

```bash
# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ•°æ®ï¼‰
docker-compose down -v

# é‡æ–°åˆ›å»ºï¼ˆä¼šæ‰§è¡Œinit.sqlï¼Œæ•°æ®è¢«é‡ç½®ï¼‰
docker-compose up -d
```

âŒ **æ•°æ®ä¼šä¸¢å¤±**ï¼ˆæ•°æ®å·è¢«åˆ é™¤ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
1. å…ˆå¤‡ä»½ï¼š`backup-database.bat`
2. åˆ é™¤å®¹å™¨ï¼š`docker-compose down -v`
3. é‡æ–°åˆ›å»ºï¼š`docker-compose up -d`
4. æ¢å¤æ•°æ®ï¼š`restore-database.bat`

---

### åœºæ™¯3ï¼šè¿ç§»åˆ°å…¶ä»–ç”µè„‘

```bash
# åœ¨æ—§ç”µè„‘ä¸Š
backup-database.bat

# å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ°æ–°ç”µè„‘
# backups/iot_platform_latest.sql

# åœ¨æ–°ç”µè„‘ä¸Š
docker-compose up -d
restore-database.bat backups\iot_platform_latest.sql
```

---

## ğŸ“… å¤‡ä»½å»ºè®®

### å®šæœŸå¤‡ä»½

å»ºè®®åœ¨ä»¥ä¸‹æ—¶æœºå¤‡ä»½ï¼š
- âœ… é‡è¦æ•°æ®å˜æ›´å
- âœ… æ¯å¤©è‡ªåŠ¨å¤‡ä»½ï¼ˆå¯è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼‰
- âœ… ä»£ç æäº¤å‰ï¼ˆgit-push.batä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰

### å¤‡ä»½æ–‡ä»¶ç®¡ç†

- å¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨ `backups/` ç›®å½•
- æœ€æ–°å¤‡ä»½ï¼š`iot_platform_latest.sql`
- å†å²å¤‡ä»½ï¼š`iot_platform_YYYYMMDD_HHMMSS.sql`
- å»ºè®®ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå¤‡ä»½å¤±è´¥

**åŸå› ï¼š**
- MySQLå®¹å™¨æœªè¿è¡Œ
- æ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | findstr mysql

# å¯åŠ¨å®¹å™¨
docker-compose up -d mysql
```

---

### é—®é¢˜2ï¼šæ¢å¤å¤±è´¥

**åŸå› ï¼š**
- å¤‡ä»½æ–‡ä»¶æŸå
- æ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥ > 1KBï¼‰
dir backups\iot_platform_latest.sql

# æ£€æŸ¥MySQLå®¹å™¨æ—¥å¿—
docker logs iot-mysql
```

---

### é—®é¢˜3ï¼šæ•°æ®ä¸¢å¤±

**åŸå› ï¼š**
- ä½¿ç”¨äº† `docker-compose down -v`
- æ•°æ®å·è¢«åˆ é™¤

**è§£å†³ï¼š**
1. å¦‚æœæœ‰å¤‡ä»½ï¼š`restore-database.bat`
2. å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼šé‡æ–°åˆå§‹åŒ– `init.sql`ï¼ˆæ•°æ®ä¼šä¸¢å¤±ï¼‰

---

## ğŸ“ æœ€ä½³å®è·µ

1. **å®šæœŸå¤‡ä»½**
   - é‡è¦æ“ä½œå‰å¤‡ä»½
   - æ¯å¤©è‡ªåŠ¨å¤‡ä»½

2. **ä¿æŠ¤æ•°æ®å·**
   - ä¸è¦ä½¿ç”¨ `docker-compose down -v`
   - ä½¿ç”¨ `docker-compose down`ï¼ˆä¿ç•™æ•°æ®ï¼‰

3. **ç‰ˆæœ¬æ§åˆ¶**
   - å¤‡ä»½æ–‡ä»¶ä¸è¦æäº¤åˆ°Gitï¼ˆå·²åœ¨.gitignoreä¸­ï¼‰
   - ä½†ä¿ç•™ `iot_platform_latest.sql`ï¼ˆç”¨äºåŒæ­¥ï¼‰

4. **å¤šç¯å¢ƒç®¡ç†**
   - å¼€å‘ç¯å¢ƒï¼šå¯ä»¥é‡ç½®
   - ç”Ÿäº§ç¯å¢ƒï¼šå¿…é¡»å¤‡ä»½

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å¤‡ä»½æ•°æ®åº“
backup-database.bat

# æ¢å¤æ•°æ®åº“
restore-database.bat

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
dir backups\

# åœæ­¢å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# å¯åŠ¨å®¹å™¨
docker-compose up -d

# æŸ¥çœ‹æ•°æ®å·
docker volume ls

# åˆ é™¤æ•°æ®å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ•°æ®ï¼‰
docker volume rm iot_mysql-data
```

---

*æœ€åæ›´æ–°ï¼š2026-01-08*
