# IoT物联网设备管理平台开发规约

> Vue 3 + Spring Boot + MySQL + EMQX (MQTT) + Redis
> 支持1W设备并发，167条/秒写入量，基于设备分组的数据权限体系

---

## 🎯 核心原则

### 1. 修改优先级 ⚠️⚠️⚠️
1. **优先修改前端** - 能前端解决的问题，不要动后端
2. **后端修改需询问** - 必须修改后端时，先询问用户确认
3. **保持后端稳定** - 不要为了解决问题就乱改后端

### 2. UI设计风格（Apple风格）
- **字体**：`-apple-system, BlinkMacSystemFont, 'SF Pro Display'`
- **颜色**：主色`#007aff`，成功`#34c759`，警告`#ff9500`，危险`#ff3b30`
- **背景**：页面`#f5f5f7`，卡片`#ffffff`
- **圆角**：6px/10px/16px/20px
- **间距**：8px倍数

### 3. 数据权限（全局统一）
- **超级管理员**：查看所有数据（不过滤）
- **普通用户**：只能查看本分组及下级分组数据
- **过滤字段**：用户表、设备表、告警日志表都使用 `group_id` 过滤

### 4. API接口规范
- 统一POST方法，JSON格式
- 统一响应：`{code, message, data}`
- **禁止前端硬编码业务数据**，必须从后端API获取

### 5. 分组组件（强制统一）
- 下拉选择：使用 `GroupSelector` 组件
- 树形展示：使用 `GroupTree` 组件
- **禁止重复实现分组功能**

### 6. 性能要求
- 列表查询 < 500ms
- 必须分页查询，禁止一次性加载
- 禁止循环中执行数据库操作
- MQTT消息异步处理

---

## ✅ 必须遵守的规则

### 后端修改后自动编译
```
修改后端代码后，执行：cd backend && mvn package -DskipTests
编译完成后提醒用户重启后端服务
```

### 设备列表排序
```sql
ORDER BY status DESC, create_time DESC  -- 在线优先，时间降序
```

### 弹窗设计
- 内容在视窗内完整显示，最大高度96vh
- 禁止出现滚动条（列表区域除外）

### 时间格式
```
格式：yyyy-MM-dd HH:mm:ss
示例：2026-01-10 08:42:49
禁止：ISO 8601格式（带T的格式）
```

### 脚本编写规则 ⚠️⚠️⚠️
```
⚠️ 所有脚本必须支持在不同电脑上运行，禁止硬编码绝对路径！

📁 脚本目录：scripts/
🔹 脚本开头必须使用相对路径：
   @echo off
   setlocal enabledelayedexpansion
   chcp 65001 >nul
   
   REM 获取脚本所在目录（自动适配不同路径）
   set SCRIPT_DIR=%~dp0
   set SCRIPT_DIR=!SCRIPT_DIR:~0,-1!
   
   REM 切换到项目根目录
   cd /d "!SCRIPT_DIR!\.."

🔹 配置信息放在单独的配置文件：
   - 配置文件：scripts/deploy-config.txt
   - 模板文件：scripts/deploy-config.template.txt
   - 配置文件不提交到Git（已在.gitignore中）

🔹 危险操作必须二次确认：
   - Git pull/push 等会覆盖代码的操作
   - 删除文件/目录的操作
   - 需要先显示当前状态，让用户知道会影响什么
   - 使用 set /p CONFIRM="确认？(Y/N): " 获取用户确认

❌ 禁止行为：
   - 硬编码绝对路径（如 D:\AICoding\IOT）
   - 硬编码用户名、密码到脚本中
   - 依赖特定电脑的环境变量
   - 危险操作不经确认直接执行
```

### 数据库迁移规则 ⚠️⚠️⚠️
```
⚠️ 数据库结构变更必须通过迁移脚本管理，保护生产数据安全！

📁 迁移脚本目录：sql/migrations/
📋 服务器现有表（15张）：
   - system_config, tb_alarm_log, tb_attribute, tb_command, tb_command_log
   - tb_device, tb_device_data, tb_device_group, tb_device_log, tb_menu
   - tb_migration_history, tb_notification, tb_product, tb_role, tb_user

🔹 新增功能需要新建表时：
   1. 在 sql/migrations/ 目录创建迁移脚本
   2. 文件命名：XXX_功能描述.sql（如：002_add_xxx_table.sql）
   3. 使用 CREATE TABLE IF NOT EXISTS 语法
   4. 示例：
      CREATE TABLE IF NOT EXISTS `tb_new_table` (
          `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
          ...
      );

🔹 现有表需要新增字段时：
   1. 在 sql/migrations/ 目录创建迁移脚本
   2. 使用安全的 ALTER TABLE 语法，先检查字段是否存在
   3. 示例：
      SET @exist := (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS 
                     WHERE TABLE_SCHEMA = DATABASE() 
                     AND TABLE_NAME = 'tb_device' 
                     AND COLUMN_NAME = 'new_field');
      SET @sql := IF(@exist = 0, 
          'ALTER TABLE tb_device ADD COLUMN new_field VARCHAR(100) DEFAULT NULL', 
          'SELECT 1');
      PREPARE stmt FROM @sql;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;

🔹 新增索引时：
   CREATE INDEX IF NOT EXISTS `idx_xxx` ON `tb_xxx` (`field`);

❌ 绝对禁止的操作（会导致数据丢失）：
   - DROP TABLE（删除表）
   - TRUNCATE TABLE（清空表）
   - DELETE FROM（删除数据）
   - DROP COLUMN（删除字段）
   - 不带 IF NOT EXISTS 的 CREATE TABLE

⚠️ 迁移脚本编写后：
   1. 同步更新后端Entity类（如有新字段）
   2. 同步更新后端Mapper（如有新字段）
   3. 提醒用户运行 scripts/sync-db.bat 同步到服务器
```

---

## 📁 关键文件位置

| 类型 | 路径 |
|------|------|
| 数据库迁移 | `sql/migrations/` |
| 前端API | `frontend/src/api/` |
| 分组组件 | `frontend/src/components/GroupSelector.vue`、`GroupTree.vue` |
| 数据权限 | `backend/.../controller/DeviceController.java` |
| MQTT配置 | `backend/.../mqtt/MqttConfig.java` |
| 数据库同步 | `scripts/sync-db.bat` |

---

## ❌ 禁止行为

- 前端硬编码业务数据
- 不同接口使用不同权限逻辑
- 跳过数据权限检查
- 全表扫描、未分页查询
- 同步处理MQTT消息
- DROP/TRUNCATE/DELETE 生产数据

---

*最后更新：2026-01-12*
