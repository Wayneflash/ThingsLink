# IoT物联网设备管理平台开发规约，每次编码时必须遵循

> 本文档定义了IoT平台项目的开发规范和架构原则，所有AI助手必须严格遵守执行。

---

## 📋 项目概述

### 项目定位
- **项目类型**：IoT物联网设备管理平台
- **技术栈**：Vue 3 + Spring Boot + MySQL + EMQX (MQTT) + Redis
- **核心特点**：
  - **未使用时序数据库**，使用MySQL存储时序数据
  - **性能要求高**，支持1W+设备并发
  - **数据权限严格**，基于设备分组的权限体系
  - **实时性要求高**，MQTT消息实时处理

### 核心业务模块
- 设备管理（设备分组、设备实例、设备状态）
- 产品管理（产品定义、物模型、命令定义）
- 数据管理（设备数据存储、查询、统计）
- 用户权限管理（角色、菜单、数据权限）
- 告警管理（告警阈值配置、告警触发、告警日志）
- MQTT消息处理（设备上报、命令下发）

---

## 🎯 核心架构原则

### 1. 修改优先级原则 ⚠️⚠️⚠️

**必须严格遵守的优先级顺序：**
1. **优先修改前端** - 能前端解决的问题，不要动后端
2. **后端修改需询问** - 必须修改后端时，先询问用户确认
3. **不要为了解决问题就乱改后端** - 保持后端代码的稳定性和一致性

**判断标准：**
- 前端显示问题 → 优先前端适配
- 前端数据格式问题 → 优先前端转换
- 前端交互问题 → 优先前端解决

---

### 2. UI/UX设计原则 ⚠️⚠️⚠️

**必须以苹果UI顶级设计师和物联网行业平台经验的设计视角来设计前端页面和交互：**

#### 设计理念
- **极简主义**：界面简洁、清晰，去除不必要的装饰元素
- **信息层次**：通过字体大小、颜色、间距建立清晰的信息层次
- **一致性**：所有页面保持统一的设计语言和交互模式
- **专业性**：体现物联网平台的专业性和可靠性

#### 视觉设计规范
- **色彩系统**：
  - 主色调：使用系统蓝色（#007AFF）作为主要操作色
  - 背景色：浅灰（#f5f5f7）作为页面背景，白色（#ffffff）作为卡片背景
  - 文字色：深灰（#1d1d1f）作为主要文字，中灰（#86868b）作为次要文字
  - 状态色：成功（#34c759）、警告（#ff9500）、错误（#ff3b30）
- **字体系统**：
  - 主字体：系统字体栈 `-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`
  - 代码字体：`'SF Mono', 'Monaco', 'Consolas', monospace`
  - 字号层级：标题36px+、副标题20-24px、正文15-17px、辅助文字12-13px
- **间距系统**：
  - 使用8px基础单位，间距为8px的倍数（8、12、16、20、24、28、32px）
  - 卡片内边距：24-28px
  - 元素间距：12-16px
- **圆角规范**：
  - 卡片：10-16px
  - 按钮：8-10px
  - 输入框：6-8px
- **阴影规范**：
  - 卡片阴影：`0 1px 3px rgba(0, 0, 0, 0.04)`（轻微阴影，不突兀）
  - 悬浮阴影：`0 2px 8px rgba(0, 0, 0, 0.08)`

#### 交互设计规范
- **反馈机制**：
  - 所有操作必须有明确的视觉反馈（按钮点击、表单提交、数据加载）
  - 使用Element Plus的Message组件提供操作反馈
  - 加载状态使用v-loading指令
- **动画效果**：
  - 过渡动画：0.2-0.3s，使用ease-out缓动函数
  - 避免过度动画，保持流畅自然
- **响应式设计**：
  - 优先考虑1920x1080分辨率，确保内容完整显示
  - 考虑非全屏浏览器窗口（预留浏览器UI空间）
  - 使用flex布局和grid布局实现响应式
- **信息密度**：
  - 合理的信息密度，避免过度拥挤
  - 重要信息突出显示，次要信息适当弱化
  - 使用卡片布局分组相关信息

#### 物联网平台特殊设计
- **数据可视化**：
  - 实时数据使用大号字体和醒目的颜色（蓝色#007AFF）
  - 图表使用清晰的配色和适当的图例
  - 状态指示使用颜色+图标+文字的组合
- **设备状态展示**：
  - 在线状态：绿色圆点+文字，不使用完整badge
  - 离线状态：灰色圆点+文字
  - 状态变化要有平滑过渡
- **数据表格**：
  - 表格行高适中（48-56px），避免过密
  - 重要列（设备名称、状态）使用粗体或特殊颜色
  - 操作列固定在右侧，使用link按钮样式
- **表单设计**：
  - 标签和输入框对齐清晰
  - 必填项使用红色星号标记
  - 错误提示清晰明确，位置合理
- **弹窗设计**：
  - 弹窗宽度适中（600-800px），避免过宽
  - 内容区域合理分块，使用分隔线区分
  - 操作按钮右对齐，主按钮突出

#### 禁止的设计行为
- ❌ 过度装饰（渐变、阴影过重、边框过粗）
- ❌ 颜色使用混乱（超过3-4种主要颜色）
- ❌ 字体大小不一致（同一层级使用不同字号）
- ❌ 间距不统一（随意使用间距值）
- ❌ 信息密度过高（内容拥挤，难以阅读）
- ❌ 缺乏反馈（操作后无视觉反馈）
- ❌ 动画过度（动画时间过长或效果过炫）

---

### 3. 数据权限统一原则 ⚠️⚠️⚠️

**全局数据权限必须统一实现，所有数据权限逻辑必须完全一致：**

#### 权限模型（全局统一）
- **超级管理员**：可查看所有数据（不受分组限制）
- **普通用户**：只能查看本分组及所有下级分组的数据
- **权限继承**：下级分组的数据自动继承上级分组权限

#### 统一权限判断逻辑（所有接口必须一致）
1. **获取当前用户**：从Token中解析用户信息
2. **判断超级管理员**：检查用户角色是否为super_admin
3. **获取权限分组列表**：
   - 超级管理员：返回null（表示不过滤）
   - 普通用户：获取用户所属分组ID及所有下级分组ID列表
4. **应用权限过滤**：使用分组ID列表过滤查询条件

#### 权限过滤字段映射（统一规范）
- **用户表**：使用 `group_id` 字段过滤
- **设备表**：使用 `group_id` 字段过滤
- **设备数据表**：通过设备表的 `group_id` 关联过滤
- **分组表**：使用分组ID列表过滤
- **告警日志表**：通过设备表的 `group_id` 关联过滤
- **命令记录表**：通过设备表的 `group_id` 关联过滤

#### 禁止行为（严格禁止）
- ❌ 不同Controller使用不同的数据权限逻辑
- ❌ 硬编码权限判断逻辑
- ❌ 跳过数据权限检查
- ❌ 只检查本分组，不包含下级分组

---

### 4. API接口统一原则 ⚠️⚠️⚠️

**所有接口必须遵循统一规范：**

#### 请求规范
- 统一使用POST方法（除特殊情况如文件下载）
- 统一请求头：Authorization: Bearer {token}
- 统一请求体：JSON格式
- 统一参数命名：驼峰命名法

#### 响应规范
- 统一响应结构：{code, message, data}
- code: 200表示成功，其他表示失败
- message: 成功时返回"success"，失败时返回错误信息
- data: 实际数据，可为null

#### 数据来源规范
- **禁止前端硬编码任何业务数据**
- 菜单权限：从后端 `/api/auth/user-info` 获取
- 分组数据：从后端 `/api/device-groups/tree` 获取
- 产品类型：从后端 `/api/products/list` 获取
- 设备状态：从后端 `/api/devices/list` 获取
- 角色类型：从后端 `/api/roles/list` 获取

#### 禁止行为
- 前端硬编码菜单、权限数据
- 前端硬编码分组数据
- 前端硬编码产品、设备类型
- 前端硬编码状态枚举值
- 前端硬编码角色类型

---

### 5. 分组查询统一原则 ⚠️⚠️⚠️

**分组相关功能必须完全统一，禁止任何形式的重复实现：**

#### 后端分组接口（唯一接口）
- **统一接口**：`POST /api/device-groups/tree`（唯一的分组树接口）
- **统一返回格式**：{code: 200, data: {tree: [...]}}
- **统一权限过滤**：根据用户权限自动过滤分组树（后端统一处理）

#### 前端分组使用（强制统一）
- **统一API方法**：**必须**使用 `frontend/src/api/group.js` 中的 `getGroupTree()` 方法
- **统一组件使用**：
  - **下拉选择场景**：**必须**使用 `GroupSelector` 组件（禁止自己实现）
  - **树形展示场景**：**必须**使用 `GroupTree` 组件（禁止自己实现）

#### 严格禁止行为
- ❌ **不同页面重复实现分组查询逻辑**（必须使用统一组件）
- ❌ **直接调用API而不使用统一组件或方法**（禁止直接调用 `/api/device-groups/tree`）
- ❌ **自己实现分组选择器**（必须使用GroupSelector组件）
- ❌ **自己实现分组树展示**（必须使用GroupTree组件）

---

### 6. 性能优化原则 ⚠️⚠️⚠️

**本项目未使用时序数据库，性能要求高，必须严格遵循：**

#### 数据库性能优化
- **分区表**：时序数据表必须使用分区（按月分区）
- **索引优化**：合理设计索引，避免全表扫描
- **查询优化**：避免N+1查询，使用批量查询
- **数据归档**：定期清理历史数据（保留最近3个月）

#### 代码性能优化
- **批量操作**：批量插入、批量更新、批量查询
- **缓存策略**：设备在线状态、最新数据使用Redis缓存
- **异步处理**：MQTT消息处理使用异步，避免阻塞
- **分页查询**：列表查询必须分页，避免一次性加载大量数据

#### 查询性能要求
- 列表查询响应时间 < 500ms
- 单条数据查询响应时间 < 100ms
- 统计数据查询响应时间 < 1s
- 避免全表扫描
- 避免循环中执行数据库操作

#### 禁止行为
- 全表扫描查询
- 大量数据一次性加载
- 循环中执行数据库操作
- 缺少索引的查询条件
- 未分页的列表查询

---

### 7. MQTT消息处理原则 ⚠️⚠️⚠️

**MQTT是核心通信协议，必须严格遵循：**

#### 消息处理规范
- **异步处理**：MQTT消息处理必须异步，避免阻塞
- **幂等性**：消息处理要保证幂等性，避免重复处理
- **错误处理**：消息处理失败要有重试机制和错误日志
- **性能要求**：消息处理要快速，避免消息堆积

#### 设备上报处理
- 接收设备上报数据
- 解析数据格式（ThingsFusion格式）
- 存储设备数据到数据库
- 更新设备在线状态
- 触发告警检查（如果配置了告警）

#### 命令下发处理
- 接收命令下发请求
- 验证设备状态（设备必须在线）
- 通过MQTT发送命令到设备
- 记录命令下发日志

#### 禁止行为
- 同步处理MQTT消息
- 消息处理失败不记录日志
- 命令下发不验证设备状态
- 消息处理阻塞主线程

---

### 8. 告警管理原则 ⚠️⚠️⚠️

**告警是核心功能，必须严格遵循：**

#### 告警配置规范
- 告警配置存储在设备表的alarm_config字段（JSON格式）
- 支持单设备配置和批量配置
- 告警配置包含：级别、条件、通知人员、堆叠模式
- 告警配置必须关联产品物模型（监控指标）

#### 告警触发规范
- 设备数据上报时触发告警检查
- 根据告警配置判断是否触发告警
- 告警触发后记录告警日志
- 告警通知相关人员（未来扩展）

#### 告警日志规范
- 所有告警必须记录日志
- 告警日志包含：设备信息、告警级别、告警消息、触发时间
- 告警日志支持查询、统计、处理
- 告警日志要支持分页查询

#### 禁止行为
- 告警配置不关联产品物模型
- 告警触发不记录日志
- 告警日志不实现数据权限过滤

---

### 9. 前端组件规范 ⚠️⚠️⚠️

**前端组件要统一、可复用：**

#### 组件使用规范
- 统一使用Element Plus组件库
- 统一使用Vue 3 Composition API（`<script setup>`）
- 组件要可复用、可配置

#### 组件设计规范
- 组件要有明确的职责
- 组件要有清晰的Props和Events
- 组件要有错误处理
- 组件要有加载状态

#### 全局组件
- GroupSelector：分组选择器组件
- GroupTree：分组树组件
- 其他全局组件要统一管理

#### 禁止行为
- 不同页面重复实现相同功能的组件
- 组件硬编码业务数据
- 组件不处理错误情况

---

### 10. 错误处理原则 ⚠️⚠️⚠️

**错误处理要统一、友好：**

#### 后端错误处理
- 统一异常处理：使用@ControllerAdvice统一处理异常
- 统一错误响应格式：{code, message, data: null}
- 记录错误日志：关键错误要记录日志
- 错误信息要友好：不要暴露系统内部信息

#### 前端错误处理
- 统一错误处理：使用响应拦截器统一处理错误
- 统一错误提示：使用Element Plus的Message组件
- 错误要友好：显示用户友好的错误信息
- 错误要记录：关键错误要记录到控制台

#### 禁止行为
- 错误信息暴露系统内部信息
- 错误不处理直接抛出
- 错误不记录日志

---

## 🚫 禁止行为清单

### 后端禁止行为
- 修改后端代码前不询问用户
- 不同Controller使用不同的数据权限逻辑
- 硬编码权限判断逻辑
- 跳过数据权限检查
- 返回格式不统一
- 全表扫描查询
- 循环中执行数据库操作
- 同步处理MQTT消息
- 告警触发不记录日志

### 前端禁止行为
- 硬编码菜单、权限数据
- 硬编码分组数据
- 硬编码产品、设备类型
- 不同页面重复实现分组查询逻辑
- 直接调用API而不使用统一组件
- 组件硬编码业务数据
- 错误不处理
- **UI设计不符合苹果设计规范**
- **信息密度过高或过低**
- **缺乏操作反馈**

---

## ✅ 必须遵守的规则

### 1. 修改后端前必须询问
```
⚠️ 重要：需要修改后端代码时，必须先询问用户：
"需要修改后端代码 [具体文件和方法]，是否同意？"
```

### 2. UI设计必须符合苹果设计规范
```
⚠️ 所有前端页面设计必须遵循苹果UI设计规范：
- 使用苹果设计系统的色彩、字体、间距
- 保持界面简洁、清晰、专业
- 体现物联网平台的专业性和可靠性
- 确保信息层次清晰，交互流畅自然
```

### 3. 数据权限必须全局统一
```
⚠️ 所有查询接口必须实现数据权限过滤，使用完全一致的逻辑。
⚠️ 用户数据权限、分组数据权限、设备数据权限必须统一实现。
⚠️ 所有权限判断逻辑必须一致，禁止不同接口使用不同的权限逻辑。
```

### 4. 接口数据必须从后端获取
```
⚠️ 前端禁止硬编码任何业务数据，必须从后端API获取。
```

### 5. 分组查询必须完全统一
```
⚠️ 前端必须使用统一的组件获取分组数据，禁止任何形式的重复实现。
⚠️ 下拉选择场景必须使用GroupSelector组件，树形展示必须使用GroupTree组件。
⚠️ 禁止直接调用分组API，禁止自己实现分组选择器或分组树。
```

### 6. 性能优先
```
⚠️ 本项目未使用时序数据库，代码设计必须考虑性能。
```

### 7. MQTT消息异步处理
```
⚠️ MQTT消息处理必须异步，避免阻塞。
```

### 8. 告警必须记录日志
```
⚠️ 所有告警必须记录日志，支持查询和统计。
```

---

## 📚 参考文件

### 关键文件位置
- 数据库初始化：`init.sql`
- 前端API封装：`frontend/src/api/group.js`
- 前端请求封装：`frontend/src/utils/request.js`
- 分组组件：`frontend/src/components/GroupSelector.vue`、`GroupTree.vue`
- 数据权限示例：`backend/src/main/java/com/iot/platform/controller/DeviceController.java`
- MQTT配置：`backend/src/main/java/com/iot/platform/mqtt/MqttConfig.java`

### 参考实现
- 数据权限实现：参考DeviceController.getDeviceList()方法
- 分组树实现：参考DeviceGroupController.getGroupTree()方法
- 前端分组使用：参考GroupSelector.vue组件
- UI设计参考：参考DeviceDetail.vue页面的设计风格

---

## 💡 代码简洁性原则

### 代码简洁性要求
- **在实现功能要求的前提下，代码越简单越好**
- **代码注释要详细**，关键逻辑、复杂算法、业务规则必须添加注释
- **避免过度设计**，不要为了展示技术而增加复杂度
- **优先使用简单直接的实现方式**，除非性能或业务有特殊要求

### 注释规范
- **方法注释**：说明方法功能、参数含义、返回值含义
- **业务逻辑注释**：复杂业务逻辑必须添加注释说明
- **算法注释**：复杂算法必须添加注释说明思路
- **关键代码注释**：数据权限判断、权限过滤等关键代码必须注释

### 禁止行为
- ❌ 为了展示技术而增加不必要的复杂度
- ❌ 过度抽象导致代码难以理解
- ❌ 关键逻辑没有注释
- ❌ 复杂业务逻辑没有注释说明

---

*最后更新：2025-01-06*
