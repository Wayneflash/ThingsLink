<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¾å¤‡ç®¡ç† - IoTè®¾å¤‡ç®¡ç†å¹³å°</title>
  <link rel="stylesheet" href="/src/styles/common.css">
  <style>
    body {
      background: var(--bg-dark);
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* ä¾§è¾¹æ  - ç§‘æŠ€é£ */
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 28px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 19px;
      font-weight: 700;
      color: var(--text-dark);
      letter-spacing: -0.02em;
    }

    .sidebar-menu {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }

    .menu-item {
      padding: 12px 20px;
      margin: 4px 12px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--text-dark-secondary);
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-weight: 500;
      position: relative;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-dark);
    }

    .menu-item.active {
      background: rgba(0, 122, 255, 0.15);
      color: #007aff;
      font-weight: 600;
    }

    .menu-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: #007aff;
      border-radius: 0 2px 2px 0;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-primary);
    }

    .topbar {
      height: 72px;
      background: var(--bg-topbar);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      padding: 0 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
    }

    /* ç­›é€‰æ  */
    .filter-bar {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 28px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-end;
      box-shadow: var(--shadow-card);
    }

    .filter-item {
      flex: 1;
      min-width: 220px;
    }

    .filter-label {
      display: block;
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .select {
      width: 100%;
      padding: 11px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      -webkit-appearance: none;
    }

    .select:hover {
      border-color: var(--border-hover);
    }

    .select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-light);
    }

    /* å·¥å…·æ  */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .toolbar-left {
      display: flex;
      gap: 14px;
    }

    /* è¡¨æ ¼å®¹å™¨ */
    .table-container {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-card);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    /* åˆ†é¡µ */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-tertiary);
    }

    .pagination-info {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .pagination-buttons {
      display: flex;
      gap: 10px;
    }

    .page-btn {
      min-width: 36px;
      height: 36px;
      padding: 0 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .page-btn:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .page-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .page-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    /* æ¨¡æ€æ¡† - Appleé£æ ¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.25s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      width: 540px;
      max-width: 90vw;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .modal-close {
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.25s;
    }

    .modal-close:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 28px;
    }

    .form-row {
      margin-bottom: 24px;
    }

    .modal-footer {
      padding: 20px 28px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      background: var(--bg-tertiary);
      border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span style="font-size: 32px;">âš™ï¸</span>
          <span>IoTç®¡ç†å¹³å°</span>
        </div>
      </div>

      <nav class="sidebar-menu">
        <a href="/dashboard.html" class="menu-item">
          <span style="font-size: 20px;">ğŸ“Š</span>
          <span>ä»ªè¡¨ç›˜</span>
        </a>
        <a href="/devices.html" class="menu-item active">
          <span style="font-size: 20px;">ğŸ“±</span>
          <span>è®¾å¤‡ç®¡ç†</span>
        </a>
        <a href="/products.html" class="menu-item">
          <span style="font-size: 20px;">ğŸ“¦</span>
          <span>äº§å“ç®¡ç†</span>
        </a>
      </nav>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
      <div class="topbar">
        <h1 class="page-title" style="color: var(--text-dark);">è®¾å¤‡ç®¡ç†</h1>
        <button class="btn btn-sm" style="background: rgba(255, 59, 48, 0.15); color: #ff3b30; border: none; font-weight: 600;" onclick="logout()">é€€å‡º</button>
      </div>

      <div class="content">
        <!-- ç­›é€‰æ  -->
        <div class="filter-bar">
          <div class="filter-item">
            <label class="filter-label">æœç´¢</label>
            <input type="text" class="input" id="searchKeyword" placeholder="è®¾å¤‡åç§°æˆ–ç¼–ç ">
          </div>
          <div class="filter-item" style="flex: 0.5;">
            <label class="filter-label">äº§å“</label>
            <select class="select" id="productFilter">
              <option value="">å…¨éƒ¨äº§å“</option>
            </select>
          </div>
          <div class="filter-item" style="flex: 0.5;">
            <label class="filter-label">çŠ¶æ€</label>
            <select class="select" id="statusFilter">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="1">åœ¨çº¿</option>
              <option value="0">ç¦»çº¿</option>
            </select>
          </div>
          <div style="flex: 0;">
            <button class="btn btn-primary" onclick="searchDevices()">æŸ¥è¯¢</button>
          </div>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
          <div class="toolbar-left">
            <button class="btn btn-primary" onclick="showAddModal()">+ æ–°å¢è®¾å¤‡</button>
            <button class="btn" onclick="loadDevices()">ğŸ”„ åˆ·æ–°</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; font-weight: 500;">
            å…± <span id="totalCount" style="color: var(--primary); font-weight: 700;">0</span> å°è®¾å¤‡
          </div>
        </div>

        <!-- è¡¨æ ¼ -->
        <div class="table-container">
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>è®¾å¤‡åç§°</th>
                  <th>è®¾å¤‡ç¼–ç </th>
                  <th>äº§å“</th>
                  <th>åˆ†ç»„</th>
                  <th>çŠ¶æ€</th>
                  <th>æœ€ååœ¨çº¿æ—¶é—´</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th style="width: 180px;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="deviceTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <div style="margin-top: 12px; color: var(--text-muted);">åŠ è½½ä¸­...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- åˆ†é¡µ -->
          <div class="pagination">
            <div class="pagination-info" id="pageInfo">-</div>
            <div class="pagination-buttons" id="paginationButtons"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- æ–°å¢è®¾å¤‡æ¨¡æ€æ¡† -->
  <div class="modal" id="addDeviceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ–°å¢è®¾å¤‡</h3>
        <button class="modal-close" onclick="closeModal('addDeviceModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="addDeviceForm">
          <div class="form-row">
            <label class="filter-label">è®¾å¤‡åç§° *</label>
            <input type="text" class="input" name="name" required placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°">
          </div>
          <div class="form-row">
            <label class="filter-label">è®¾å¤‡ç¼–ç  *</label>
            <input type="text" class="input" name="code" required placeholder="è¯·è¾“å…¥è®¾å¤‡ç¼–ç ">
          </div>
          <div class="form-row">
            <label class="filter-label">æ‰€å±äº§å“ *</label>
            <select class="select" name="productId" required id="productSelect">
              <option value="">è¯·é€‰æ‹©äº§å“</option>
            </select>
          </div>
          <div class="form-row">
            <label class="filter-label">æ‰€å±åˆ†ç»„ *</label>
            <select class="select" name="groupId" required id="groupSelect">
              <option value="">è¯·é€‰æ‹©åˆ†ç»„</option>
            </select>
          </div>
          <div class="form-row">
            <label class="filter-label">å¤‡æ³¨</label>
            <input type="text" class="input" name="remark" placeholder="é€‰å¡«">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addDeviceModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitAddDevice()">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { deviceApi, productApi, groupApi, authApi } from '/src/utils/api.js';

    // æ£€æŸ¥ç™»å½•
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    window.logout = () => {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        authApi.logout();
      }
    };

    // å…¨å±€å˜é‡
    let currentPage = 1;
    let pageSize = 10;
    let totalPages = 1;
    let products = [];
    let groups = [];

    // åŠ è½½äº§å“åˆ—è¡¨
    async function loadProducts() {
      try {
        const result = await productApi.list({ page: 1, pageSize: 100 });
        if (result.code === 200) {
          products = result.data.list || [];
          
          // æ›´æ–°äº§å“ç­›é€‰å™¨
          const productFilter = document.getElementById('productFilter');
          productFilter.innerHTML = '<option value="">å…¨éƒ¨äº§å“</option>' +
            products.map(p => `<option value="${p.id}">${p.productName}</option>`).join('');
          
          // æ›´æ–°äº§å“é€‰æ‹©å™¨
          const productSelect = document.getElementById('productSelect');
          productSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äº§å“</option>' +
            products.map(p => `<option value="${p.id}">${p.productName}</option>`).join('');
        }
      } catch (error) {
        console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
      }
    }

    // åŠ è½½åˆ†ç»„åˆ—è¡¨
    async function loadGroups() {
      try {
        const result = await groupApi.list();
        if (result.code === 200) {
          groups = result.data.list || [];
          
          const groupSelect = document.getElementById('groupSelect');
          groupSelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç»„</option>' +
            groups.map(g => `<option value="${g.id}">${g.groupName}</option>`).join('');
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨å¤±è´¥:', error);
      }
    }

    // åŠ è½½è®¾å¤‡åˆ—è¡¨
    window.loadDevices = async function(page = 1) {
      currentPage = page;
      
      const keyword = document.getElementById('searchKeyword').value.trim();
      const productId = document.getElementById('productFilter').value;
      const status = document.getElementById('statusFilter').value;

      const params = {
        page: currentPage,
        pageSize: pageSize,
      };

      if (keyword) params.keyword = keyword;
      if (productId) params.productId = parseInt(productId);
      if (status !== '') params.status = parseInt(status);

      try {
        const result = await deviceApi.list(params);
        if (result.code === 200) {
          const data = result.data;
          totalPages = data.totalPages || 1;
          
          renderDeviceTable(data.list || []);
          renderPagination(data.total || 0, currentPage, totalPages);
          
          document.getElementById('totalCount').textContent = data.total || 0;
        }
      } catch (error) {
        console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('deviceTableBody').innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--danger);">
              åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
            </td>
          </tr>
        `;
      }
    };

    // æ¸²æŸ“è®¾å¤‡è¡¨æ ¼
    function renderDeviceTable(devices) {
      const tbody = document.getElementById('deviceTableBody');
      
      if (devices.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
              æš‚æ— æ•°æ®
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = devices.map(device => `
        <tr>
          <td>${device.deviceName || '-'}</td>
          <td><code>${device.deviceCode || '-'}</code></td>
          <td>${device.productName || '-'}</td>
          <td>${device.groupPath || device.groupName || '-'}</td>
          <td>
            ${device.status === 1 
              ? '<span class="badge badge-online">åœ¨çº¿</span>' 
              : '<span class="badge badge-offline">ç¦»çº¿</span>'}
          </td>
          <td>${device.lastOnlineTime || '-'}</td>
          <td>${device.createTime || '-'}</td>
          <td>
            <div class="action-buttons">
              <a href="/device-detail.html?code=${device.deviceCode}" class="btn btn-sm">è¯¦æƒ…</a>
              <button class="btn btn-sm btn-danger" onclick="deleteDevice('${device.deviceCode}', '${device.deviceName}')">åˆ é™¤</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(total, current, totalPages) {
      const pageInfo = document.getElementById('pageInfo');
      const buttons = document.getElementById('paginationButtons');
      
      const start = (current - 1) * pageSize + 1;
      const end = Math.min(current * pageSize, total);
      pageInfo.textContent = `æ˜¾ç¤º ${start}-${end} / å…± ${total} æ¡`;

      let html = `
        <button class="page-btn" ${current === 1 ? 'disabled' : ''} onclick="loadDevices(${current - 1})">ä¸Šä¸€é¡µ</button>
      `;

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= current - 2 && i <= current + 2)) {
          html += `<button class="page-btn ${i === current ? 'active' : ''}" onclick="loadDevices(${i})">${i}</button>`;
        } else if (i === current - 3 || i === current + 3) {
          html += `<span style="padding: 0 8px; color: var(--text-muted);">...</span>`;
        }
      }

      html += `
        <button class="page-btn" ${current === totalPages ? 'disabled' : ''} onclick="loadDevices(${current + 1})">ä¸‹ä¸€é¡µ</button>
      `;

      buttons.innerHTML = html;
    }

    // æœç´¢è®¾å¤‡
    window.searchDevices = function() {
      loadDevices(1);
    };

    // æ˜¾ç¤ºæ–°å¢æ¨¡æ€æ¡†
    window.showAddModal = function() {
      document.getElementById('addDeviceForm').reset();
      document.getElementById('addDeviceModal').classList.add('show');
    };

    // å…³é—­æ¨¡æ€æ¡†
    window.closeModal = function(id) {
      document.getElementById(id).classList.remove('show');
    };

    // æäº¤æ–°å¢è®¾å¤‡
    window.submitAddDevice = async function() {
      const form = document.getElementById('addDeviceForm');
      const formData = new FormData(form);
      
      const data = {
        name: formData.get('name'),
        code: formData.get('code'),
        productId: parseInt(formData.get('productId')),
        groupId: parseInt(formData.get('groupId')),
        remark: formData.get('remark') || '',
      };

      if (!data.name || !data.code || !data.productId || !data.groupId) {
        alert('è¯·å¡«å†™å¿…å¡«é¡¹');
        return;
      }

      try {
        const result = await deviceApi.create(data);
        if (result.code === 200) {
          alert('åˆ›å»ºæˆåŠŸ');
          closeModal('addDeviceModal');
          loadDevices(1);
        } else {
          alert(result.message || 'åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ›å»ºè®¾å¤‡å¤±è´¥:', error);
        alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };

    // åˆ é™¤è®¾å¤‡
    window.deleteDevice = async function(deviceCode, deviceName) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡"${deviceName}"å—ï¼Ÿ`)) {
        return;
      }

      try {
        const result = await deviceApi.delete(deviceCode);
        if (result.code === 200) {
          alert('åˆ é™¤æˆåŠŸ');
          loadDevices(currentPage);
        } else {
          alert(result.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };

    // åˆå§‹åŒ–
    loadProducts();
    loadGroups();
    loadDevices();
  </script>
</body>
</html>
