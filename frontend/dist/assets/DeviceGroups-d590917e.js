import{_ as P,Y as w,Z as Q,r as u,a0 as W,o as G,c as X,b as m,e as l,w as a,g as p,E as i,k as T,i as E,ac as S,q as y,t as M,y as ee,h as te,ad as le}from"./index-98982554.js";import{g as ae,d as oe,u as ne,c as se}from"./group-67a2fda9.js";import{g as re}from"./device-4933ef44.js";import{f as ue,G as ie}from"./GroupTree-63ffa851.js";const de={class:"device-groups-page"},ce={class:"group-container"},pe={class:"flex items-center justify-between"},ve={class:"flex items-center justify-between"},me={class:"font-semibold"},fe={__name:"DeviceGroups",setup(_e){const _=p(!1),f=p(!1),h=p("åˆ›å»ºåˆ†ç»„"),x=p(!1),I=p(null),n=p(null),D=p(null),b=w(()=>D.value?D.value.roleId===1:!1),r=p([]),v=p([]),o=te({id:null,name:"",parentId:0,desc:""}),U={name:[{required:!0,message:"è¯·è¾“å…¥åˆ†ç»„åç§°",trigger:"blur"}]};w(()=>r.value.filter(t=>t.parentId===0)),w(()=>r.value.reduce((t,e)=>t+(e.deviceCount||0),0));const j=w(()=>{if(!n.value)return"è¯·é€‰æ‹©åˆ†ç»„";const t=r.value.find(e=>e.id===n.value);return t?t.name:""}),z=w(()=>(console.log("deviceList computed, mockDevices:",v.value),console.log("currentGroupId:",n.value),n.value?(console.log("è¿”å›è®¾å¤‡åˆ—è¡¨ï¼Œæ•°é‡:",v.value.length),v.value):(console.log("æ²¡æœ‰é€‰ä¸­åˆ†ç»„ï¼Œè¿”å›ç©ºåˆ—è¡¨"),[]))),F=async t=>{console.log("é€‰ä¸­åˆ†ç»„:",t),n.value=t,await k()},$=()=>{if(!b.value){i.warning("åªæœ‰è¶…çº§ç®¡ç†å‘˜æ‰èƒ½åˆ›å»ºåˆ†ç»„");return}h.value="åˆ›å»ºåˆ†ç»„",x.value=!1,f.value=!0},L=t=>{if(!b.value){i.warning("åªæœ‰è¶…çº§ç®¡ç†å‘˜æ‰èƒ½ç¼–è¾‘åˆ†ç»„");return}if(t.parentId===0||t.parentId===null){i.warning("æ€»åˆ†ç»„ä¸å…è®¸ç¼–è¾‘");return}h.value="ç¼–è¾‘åˆ†ç»„",x.value=!0,Object.assign(o,t),f.value=!0},O=async t=>{if(!b.value){i.warning("åªæœ‰è¶…çº§ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤åˆ†ç»„");return}if(t.parentId===0||t.parentId===null){i.warning("æ€»åˆ†ç»„ä¸å…è®¸åˆ é™¤");return}const e=r.value.some(d=>d.parentId===t.id);let s=`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ã€Œ${t.name}ã€å—ï¼Ÿ`;e&&(s=`åˆ†ç»„ã€Œ${t.name}ã€ä¸‹è¿˜æœ‰å­åˆ†ç»„ï¼Œåˆ é™¤åæ‰€æœ‰å­åˆ†ç»„ä¹Ÿå°†è¢«åˆ é™¤ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`);try{await le.confirm(s,"åˆ é™¤ç¡®è®¤",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"}),await oe({id:t.id}),await V(),i.success("åˆ†ç»„åˆ é™¤æˆåŠŸ"),n.value===t.id&&(n.value=null)}catch(d){d!=="cancel"&&i.error(d.message||"åˆ é™¤å¤±è´¥")}},q=async()=>{I.value&&await I.value.validate(async t=>{if(t)try{if(x.value)await ne({id:o.id,groupName:o.name,parentId:o.parentId,description:o.desc}),i.success("åˆ†ç»„ä¿®æ”¹æˆåŠŸ");else{const e=r.value.find(s=>s.parentId===0||s.parentId===null);await se({groupName:o.name,parentId:e?e.id:0,description:o.desc}),console.log("åˆ›å»ºåˆ†ç»„å‚æ•°:",{groupName:o.name,parentId:e?e.id:0,description:o.desc}),i.success("åˆ†ç»„åˆ›å»ºæˆåŠŸ")}await V(),f.value=!1}catch(e){console.error("ä¿å­˜åˆ†ç»„å¤±è´¥:",e),i.error(e.message||"æ“ä½œå¤±è´¥")}})},V=async()=>{try{_.value=!0;const t=await ae();if(r.value=ue(t.tree||[]),console.log("=== åˆ†ç»„æ•°æ®åŠ è½½ ===",r.value),console.log("é¡¶çº§åˆ†ç»„ (parentId=0):",r.value.filter(e=>e.parentId===0)),r.value.length>0&&!n.value){const e=r.value.find(s=>s.parentId===0);e&&(n.value=e.id,await k())}}catch(t){i.error(t.message||"åŠ è½½åˆ†ç»„å¤±è´¥")}finally{_.value=!1}},k=async()=>{if(console.log("loadDevices è¢«è°ƒç”¨, currentGroupId:",n.value),!n.value){console.log("æ²¡æœ‰é€‰ä¸­åˆ†ç»„ï¼Œæ¸…ç©ºè®¾å¤‡åˆ—è¡¨"),v.value=[];return}try{_.value=!0,console.log("å¼€å§‹åŠ è½½è®¾å¤‡ï¼ŒgroupId:",n.value);const t=await re({page:1,pageSize:100,groupId:n.value});console.log("è®¾å¤‡åˆ—è¡¨åŠ è½½æˆåŠŸ:",t),v.value=t.list||[],console.log("è®¾å¤‡æ•°é‡:",v.value.length)}catch(t){console.error("åŠ è½½è®¾å¤‡å¤±è´¥:",t),v.value=[]}finally{_.value=!1}},A=()=>{var e;const t=r.value.find(s=>s.parentId===0||s.parentId===null);Object.assign(o,{id:null,name:"",parentId:t?t.id:0,desc:""}),(e=I.value)==null||e.clearValidate()};return Q(()=>{const t=localStorage.getItem("userInfo");t&&(D.value=JSON.parse(t)),V(),k()}),(t,e)=>{const s=u("el-icon"),d=u("el-button"),R=u("el-tooltip"),B=u("el-card"),g=u("el-table-column"),J=u("el-tag"),Y=u("el-table"),C=u("el-input"),N=u("el-form-item"),Z=u("el-form"),H=u("el-dialog"),K=W("loading");return G(),X("div",de,[m("div",ce,[l(B,{class:"tree-panel",shadow:"hover"},{header:a(()=>[m("div",pe,[e[6]||(e[6]=m("span",{class:"font-semibold"},"åˆ†ç»„æ ‘",-1)),b.value?(G(),T(d,{key:0,type:"primary",size:"small",onClick:$},{default:a(()=>[l(s,null,{default:a(()=>[l(E(S))]),_:1}),e[4]||(e[4]=y(" æ–°å»º ",-1))]),_:1})):(G(),T(R,{key:1,content:"åªæœ‰è¶…çº§ç®¡ç†å‘˜æ‰èƒ½åˆ›å»ºåˆ†ç»„",placement:"top"},{default:a(()=>[l(d,{type:"primary",size:"small",disabled:""},{default:a(()=>[l(s,null,{default:a(()=>[l(E(S))]),_:1}),e[5]||(e[5]=y(" æ–°å»º ",-1))]),_:1})]),_:1}))])]),default:a(()=>[l(ie,{groups:r.value,"current-group-id":n.value,"show-actions":!0,onSelect:F,onEdit:L,onDelete:O},null,8,["groups","current-group-id"])]),_:1}),l(B,{class:"device-panel",shadow:"hover"},{header:a(()=>[m("div",ve,[m("span",me,M(j.value),1)])]),default:a(()=>[ee((G(),T(Y,{data:z.value,stripe:""},{default:a(()=>[l(g,{prop:"deviceName",label:"è®¾å¤‡åç§°","min-width":"150"}),l(g,{prop:"deviceCode",label:"è®¾å¤‡ç¼–ç ","min-width":"150"}),l(g,{prop:"productName",label:"äº§å“ç±»å‹","min-width":"120"}),l(g,{prop:"groupName",label:"æ‰€å±åˆ†ç»„","min-width":"120"}),l(g,{prop:"status",label:"çŠ¶æ€",width:"100"},{default:a(({row:c})=>[l(J,{type:c.status===1?"success":"info",size:"small"},{default:a(()=>[y(M(c.status===1?"åœ¨çº¿":"ç¦»çº¿"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])),[[K,_.value]])]),_:1})]),l(H,{modelValue:f.value,"onUpdate:modelValue":e[3]||(e[3]=c=>f.value=c),title:h.value,width:"600px",onClose:A},{footer:a(()=>[l(d,{onClick:e[2]||(e[2]=c=>f.value=!1)},{default:a(()=>[...e[9]||(e[9]=[y("å–æ¶ˆ",-1)])]),_:1}),l(d,{type:"primary",onClick:q},{default:a(()=>[...e[10]||(e[10]=[y("ç¡®å®š",-1)])]),_:1})]),default:a(()=>[l(Z,{ref_key:"groupFormRef",ref:I,model:o,rules:U,"label-width":"100px"},{default:a(()=>[l(N,{label:"åˆ†ç»„åç§°",prop:"name"},{default:a(()=>[l(C,{modelValue:o.name,"onUpdate:modelValue":e[0]||(e[0]=c=>o.name=c),placeholder:"å¦‚ï¼šåŠå…¬åŒºåŸŸã€ç”Ÿäº§è½¦é—´ã€Aæ ‹1æ¥¼"},null,8,["modelValue"]),e[7]||(e[7]=m("div",{class:"form-hint"},"ğŸ’¡ åŒä¸€çˆ¶åˆ†ç»„ä¸‹åç§°å¿…é¡»å”¯ä¸€ï¼Œä½†ä¸åŒçˆ¶åˆ†ç»„ä¸‹å¯ä»¥æœ‰åŒåå­åˆ†ç»„",-1))]),_:1}),l(N,{label:"çˆ¶çº§åˆ†ç»„"},{default:a(()=>[l(C,{value:"æ€»åˆ†ç»„",disabled:""}),e[8]||(e[8]=m("div",{class:"form-hint"},"ğŸ’¡ æ‰€æœ‰åˆ†ç»„éƒ½å±äºæ€»åˆ†ç»„ï¼Œæš‚ä¸æ”¯æŒå¤šçº§åµŒå¥—",-1))]),_:1}),l(N,{label:"åˆ†ç»„æè¿°"},{default:a(()=>[l(C,{modelValue:o.desc,"onUpdate:modelValue":e[1]||(e[1]=c=>o.desc=c),type:"textarea",rows:3,placeholder:"æè¿°è¯¥åˆ†ç»„çš„ç”¨é€”ã€èŒƒå›´ç­‰..."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},be=P(fe,[["__scopeId","data-v-fa064a67"]]);export{be as default};
