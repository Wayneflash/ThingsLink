import{_ as pe,a as fe,Z as ge,ag as _e,a3 as ye,E as U,r as u,a0 as he,o as p,c as I,b as i,t as v,e as l,w as n,g as m,i as q,M as Z,q as _,D as be,y as we,k as D,ac as ke,F as Se,d as Ie,a1 as Ve}from"./index-98982554.js";import{g as G,a as Ce,h as Le}from"./alarm-f89a989d.js";import{g as xe}from"./user-3ffd49f6.js";const Te={class:"alarm-log-page"},Ue={class:"stats-cards"},De={class:"stat-card"},Ae={class:"stat-value"},ze={class:"stat-card pending"},Ne={class:"stat-value"},qe={class:"stat-card critical"},Me={class:"stat-value"},Re={class:"stat-card warning"},He={class:"stat-value"},$e={class:"stat-card info"},Ye={class:"stat-value"},Fe={class:"filter-bar"},Be={key:0},Ee={key:1,class:"handler-names"},Je={key:2,class:"empty-text"},Oe={key:1,class:"empty-text"},je={key:2,style:{color:"#909399"}},Pe={class:"pagination-container"},Ze={class:"detail-content"},Ge={class:"detail-item"},Ke={class:"detail-value"},Qe={class:"detail-item"},We={class:"detail-value"},Xe={class:"detail-item"},ea={class:"detail-value"},aa={key:0,class:"detail-item"},ta={class:"detail-images"},la=1e4,sa={__name:"AlarmLog",setup(na){const f=fe();let A=null;const C=m({total:0,unhandled:0,critical:0,warning:0,info:0}),L=m(!1),M=m(!1),$=m(null),k=m({description:"",images:[]}),z=m(!1),w=m({handler:"",handleTime:"",handleDescription:"",handleImages:[]}),c=m({deviceCode:"",alarmLevel:"",status:null}),y=m([]),d=m({page:1,pageSize:20,total:0}),S=m([]),x=m(!1),R=m(null),Y=m([]),K=async()=>{try{const t=await xe();t&&t.list&&(Y.value=t.list)}catch(t){console.error("加载用户列表失败:",t)}},H=async()=>{try{const t=await Ce();t&&(C.value=t)}catch(t){console.error("加载统计数据失败:",t)}},V=async()=>{var t,e;x.value=!0;try{const s={page:d.value.page,pageSize:d.value.pageSize,deviceCode:c.value.deviceCode||void 0,alarmLevel:c.value.alarmLevel||void 0,status:c.value.status!==null?c.value.status:void 0,startTime:y.value&&y.value[0]?y.value[0]:void 0,endTime:y.value&&y.value[1]?y.value[1]:void 0},o=await G(s);o?(S.value=o.list||[],d.value.total=o.total||0):(S.value=[],d.value.total=0)}catch(s){console.error("加载报警日志失败:",s);const o=((e=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:e.message)||(s==null?void 0:s.message)||"加载报警日志失败";U.error(o),S.value=[],d.value.total=0}finally{x.value=!1}},Q=async t=>{$.value=t.id,k.value={description:"",images:[]},L.value=!0},W=async()=>{var t,e;try{M.value=!0;const s=[];for(const r of k.value.images)if(r.raw){const g=await X(r.raw);s.push(g)}else r.url&&s.push(r.url);await Le({alarmId:$.value,handleDescription:k.value.description,handleImages:s})!==void 0&&(U.success("处理成功"),L.value=!1,await V(),await H())}catch(s){console.error("处理报警失败:",s);const o=((e=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:e.message)||(s==null?void 0:s.message)||"处理失败";U.error(o)}finally{M.value=!1}},X=t=>new Promise((e,s)=>{const o=new FileReader;o.readAsDataURL(t),o.onload=()=>e(o.result),o.onerror=r=>s(r)}),F=t=>{if(t.status!==0||!t.notifyUsers)return"";try{return JSON.parse(t.notifyUsers).map(o=>{const r=Y.value.find(g=>g.id===o);return r?r.realName||r.username:""}).filter(o=>o).join("、")||"-"}catch(e){return console.error("解析处理人失败:",e),"-"}},ee=t=>{var e;if(t.status!==0||!t.notifyUsers)return!1;try{const s=(e=JSON.parse(localStorage.getItem("userInfo")))==null?void 0:e.id;return s?JSON.parse(t.notifyUsers).includes(s):!1}catch(s){return console.error("判断处理人失败:",s),!1}},ae=t=>{if(w.value={handler:t.handler||"-",handleTime:t.handleTime||"-",handleDescription:t.handleDescription||"",handleImages:[]},t.handleImages)try{const e=JSON.parse(t.handleImages);w.value.handleImages=Array.isArray(e)?e:[]}catch(e){console.error("解析处理图片失败:",e)}z.value=!0},te=()=>{c.value={deviceCode:"",alarmLevel:"",status:null},y.value=[],d.value.page=1,V()},le=t=>({critical:"danger",warning:"warning",info:"info"})[t]||"info",se=t=>({critical:"严重",warning:"警告",info:"提示"})[t]||"未知",B=t=>{if(!t)return"-";const e=new Date(t);if(isNaN(e.getTime()))return"-";const s=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),g=String(e.getHours()).padStart(2,"0"),T=String(e.getMinutes()).padStart(2,"0"),h=String(e.getSeconds()).padStart(2,"0");return`${s}-${o}-${r} ${g}:${T}:${h}`};ge(async()=>{await K(),await H();const t=f.query.alarmId;t?await oe(t):(f.query.startTime&&f.query.endTime&&(y.value=[f.query.startTime,f.query.endTime]),f.query.status!==void 0&&(c.value.status=Number(f.query.status)),f.query.alarmLevel&&(c.value.alarmLevel=f.query.alarmLevel),f.query.deviceCode&&(c.value.deviceCode=f.query.deviceCode),await V()),ne()}),_e(()=>{E()});const ne=()=>{E(),A=setInterval(()=>{f.query.alarmId||(V(),H())},la)},E=()=>{A&&(clearInterval(A),A=null)},oe=async t=>{var e,s;x.value=!0;try{const r=await G({page:1,pageSize:1e3});if(r&&r.list){const g=r.list.find(T=>T.id===Number(t));g?(S.value=[g],d.value.total=1,d.value.page=1,d.value.pageSize=20,await ye(),R.value&&R.value.setCurrentRow(g)):(S.value=[],d.value.total=0,U.warning("未找到该报警记录"))}else S.value=[],d.value.total=0}catch(o){console.error("加载报警记录失败:",o);const r=((s=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:s.message)||(o==null?void 0:o.message)||"加载报警记录失败";U.error(r),S.value=[],d.value.total=0}finally{x.value=!1}};return(t,e)=>{const s=u("el-icon"),o=u("el-input"),r=u("el-option"),g=u("el-select"),T=u("el-date-picker"),h=u("el-button"),J=u("el-card"),b=u("el-table-column"),O=u("el-tag"),ie=u("el-tooltip"),re=u("el-table"),de=u("el-pagination"),j=u("el-form-item"),ue=u("el-upload"),ce=u("el-form"),P=u("el-dialog"),ve=u("el-image"),me=he("loading");return p(),I("div",Te,[i("div",Ue,[i("div",De,[e[12]||(e[12]=i("div",{class:"stat-label"},"总报警数",-1)),i("div",Ae,v(C.value.total||0),1)]),i("div",ze,[e[13]||(e[13]=i("div",{class:"stat-label"},"未处理",-1)),i("div",Ne,v(C.value.unhandled||0),1)]),i("div",qe,[e[14]||(e[14]=i("div",{class:"stat-label"},"严重报警",-1)),i("div",Me,v(C.value.critical||0),1)]),i("div",Re,[e[15]||(e[15]=i("div",{class:"stat-label"},"警告",-1)),i("div",He,v(C.value.warning||0),1)]),i("div",$e,[e[16]||(e[16]=i("div",{class:"stat-label"},"提示",-1)),i("div",Ye,v(C.value.info||0),1)])]),l(J,{class:"filter-card"},{default:n(()=>[i("div",Fe,[l(o,{modelValue:c.value.deviceCode,"onUpdate:modelValue":e[0]||(e[0]=a=>c.value.deviceCode=a),placeholder:"搜索设备编码/设备名称",class:"search-input",clearable:"",style:{width:"250px"}},{prefix:n(()=>[l(s,null,{default:n(()=>[l(q(Z))]),_:1})]),_:1},8,["modelValue"]),l(g,{modelValue:c.value.alarmLevel,"onUpdate:modelValue":e[1]||(e[1]=a=>c.value.alarmLevel=a),placeholder:"报警级别",clearable:"",style:{width:"150px"}},{default:n(()=>[l(r,{label:"严重",value:"critical"}),l(r,{label:"警告",value:"warning"}),l(r,{label:"提示",value:"info"})]),_:1},8,["modelValue"]),l(g,{modelValue:c.value.status,"onUpdate:modelValue":e[2]||(e[2]=a=>c.value.status=a),placeholder:"处理状态",clearable:"",style:{width:"150px"}},{default:n(()=>[l(r,{label:"未处理",value:0}),l(r,{label:"已处理",value:1})]),_:1},8,["modelValue"]),l(T,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=a=>y.value=a),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"380px"}},null,8,["modelValue"]),l(h,{type:"primary",onClick:V},{default:n(()=>[l(s,null,{default:n(()=>[l(q(Z))]),_:1}),e[17]||(e[17]=_(" 查询 ",-1))]),_:1}),l(h,{onClick:te},{default:n(()=>[l(s,null,{default:n(()=>[l(q(be))]),_:1}),e[18]||(e[18]=_(" 重置 ",-1))]),_:1})])]),_:1}),l(J,{class:"table-card"},{default:n(()=>[we((p(),D(re,{ref_key:"alarmTableRef",ref:R,data:S.value,border:"",stripe:"","row-key":"id","highlight-current-row":""},{default:n(()=>[l(b,{prop:"deviceName",label:"设备名称",width:"180"}),l(b,{prop:"deviceCode",label:"设备编码",width:"140"}),l(b,{label:"报警级别",width:"100",align:"center"},{default:n(({row:a})=>[l(O,{type:le(a.alarmLevel),effect:"dark"},{default:n(()=>[_(v(se(a.alarmLevel)),1)]),_:2},1032,["type"])]),_:1}),l(b,{prop:"alarmMessage",label:"报警内容","min-width":"180","show-overflow-tooltip":""}),l(b,{prop:"triggerTime",label:"触发时间",width:"170"},{default:n(({row:a})=>[_(v(B(a.triggerTime)),1)]),_:1}),l(b,{label:"处理状态",width:"90",align:"center"},{default:n(({row:a})=>[l(O,{type:a.status===0?"warning":"success"},{default:n(()=>[_(v(a.status===0?"未处理":"已处理"),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"处理人",width:"110"},{default:n(({row:a})=>[a.status===1&&a.handler?(p(),I("span",Be,v(a.handler),1)):a.status===0&&F(a)?(p(),I("span",Ee,v(F(a)),1)):(p(),I("span",Je,"-"))]),_:1}),l(b,{label:"处理详情",width:"90",align:"center"},{default:n(({row:a})=>[a.status===1&&(a.handleDescription||a.handleImages)?(p(),D(h,{key:0,size:"small",type:"info",link:"",onClick:N=>ae(a)},{default:n(()=>[...e[19]||(e[19]=[_(" 查看 ",-1)])]),_:1},8,["onClick"])):(p(),I("span",Oe,"-"))]),_:1}),l(b,{prop:"handleTime",label:"处理时间",width:"170"},{default:n(({row:a})=>[_(v(B(a.handleTime)),1)]),_:1}),l(b,{label:"操作",width:"100",fixed:"right",align:"center"},{default:n(({row:a})=>[a.status===0&&!ee(a)?(p(),D(ie,{key:0,content:"只有配置的处理人才能操作",placement:"top"},{default:n(()=>[i("span",null,[l(h,{size:"small",type:"primary",disabled:""},{default:n(()=>[...e[20]||(e[20]=[_(" 处理 ",-1)])]),_:1})])]),_:1})):a.status===0?(p(),D(h,{key:1,size:"small",type:"primary",onClick:N=>Q(a)},{default:n(()=>[...e[21]||(e[21]=[_(" 处理 ",-1)])]),_:1},8,["onClick"])):(p(),I("span",je,"已处理"))]),_:1})]),_:1},8,["data"])),[[me,x.value]]),i("div",Pe,[l(de,{"current-page":d.value.page,"onUpdate:currentPage":e[4]||(e[4]=a=>d.value.page=a),"page-size":d.value.pageSize,"onUpdate:pageSize":e[5]||(e[5]=a=>d.value.pageSize=a),total:d.value.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:V,onCurrentChange:V},null,8,["current-page","page-size","total"])])]),_:1}),l(P,{modelValue:L.value,"onUpdate:modelValue":e[9]||(e[9]=a=>L.value=a),title:"处理报警",width:"600px","close-on-click-modal":!1},{footer:n(()=>[l(h,{onClick:e[8]||(e[8]=a=>L.value=!1)},{default:n(()=>[...e[23]||(e[23]=[_("取消",-1)])]),_:1}),l(h,{type:"primary",onClick:W,loading:M.value},{default:n(()=>[...e[24]||(e[24]=[_("确认处理",-1)])]),_:1},8,["loading"])]),default:n(()=>[l(ce,{model:k.value,"label-width":"100px"},{default:n(()=>[l(j,{label:"处理描述"},{default:n(()=>[l(o,{modelValue:k.value.description,"onUpdate:modelValue":e[6]||(e[6]=a=>k.value.description=a),type:"textarea",rows:4,placeholder:"请描述处理方式和结果",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(j,{label:"上传图片"},{default:n(()=>[l(ue,{"file-list":k.value.images,"onUpdate:fileList":e[7]||(e[7]=a=>k.value.images=a),action:"#","list-type":"picture-card","auto-upload":!1,limit:5,accept:"image/*"},{tip:n(()=>[...e[22]||(e[22]=[i("div",{class:"el-upload__tip"},"支持jpg/png格式，最多5张",-1)])]),default:n(()=>[l(s,null,{default:n(()=>[l(q(ke))]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(P,{modelValue:z.value,"onUpdate:modelValue":e[11]||(e[11]=a=>z.value=a),title:"处理详情",width:"600px"},{footer:n(()=>[l(h,{onClick:e[10]||(e[10]=a=>z.value=!1)},{default:n(()=>[...e[29]||(e[29]=[_("关闭",-1)])]),_:1})]),default:n(()=>[i("div",Ze,[i("div",Ge,[e[25]||(e[25]=i("div",{class:"detail-label"},"处理人：",-1)),i("div",Ke,v(w.value.handler||"-"),1)]),i("div",Qe,[e[26]||(e[26]=i("div",{class:"detail-label"},"处理时间：",-1)),i("div",We,v(w.value.handleTime||"-"),1)]),i("div",Xe,[e[27]||(e[27]=i("div",{class:"detail-label"},"处理描述：",-1)),i("div",ea,v(w.value.handleDescription||"未填写"),1)]),w.value.handleImages&&w.value.handleImages.length>0?(p(),I("div",aa,[e[28]||(e[28]=i("div",{class:"detail-label"},"处理图片：",-1)),i("div",ta,[(p(!0),I(Se,null,Ie(w.value.handleImages,(a,N)=>(p(),D(ve,{key:N,src:a,"preview-src-list":w.value.handleImages,"initial-index":N,fit:"cover",class:"detail-image"},null,8,["src","preview-src-list","initial-index"]))),128))])])):Ve("",!0)])]),_:1},8,["modelValue"])])}}},da=pe(sa,[["__scopeId","data-v-2ff2e849"]]);export{da as default};
