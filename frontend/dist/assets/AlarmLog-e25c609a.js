import{_ as ve,a as fe,b as c,v as ge,R as _e,D as ye,E as U,d as u,y as he,o as m,e as I,f as i,t as p,g as l,w as n,i as N,J as K,q as f,K as be,B as we,I as D,L as ke,F as Ie,C as Se,A as Ve}from"./index-6eb9f70f.js";import{g as G,a as xe,h as Ce}from"./alarm-66ba42c2.js";import{g as Le}from"./user-2ef6f979.js";const Ue={class:"alarm-log-page"},De={class:"stats-cards"},Te={class:"stat-card"},Ae={class:"stat-value"},ze={class:"stat-card pending"},Ne={class:"stat-value"},Re={class:"stat-card critical"},Me={class:"stat-value"},He={class:"stat-card warning"},$e={class:"stat-value"},Ye={class:"stat-card info"},Be={class:"stat-value"},Fe={class:"filter-bar"},Ee={key:0},Je={key:1,class:"handler-names"},Oe={key:2,class:"empty-text"},je={key:1,class:"empty-text"},qe={key:2,style:{color:"#909399"}},Pe={class:"pagination-container"},Ke={class:"detail-content"},Ge={class:"detail-item"},Qe={class:"detail-value"},We={class:"detail-item"},Xe={class:"detail-value"},Ze={class:"detail-item"},ea={class:"detail-value"},aa={key:0,class:"detail-item"},ta={class:"detail-images"},la=1e4,sa={__name:"AlarmLog",setup(na){const $=fe();let T=null;const V=c({total:0,unhandled:0,critical:0,warning:0,info:0}),x=c(!1),R=c(!1),Y=c(null),w=c({description:"",images:[]}),A=c(!1),h=c({handler:"",handleTime:"",handleDescription:"",handleImages:[]}),g=c({deviceCode:"",alarmLevel:"",status:null}),b=c([]),d=c({page:1,pageSize:20,total:0}),k=c([]),C=c(!1),M=c(null),B=c([]),Q=async()=>{try{const t=await Le();t&&t.list&&(B.value=t.list)}catch(t){console.error("加载用户列表失败:",t)}},H=async()=>{try{const t=await xe();t&&(V.value=t)}catch(t){console.error("加载统计数据失败:",t)}},S=async()=>{var t,e;C.value=!0;try{const s={page:d.value.page,pageSize:d.value.pageSize,deviceCode:g.value.deviceCode||void 0,alarmLevel:g.value.alarmLevel||void 0,status:g.value.status!==null?g.value.status:void 0,startTime:b.value&&b.value[0]?b.value[0]:void 0,endTime:b.value&&b.value[1]?b.value[1]:void 0},o=await G(s);o?(k.value=o.list||[],d.value.total=o.total||0):(k.value=[],d.value.total=0)}catch(s){console.error("加载报警日志失败:",s);const o=((e=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:e.message)||(s==null?void 0:s.message)||"加载报警日志失败";U.error(o),k.value=[],d.value.total=0}finally{C.value=!1}},W=async t=>{Y.value=t.id,w.value={description:"",images:[]},x.value=!0},X=async()=>{var t,e;try{R.value=!0;const s=[];for(const r of w.value.images)if(r.raw){const v=await Z(r.raw);s.push(v)}else r.url&&s.push(r.url);await Ce({alarmId:Y.value,handleDescription:w.value.description,handleImages:s})!==void 0&&(U.success("处理成功"),x.value=!1,await S(),await H())}catch(s){console.error("处理报警失败:",s);const o=((e=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:e.message)||(s==null?void 0:s.message)||"处理失败";U.error(o)}finally{R.value=!1}},Z=t=>new Promise((e,s)=>{const o=new FileReader;o.readAsDataURL(t),o.onload=()=>e(o.result),o.onerror=r=>s(r)}),F=t=>{if(t.status!==0||!t.notifyUsers)return"";try{return JSON.parse(t.notifyUsers).map(o=>{const r=B.value.find(v=>v.id===o);return r?r.realName||r.username:""}).filter(o=>o).join("、")||"-"}catch(e){return console.error("解析处理人失败:",e),"-"}},ee=t=>{var e;if(t.status!==0||!t.notifyUsers)return!1;try{const s=(e=JSON.parse(localStorage.getItem("userInfo")))==null?void 0:e.id;return s?JSON.parse(t.notifyUsers).includes(s):!1}catch(s){return console.error("判断处理人失败:",s),!1}},ae=t=>{if(h.value={handler:t.handler||"-",handleTime:t.handleTime||"-",handleDescription:t.handleDescription||"",handleImages:[]},t.handleImages)try{const e=JSON.parse(t.handleImages);h.value.handleImages=Array.isArray(e)?e:[]}catch(e){console.error("解析处理图片失败:",e)}A.value=!0},te=()=>{g.value={deviceCode:"",alarmLevel:"",status:null},b.value=[],d.value.page=1,S()},le=t=>({critical:"danger",warning:"warning",info:"info"})[t]||"info",se=t=>({critical:"严重",warning:"警告",info:"提示"})[t]||"未知",E=t=>{if(!t)return"-";const e=new Date(t);if(isNaN(e.getTime()))return"-";const s=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),v=String(e.getHours()).padStart(2,"0"),L=String(e.getMinutes()).padStart(2,"0"),_=String(e.getSeconds()).padStart(2,"0");return`${s}-${o}-${r} ${v}:${L}:${_}`};ge(async()=>{await Q(),await H();const t=$.query.alarmId;t?await oe(t):await S(),ne()}),_e(()=>{J()});const ne=()=>{J(),T=setInterval(()=>{$.query.alarmId||(S(),H())},la)},J=()=>{T&&(clearInterval(T),T=null)},oe=async t=>{var e,s;C.value=!0;try{const r=await G({page:1,pageSize:1e3});if(r&&r.list){const v=r.list.find(L=>L.id===Number(t));v?(k.value=[v],d.value.total=1,d.value.page=1,d.value.pageSize=20,await ye(),M.value&&M.value.setCurrentRow(v)):(k.value=[],d.value.total=0,U.warning("未找到该报警记录"))}else k.value=[],d.value.total=0}catch(o){console.error("加载报警记录失败:",o);const r=((s=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:s.message)||(o==null?void 0:o.message)||"加载报警记录失败";U.error(r),k.value=[],d.value.total=0}finally{C.value=!1}};return(t,e)=>{const s=u("el-icon"),o=u("el-input"),r=u("el-option"),v=u("el-select"),L=u("el-date-picker"),_=u("el-button"),O=u("el-card"),y=u("el-table-column"),j=u("el-tag"),ie=u("el-tooltip"),re=u("el-table"),de=u("el-pagination"),q=u("el-form-item"),ue=u("el-upload"),ce=u("el-form"),P=u("el-dialog"),pe=u("el-image"),me=he("loading");return m(),I("div",Ue,[i("div",De,[i("div",Te,[e[12]||(e[12]=i("div",{class:"stat-label"},"总报警数",-1)),i("div",Ae,p(V.value.total||0),1)]),i("div",ze,[e[13]||(e[13]=i("div",{class:"stat-label"},"未处理",-1)),i("div",Ne,p(V.value.unhandled||0),1)]),i("div",Re,[e[14]||(e[14]=i("div",{class:"stat-label"},"严重报警",-1)),i("div",Me,p(V.value.critical||0),1)]),i("div",He,[e[15]||(e[15]=i("div",{class:"stat-label"},"警告",-1)),i("div",$e,p(V.value.warning||0),1)]),i("div",Ye,[e[16]||(e[16]=i("div",{class:"stat-label"},"提示",-1)),i("div",Be,p(V.value.info||0),1)])]),l(O,{class:"filter-card"},{default:n(()=>[i("div",Fe,[l(o,{modelValue:g.value.deviceCode,"onUpdate:modelValue":e[0]||(e[0]=a=>g.value.deviceCode=a),placeholder:"搜索设备编码/设备名称",class:"search-input",clearable:"",style:{width:"250px"}},{prefix:n(()=>[l(s,null,{default:n(()=>[l(N(K))]),_:1})]),_:1},8,["modelValue"]),l(v,{modelValue:g.value.alarmLevel,"onUpdate:modelValue":e[1]||(e[1]=a=>g.value.alarmLevel=a),placeholder:"报警级别",clearable:"",style:{width:"150px"}},{default:n(()=>[l(r,{label:"严重",value:"critical"}),l(r,{label:"警告",value:"warning"}),l(r,{label:"提示",value:"info"})]),_:1},8,["modelValue"]),l(v,{modelValue:g.value.status,"onUpdate:modelValue":e[2]||(e[2]=a=>g.value.status=a),placeholder:"处理状态",clearable:"",style:{width:"150px"}},{default:n(()=>[l(r,{label:"未处理",value:0}),l(r,{label:"已处理",value:1})]),_:1},8,["modelValue"]),l(L,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=a=>b.value=a),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"380px"}},null,8,["modelValue"]),l(_,{type:"primary",onClick:S},{default:n(()=>[l(s,null,{default:n(()=>[l(N(K))]),_:1}),e[17]||(e[17]=f(" 查询 ",-1))]),_:1}),l(_,{onClick:te},{default:n(()=>[l(s,null,{default:n(()=>[l(N(be))]),_:1}),e[18]||(e[18]=f(" 重置 ",-1))]),_:1})])]),_:1}),l(O,{class:"table-card"},{default:n(()=>[we((m(),D(re,{ref_key:"alarmTableRef",ref:M,data:k.value,border:"",stripe:"","row-key":"id","highlight-current-row":""},{default:n(()=>[l(y,{prop:"deviceName",label:"设备名称",width:"180"}),l(y,{prop:"deviceCode",label:"设备编码",width:"140"}),l(y,{label:"报警级别",width:"100",align:"center"},{default:n(({row:a})=>[l(j,{type:le(a.alarmLevel),effect:"dark"},{default:n(()=>[f(p(se(a.alarmLevel)),1)]),_:2},1032,["type"])]),_:1}),l(y,{prop:"alarmMessage",label:"报警内容","min-width":"180","show-overflow-tooltip":""}),l(y,{prop:"triggerTime",label:"触发时间",width:"170"},{default:n(({row:a})=>[f(p(E(a.triggerTime)),1)]),_:1}),l(y,{label:"处理状态",width:"90",align:"center"},{default:n(({row:a})=>[l(j,{type:a.status===0?"warning":"success"},{default:n(()=>[f(p(a.status===0?"未处理":"已处理"),1)]),_:2},1032,["type"])]),_:1}),l(y,{label:"处理人",width:"110"},{default:n(({row:a})=>[a.status===1&&a.handler?(m(),I("span",Ee,p(a.handler),1)):a.status===0&&F(a)?(m(),I("span",Je,p(F(a)),1)):(m(),I("span",Oe,"-"))]),_:1}),l(y,{label:"处理详情",width:"90",align:"center"},{default:n(({row:a})=>[a.status===1&&(a.handleDescription||a.handleImages)?(m(),D(_,{key:0,size:"small",type:"info",link:"",onClick:z=>ae(a)},{default:n(()=>[...e[19]||(e[19]=[f(" 查看 ",-1)])]),_:1},8,["onClick"])):(m(),I("span",je,"-"))]),_:1}),l(y,{prop:"handleTime",label:"处理时间",width:"170"},{default:n(({row:a})=>[f(p(E(a.handleTime)),1)]),_:1}),l(y,{label:"操作",width:"100",fixed:"right",align:"center"},{default:n(({row:a})=>[a.status===0&&!ee(a)?(m(),D(ie,{key:0,content:"只有配置的处理人才能操作",placement:"top"},{default:n(()=>[i("span",null,[l(_,{size:"small",type:"primary",disabled:""},{default:n(()=>[...e[20]||(e[20]=[f(" 处理 ",-1)])]),_:1})])]),_:1})):a.status===0?(m(),D(_,{key:1,size:"small",type:"primary",onClick:z=>W(a)},{default:n(()=>[...e[21]||(e[21]=[f(" 处理 ",-1)])]),_:1},8,["onClick"])):(m(),I("span",qe,"已处理"))]),_:1})]),_:1},8,["data"])),[[me,C.value]]),i("div",Pe,[l(de,{"current-page":d.value.page,"onUpdate:currentPage":e[4]||(e[4]=a=>d.value.page=a),"page-size":d.value.pageSize,"onUpdate:pageSize":e[5]||(e[5]=a=>d.value.pageSize=a),total:d.value.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:S,onCurrentChange:S},null,8,["current-page","page-size","total"])])]),_:1}),l(P,{modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=a=>x.value=a),title:"处理报警",width:"600px","close-on-click-modal":!1},{footer:n(()=>[l(_,{onClick:e[8]||(e[8]=a=>x.value=!1)},{default:n(()=>[...e[23]||(e[23]=[f("取消",-1)])]),_:1}),l(_,{type:"primary",onClick:X,loading:R.value},{default:n(()=>[...e[24]||(e[24]=[f("确认处理",-1)])]),_:1},8,["loading"])]),default:n(()=>[l(ce,{model:w.value,"label-width":"100px"},{default:n(()=>[l(q,{label:"处理描述"},{default:n(()=>[l(o,{modelValue:w.value.description,"onUpdate:modelValue":e[6]||(e[6]=a=>w.value.description=a),type:"textarea",rows:4,placeholder:"请描述处理方式和结果",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(q,{label:"上传图片"},{default:n(()=>[l(ue,{"file-list":w.value.images,"onUpdate:fileList":e[7]||(e[7]=a=>w.value.images=a),action:"#","list-type":"picture-card","auto-upload":!1,limit:5,accept:"image/*"},{tip:n(()=>[...e[22]||(e[22]=[i("div",{class:"el-upload__tip"},"支持jpg/png格式，最多5张",-1)])]),default:n(()=>[l(s,null,{default:n(()=>[l(N(ke))]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(P,{modelValue:A.value,"onUpdate:modelValue":e[11]||(e[11]=a=>A.value=a),title:"处理详情",width:"600px"},{footer:n(()=>[l(_,{onClick:e[10]||(e[10]=a=>A.value=!1)},{default:n(()=>[...e[29]||(e[29]=[f("关闭",-1)])]),_:1})]),default:n(()=>[i("div",Ke,[i("div",Ge,[e[25]||(e[25]=i("div",{class:"detail-label"},"处理人：",-1)),i("div",Qe,p(h.value.handler||"-"),1)]),i("div",We,[e[26]||(e[26]=i("div",{class:"detail-label"},"处理时间：",-1)),i("div",Xe,p(h.value.handleTime||"-"),1)]),i("div",Ze,[e[27]||(e[27]=i("div",{class:"detail-label"},"处理描述：",-1)),i("div",ea,p(h.value.handleDescription||"未填写"),1)]),h.value.handleImages&&h.value.handleImages.length>0?(m(),I("div",aa,[e[28]||(e[28]=i("div",{class:"detail-label"},"处理图片：",-1)),i("div",ta,[(m(!0),I(Ie,null,Se(h.value.handleImages,(a,z)=>(m(),D(pe,{key:z,src:a,"preview-src-list":h.value.handleImages,"initial-index":z,fit:"cover",class:"detail-image"},null,8,["src","preview-src-list","initial-index"]))),128))])])):Ve("",!0)])]),_:1},8,["modelValue"])])}}},da=ve(sa,[["__scopeId","data-v-288efd08"]]);export{da as default};
