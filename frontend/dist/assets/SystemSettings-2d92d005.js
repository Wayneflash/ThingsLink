import{_ as F,b as _,c as C,v as A,d as u,o as Z,e as N,f as e,g as s,w as l,E as q,i as T,p as $,q as i,S as V,T as U,t as p,M as c}from"./index-df07b552.js";import{a as j,u as G,b as H}from"./system-2a4cfd92.js";const J={class:"system-settings-page"},K={class:"page-header"},L={class:"admin-badge"},O={class:"card-header"},W={class:"form-actions"},X={class:"config-preview"},Y={class:"preview-content"},h={class:"preview-item"},tt={class:"preview-value"},et={class:"preview-item"},st={class:"preview-value"},rt={class:"card-header"},lt={class:"form-actions"},ot={class:"config-preview"},at={class:"preview-content"},nt={class:"preview-item"},mt={class:"preview-value"},it={class:"preview-item"},dt={class:"preview-value"},ut={class:"preview-item"},pt={class:"preview-value"},gt={__name:"SystemSettings",setup(ft){const M=_(null),P=_(null),v=_(!1),a=C({mqttBroker:"localhost",mqttPort:1883,mqttUsername:"admin",mqttPassword:"admin123."}),o=C({mqttBroker:"localhost",mqttPort:1883,mqttClientId:"iot-platform-server",mqttUsername:"admin",mqttPassword:"admin123."}),k={mqttBroker:[{required:!0,message:"MQTT地址不能为空",trigger:"blur"},{validator:(n,t,r)=>{t&&t.trim()?/^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}|(\d{1,3}\.){3}\d{1,3}$/.test(t.trim())?r():r(new Error("请输入有效的IP地址或域名")):r()},trigger:"blur"}],mqttPort:[{required:!0,message:"MQTT端口不能为空",trigger:"blur"},{type:"number",message:"端口必须是数字",trigger:"blur"},{validator:(n,t,r)=>{t&&(t<1||t>65535)?r(new Error("端口范围必须在1-65535之间")):r()},trigger:"blur"}],mqttUsername:[{required:!0,message:"用户名不能为空",trigger:"blur"},{min:1,max:50,message:"用户名长度在1-50个字符",trigger:"blur"}],mqttPassword:[{required:!0,message:"密码不能为空",trigger:"blur"},{min:1,max:50,message:"密码长度在1-50个字符",trigger:"blur"}],mqttClientId:[{required:!0,message:"Client ID不能为空",trigger:"blur"},{min:1,max:100,message:"Client ID长度在1-100个字符",trigger:"blur"}]},I={mqttBroker:[{required:!0,message:"MQTT地址不能为空",trigger:"blur"},{validator:(n,t,r)=>{t&&t.trim()?/^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}|(\d{1,3}\.){3}\d{1,3}$/.test(t.trim())?r():r(new Error("请输入有效的IP地址或域名")):r()},trigger:"blur"}],mqttPort:[{required:!0,message:"MQTT端口不能为空",trigger:"blur"},{type:"number",message:"端口必须是数字",trigger:"blur"},{validator:(n,t,r)=>{t&&(t<1||t>65535)?r(new Error("端口范围必须在1-65535之间")):r()},trigger:"blur"}],mqttUsername:[{required:!0,message:"用户名不能为空",trigger:"blur"},{min:1,max:50,message:"用户名长度在1-50个字符",trigger:"blur"}],mqttPassword:[{required:!0,message:"密码不能为空",trigger:"blur"},{min:1,max:50,message:"密码长度在1-50个字符",trigger:"blur"}],mqttClientId:[{required:!0,message:"Client ID不能为空",trigger:"blur"},{min:1,max:100,message:"Client ID长度在1-100个字符",trigger:"blur"}]},R=async()=>{try{const n=await j();if(n){if(n.mqttConfig){const t=n.mqttConfig;a.mqttBroker=t.broker||"localhost",a.mqttPort=t.port||1883,a.mqttUsername=t.username||"admin",a.mqttPassword=t.password||"admin123."}if(n.platformMqttConfig){const t=n.platformMqttConfig;o.mqttBroker=t.broker||"localhost",o.mqttPort=t.port||1883,o.mqttClientId=t.clientId||"iot-platform-server",o.mqttUsername=t.username||"admin",o.mqttPassword=t.password||"admin123."}}}catch(n){console.error("加载系统配置失败:",n),q.error("加载系统配置失败")}},S=async()=>{var n,t;try{await M.value.validate(),await c.confirm("确定要保存设备MQTT配置吗？此配置仅用于在设备详情页显示。","保存确认",{confirmButtonText:"确定保存",cancelButtonText:"取消",type:"warning"}),v.value=!0;const r={deviceMqttBroker:a.mqttBroker,deviceMqttPort:a.mqttPort,deviceMqttUsername:a.mqttUsername,deviceMqttPassword:a.mqttPassword};await G(r),q.success("设备MQTT配置保存成功！")}catch(r){if(r!=="cancel"){console.error("保存设备MQTT配置失败:",r);const g=((t=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:t.message)||(r==null?void 0:r.message)||"保存失败";q.error(g)}}finally{v.value=!1}},D=async()=>{try{await c.confirm("确定要重置为默认配置吗？","重置确认",{confirmButtonText:"确定重置",cancelButtonText:"取消",type:"warning"}),a.mqttBroker="localhost",a.mqttPort=1883,a.mqttUsername="admin",a.mqttPassword="admin123.",M.value.clearValidate(),q.success("已重置为默认配置")}catch{}},z=async()=>{var n,t;try{await P.value.validate(),await c.confirm("确定要保存平台MQTT配置吗？保存后MQTT连接会自动使用新配置重新连接。","保存确认",{confirmButtonText:"确定保存",cancelButtonText:"取消",type:"warning"}),v.value=!0;const r={platformMqttBroker:o.mqttBroker,platformMqttPort:o.mqttPort,platformMqttClientId:o.mqttClientId,platformMqttUsername:o.mqttUsername,platformMqttPassword:o.mqttPassword};await H(r),q.success("平台MQTT配置保存成功！MQTT连接已使用新配置重新连接")}catch(r){if(r!=="cancel"){console.error("保存平台MQTT配置失败:",r);const g=((t=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:t.message)||(r==null?void 0:r.message)||"保存失败";q.error(g)}}finally{v.value=!1}},E=async()=>{try{await c.confirm("确定要重置为默认配置吗？","重置确认",{confirmButtonText:"确定重置",cancelButtonText:"取消",type:"warning"}),o.mqttBroker="localhost",o.mqttPort=1883,o.mqttUsername="admin",o.mqttPassword="admin123.",P.value.clearValidate(),q.success("已重置为默认配置")}catch{}},b=n=>n?"*".repeat(Math.min(n.length,8)):"***";return A(()=>{R()}),(n,t)=>{const r=u("el-icon"),g=u("el-tag"),f=u("el-input"),d=u("el-form-item"),y=u("el-input-number"),w=u("el-button"),x=u("el-form"),Q=u("el-alert"),B=u("el-card");return Z(),N("div",J,[e("div",K,[t[10]||(t[10]=e("h2",{class:"page-title"},"⚙️ 系统设置",-1)),e("div",L,[s(r,null,{default:l(()=>[s(T($))]),_:1}),t[9]||(t[9]=e("span",null,"仅管理员可访问",-1))])]),s(B,{class:"settings-card"},{header:l(()=>[e("div",O,[t[12]||(t[12]=e("span",{class:"card-title"},"设备连接MQTT配置",-1)),s(g,{type:"info",size:"small"},{default:l(()=>[...t[11]||(t[11]=[i("设备连接信息（仅用于显示）",-1)])]),_:1})])]),default:l(()=>[s(x,{ref_key:"deviceFormRef",ref:M,model:a,rules:k,"label-width":"120px",class:"settings-form"},{default:l(()=>[s(d,{label:"MQTT地址",prop:"mqttBroker"},{default:l(()=>[s(f,{modelValue:a.mqttBroker,"onUpdate:modelValue":t[0]||(t[0]=m=>a.mqttBroker=m),placeholder:"例如: 192.168.1.100 或 mqtt.example.com",maxlength:"255"},{prepend:l(()=>[...t[13]||(t[13]=[i("tcp://",-1)])]),_:1},8,["modelValue"]),t[14]||(t[14]=e("div",{class:"form-tip"},"设备连接的MQTT服务器地址（仅用于在设备详情页显示）",-1))]),_:1}),s(d,{label:"MQTT端口",prop:"mqttPort"},{default:l(()=>[s(y,{modelValue:a.mqttPort,"onUpdate:modelValue":t[1]||(t[1]=m=>a.mqttPort=m),min:1,max:65535,placeholder:"例如: 1883",style:{width:"100%"}},null,8,["modelValue"]),t[15]||(t[15]=e("div",{class:"form-tip"},"MQTT服务器端口号（仅用于在设备详情页显示）",-1))]),_:1}),s(d,{label:"用户名",prop:"mqttUsername"},{default:l(()=>[s(f,{modelValue:a.mqttUsername,"onUpdate:modelValue":t[2]||(t[2]=m=>a.mqttUsername=m),placeholder:"MQTT连接用户名",maxlength:"50"},null,8,["modelValue"]),t[16]||(t[16]=e("div",{class:"form-tip"},"设备连接时使用的用户名（仅用于在设备详情页显示）",-1))]),_:1}),s(d,{label:"密码",prop:"mqttPassword"},{default:l(()=>[s(f,{modelValue:a.mqttPassword,"onUpdate:modelValue":t[3]||(t[3]=m=>a.mqttPassword=m),type:"password","show-password":"",placeholder:"MQTT连接密码",maxlength:"50"},null,8,["modelValue"]),t[17]||(t[17]=e("div",{class:"form-tip"},"设备连接时使用的密码（仅用于在设备详情页显示）",-1))]),_:1}),s(d,null,{default:l(()=>[e("div",W,[s(w,{type:"primary",onClick:S,loading:v.value,size:"large"},{default:l(()=>[s(r,{style:{"margin-right":"6px"}},{default:l(()=>[s(T(V))]),_:1}),t[18]||(t[18]=i(" 保存配置 ",-1))]),_:1},8,["loading"]),s(w,{onClick:D,size:"large"},{default:l(()=>[s(r,{style:{"margin-right":"6px"}},{default:l(()=>[s(T(U))]),_:1}),t[19]||(t[19]=i(" 重置为默认 ",-1))]),_:1})])]),_:1})]),_:1},8,["model"]),s(Q,{type:"info",closable:!1,class:"config-alert"},{title:l(()=>[...t[20]||(t[20]=[e("strong",null,"配置说明",-1)])]),default:l(()=>[t[21]||(t[21]=e("div",{class:"alert-content"},[e("p",null,[i("1. 此配置为"),e("strong",null,"设备连接MQTT服务器"),i("时使用的连接信息")]),e("p",null,"2. 配置信息保存到数据库，仅用于在设备详情页显示给用户查看"),e("p",null,"3. 用户根据此配置在设备端设置MQTT连接参数"),e("p",null,"4. 部署到公网时，请将MQTT地址修改为公网IP或域名"),e("p",null,"5. 确保防火墙已开放MQTT端口（默认1883）")],-1))]),_:1}),e("div",X,[t[24]||(t[24]=e("div",{class:"preview-title"},"当前配置预览",-1)),e("div",Y,[e("div",h,[t[22]||(t[22]=e("span",{class:"preview-label"},"连接地址：",-1)),e("code",tt,"tcp://"+p(a.mqttBroker)+":"+p(a.mqttPort),1)]),e("div",et,[t[23]||(t[23]=e("span",{class:"preview-label"},"认证信息：",-1)),e("code",st,p(a.mqttUsername)+" / "+p(b(a.mqttPassword)),1)])])])]),_:1}),s(B,{class:"settings-card"},{header:l(()=>[e("div",rt,[t[26]||(t[26]=e("span",{class:"card-title"},"平台连接MQTT配置",-1)),s(g,{type:"success",size:"small"},{default:l(()=>[...t[25]||(t[25]=[i("支持动态重新连接",-1)])]),_:1})])]),default:l(()=>[s(x,{ref_key:"platformFormRef",ref:P,model:o,rules:I,"label-width":"120px",class:"settings-form"},{default:l(()=>[s(d,{label:"MQTT地址",prop:"mqttBroker"},{default:l(()=>[s(f,{modelValue:o.mqttBroker,"onUpdate:modelValue":t[4]||(t[4]=m=>o.mqttBroker=m),placeholder:"例如: 192.168.1.100 或 mqtt.example.com",maxlength:"255"},{prepend:l(()=>[...t[27]||(t[27]=[i("tcp://",-1)])]),_:1},8,["modelValue"]),t[28]||(t[28]=e("div",{class:"form-tip"},"平台连接的MQTT服务器地址，用于订阅设备上报数据",-1))]),_:1}),s(d,{label:"MQTT端口",prop:"mqttPort"},{default:l(()=>[s(y,{modelValue:o.mqttPort,"onUpdate:modelValue":t[5]||(t[5]=m=>o.mqttPort=m),min:1,max:65535,placeholder:"例如: 1883",style:{width:"100%"}},null,8,["modelValue"]),t[29]||(t[29]=e("div",{class:"form-tip"},"MQTT服务器端口号，用于订阅设备上报数据",-1))]),_:1}),s(d,{label:"Client ID",prop:"mqttClientId"},{default:l(()=>[s(f,{modelValue:o.mqttClientId,"onUpdate:modelValue":t[6]||(t[6]=m=>o.mqttClientId=m),placeholder:"例如: iot-platform-server",maxlength:"100"},null,8,["modelValue"]),t[30]||(t[30]=e("div",{class:"form-tip"},"平台连接MQTT时使用的客户端ID",-1))]),_:1}),s(d,{label:"用户名",prop:"mqttUsername"},{default:l(()=>[s(f,{modelValue:o.mqttUsername,"onUpdate:modelValue":t[7]||(t[7]=m=>o.mqttUsername=m),placeholder:"MQTT连接用户名",maxlength:"50"},null,8,["modelValue"]),t[31]||(t[31]=e("div",{class:"form-tip"},"平台连接时使用的用户名，用于订阅设备上报数据",-1))]),_:1}),s(d,{label:"密码",prop:"mqttPassword"},{default:l(()=>[s(f,{modelValue:o.mqttPassword,"onUpdate:modelValue":t[8]||(t[8]=m=>o.mqttPassword=m),type:"password","show-password":"",placeholder:"MQTT连接密码",maxlength:"50"},null,8,["modelValue"]),t[32]||(t[32]=e("div",{class:"form-tip"},"平台连接时使用的密码，用于订阅设备上报数据",-1))]),_:1}),s(d,null,{default:l(()=>[e("div",lt,[s(w,{type:"primary",onClick:z,loading:v.value,size:"large"},{default:l(()=>[s(r,{style:{"margin-right":"6px"}},{default:l(()=>[s(T(V))]),_:1}),t[33]||(t[33]=i(" 保存配置 ",-1))]),_:1},8,["loading"]),s(w,{onClick:E,size:"large"},{default:l(()=>[s(r,{style:{"margin-right":"6px"}},{default:l(()=>[s(T(U))]),_:1}),t[34]||(t[34]=i(" 重置为默认 ",-1))]),_:1})])]),_:1})]),_:1},8,["model"]),s(Q,{type:"success",closable:!1,class:"config-alert"},{title:l(()=>[...t[35]||(t[35]=[e("strong",null,"配置说明",-1)])]),default:l(()=>[t[36]||(t[36]=e("div",{class:"alert-content"},[e("p",null,[i("1. 此配置为"),e("strong",null,"平台连接MQTT服务器"),i("时使用的连接信息")]),e("p",null,[i("2. 配置已"),e("strong",null,"持久化保存到数据库"),i("，重启后端服务后配置依然保留")]),e("p",null,[i("3. 保存配置后，MQTT连接会"),e("strong",null,"自动使用新配置重新连接"),i("，无需重启后端")]),e("p",null,"4. 部署到公网时，请将MQTT地址修改为公网IP或域名"),e("p",null,"5. 确保防火墙已开放MQTT端口（默认1883）")],-1))]),_:1}),e("div",ot,[t[40]||(t[40]=e("div",{class:"preview-title"},"当前配置预览",-1)),e("div",at,[e("div",nt,[t[37]||(t[37]=e("span",{class:"preview-label"},"连接地址：",-1)),e("code",mt,"tcp://"+p(o.mqttBroker)+":"+p(o.mqttPort),1)]),e("div",it,[t[38]||(t[38]=e("span",{class:"preview-label"},"认证信息：",-1)),e("code",dt,p(o.mqttUsername)+" / "+p(b(o.mqttPassword)),1)]),e("div",ut,[t[39]||(t[39]=e("span",{class:"preview-label"},"Client ID：",-1)),e("code",pt,p(o.mqttClientId),1)])])])]),_:1})])}}},Tt=F(gt,[["__scopeId","data-v-ee67a603"]]);export{Tt as default};
