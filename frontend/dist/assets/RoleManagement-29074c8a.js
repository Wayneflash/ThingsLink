import{_ as re,b as d,s as j,c as ie,v as ue,d as o,y as de,o as p,e as q,f as M,g as l,w as a,E as r,q as i,i as ce,L as pe,B as me,I as f,t as $,F as fe,A as k,D as ve,M as _e}from"./index-516a5ee0.js";import{g as ye,a as ge,u as K,d as ke,c as we}from"./role-4c9f830e.js";const be={class:"role-management-page"},xe={class:"custom-tree-node"},Ce={__name:"RoleManagement",setup(Ve){const c=d(!1),_=d(!1),w=d(!1),V=d("添加角色"),R=d(!1),x=d(null),b=d(null),A=d(null),h=d([]),S=d(null),m=j(()=>S.value?S.value.roleId===1:!1),z=d([]),O=j(()=>[...z.value].sort((t,e)=>t.isSuperAdmin?-1:e.isSuperAdmin?1:(t.id||0)-(e.id||0))),L=t=>t+1,I=d([]),n=ie({id:null,name:"",code:"",description:"",status:1}),J={name:[{required:!0,message:"请输入角色名称",trigger:"blur"}]},G=()=>{if(!m.value){r.warning("只有超级管理员才能添加角色");return}V.value="添加角色",R.value=!1,_.value=!0},H=t=>{if(!m.value){r.warning("只有超级管理员才能编辑角色");return}if(t.isSuperAdmin){r.warning("超级管理员角色不可编辑");return}V.value="编辑角色",R.value=!0,Object.assign(n,t),_.value=!0},Q=async t=>{if(t.isSuperAdmin){r.warning("超级管理员角色不可编辑");return}try{c.value=!0,A.value=t;const e=await ge(t.id);I.value=e.permissions||[];const y=[];e.permissions&&Array.isArray(e.permissions)&&e.permissions.forEach(g=>{g.granted&&y.push(g.code)}),h.value=y,w.value=!0,await ve(),b.value&&(b.value.setCheckedKeys(y),m.value||b.value.$el.querySelectorAll(".el-checkbox__input").forEach(u=>{u.style.pointerEvents="none",u.style.opacity="0.5"}))}catch(e){console.error("获取角色权限失败:",e),r.error("获取角色权限失败")}finally{c.value=!1}},W=async()=>{try{c.value=!0;const t=b.value.getCheckedKeys();console.log("当前勾选的权限:",t),await K({id:A.value.id,menuIds:t.join(",")}),r.success("权限配置成功"),w.value=!1,await C()}catch(t){console.error("保存权限失败:",t),r.error(t.message||"保存失败")}finally{c.value=!1}},X=async t=>{if(!m.value){r.warning("只有超级管理员才能删除角色");return}if(t.isSuperAdmin){r.warning("超级管理员角色不可删除");return}if(t.userCount>0){r.warning("该角色下存在用户，无法删除");return}try{await _e.confirm(`确定要删除角色“${t.name}”吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),c.value=!0,await ke(t.id),r.success("角色删除成功"),await C()}catch(e){e!=="cancel"&&(console.error("删除角色失败:",e),r.error(e.message||"删除失败"))}finally{c.value=!1}},Y=async()=>{x.value&&await x.value.validate(async t=>{if(t)try{c.value=!0,R.value?(await K({id:n.id,name:n.name,description:n.description,status:n.status}),r.success("角色更新成功")):(await we({name:n.name,description:n.description,status:n.status}),r.success("角色添加成功")),_.value=!1,await C()}catch(e){console.error("保存角色失败:",e),r.error(e.message||"保存失败")}finally{c.value=!1}})},Z=()=>{var t;Object.assign(n,{id:null,name:"",code:"",description:"",status:1}),(t=x.value)==null||t.clearValidate()},C=async()=>{try{c.value=!0;const t=await ye({page:1,pageSize:100});z.value=(t.list||[]).map(e=>({id:e.id,name:e.name,code:e.roleCode||e.code,description:e.description||"",userCount:e.userCount||0,status:e.status,isSuperAdmin:e.roleCode==="super_admin"||e.code==="super_admin",createTime:e.createTime}))}catch(t){console.error("加载角色列表失败:",t),r.error("加载角色列表失败")}finally{c.value=!1}};return ue(()=>{const t=localStorage.getItem("userInfo");t&&(S.value=JSON.parse(t)),C()}),(t,e)=>{const y=o("el-alert"),g=o("el-col"),U=o("el-icon"),u=o("el-button"),ee=o("el-row"),F=o("el-card"),v=o("el-table-column"),T=o("el-tag"),te=o("el-tooltip"),le=o("el-table"),N=o("el-input"),E=o("el-form-item"),ae=o("el-switch"),se=o("el-form"),P=o("el-dialog"),ne=o("el-tree"),oe=de("loading");return p(),q("div",be,[e[19]||(e[19]=M("h1",{class:"page-title"},"角色管理",-1)),l(F,{class:"toolbar-card",shadow:"never"},{default:a(()=>[l(ee,{gutter:16},{default:a(()=>[l(g,{span:18},{default:a(()=>[l(y,{title:"角色说明",type:"info",closable:!1,"show-icon":""},{default:a(()=>[...e[7]||(e[7]=[i(" 管理系统角色和权限，超级管理员拥有所有权限，其他角色需要分配相应权限 ",-1)])]),_:1})]),_:1}),l(g,{span:6,class:"text-right"},{default:a(()=>[l(u,{type:"primary",onClick:G,disabled:!m.value},{default:a(()=>[l(U,null,{default:a(()=>[l(ce(pe))]),_:1}),e[8]||(e[8]=i(" 添加角色 ",-1))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),l(F,{class:"table-card",shadow:"never"},{default:a(()=>[me((p(),f(le,{data:O.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(v,{type:"index",label:"序号",width:"80",index:L}),l(v,{prop:"name",label:"角色名称","min-width":"150"}),l(v,{prop:"description",label:"描述","min-width":"200"}),l(v,{prop:"userCount",label:"用户数",width:"100",align:"center"}),l(v,{prop:"status",label:"状态",width:"100"},{default:a(({row:s})=>[l(T,{type:s.status===1?"success":"info",size:"small"},{default:a(()=>[i($(s.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(v,{prop:"createTime",label:"创建时间","min-width":"160"}),l(v,{label:"操作",width:"240",fixed:"right"},{default:a(({row:s})=>[m.value?(p(),q(fe,{key:0},[s.isSuperAdmin?k("",!0):(p(),f(u,{key:0,size:"small",type:"primary",link:"",onClick:B=>Q(s)},{default:a(()=>[...e[9]||(e[9]=[i(" 权限配置 ",-1)])]),_:1},8,["onClick"])),s.isSuperAdmin?k("",!0):(p(),f(u,{key:1,size:"small",type:"primary",link:"",onClick:B=>H(s)},{default:a(()=>[...e[10]||(e[10]=[i(" 编辑 ",-1)])]),_:1},8,["onClick"])),s.isSuperAdmin?k("",!0):(p(),f(u,{key:2,size:"small",type:"danger",link:"",onClick:B=>X(s)},{default:a(()=>[...e[11]||(e[11]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])),s.isSuperAdmin?(p(),f(T,{key:3,size:"small",type:"info"},{default:a(()=>[...e[12]||(e[12]=[i("不可编辑",-1)])]),_:1})):k("",!0)],64)):(p(),f(te,{key:1,content:"只有超级管理员才能配置角色权限",placement:"top"},{default:a(()=>[l(u,{size:"small",type:"info",link:"",disabled:""},{default:a(()=>[...e[13]||(e[13]=[i(" 仅可查看 ",-1)])]),_:1})]),_:1}))]),_:1})]),_:1},8,["data"])),[[oe,c.value]])]),_:1}),l(P,{modelValue:_.value,"onUpdate:modelValue":e[4]||(e[4]=s=>_.value=s),title:V.value,width:"600px",onClose:Z},{footer:a(()=>[l(u,{onClick:e[3]||(e[3]=s=>_.value=!1)},{default:a(()=>[...e[14]||(e[14]=[i("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:Y},{default:a(()=>[...e[15]||(e[15]=[i("确定",-1)])]),_:1})]),default:a(()=>[l(se,{ref_key:"roleFormRef",ref:x,model:n,rules:J,"label-width":"100px"},{default:a(()=>[l(E,{label:"角色名称",prop:"name"},{default:a(()=>[l(N,{modelValue:n.name,"onUpdate:modelValue":e[0]||(e[0]=s=>n.name=s),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),l(E,{label:"描述"},{default:a(()=>[l(N,{modelValue:n.description,"onUpdate:modelValue":e[1]||(e[1]=s=>n.description=s),type:"textarea",rows:3,placeholder:"请输入角色描述（可选）"},null,8,["modelValue"])]),_:1}),l(E,{label:"状态"},{default:a(()=>[l(ae,{modelValue:n.status,"onUpdate:modelValue":e[2]||(e[2]=s=>n.status=s),"active-value":1,"inactive-value":0,"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(P,{modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=s=>w.value=s),title:m.value?"权限配置":"查看权限（只读）",width:"700px"},{footer:a(()=>[l(u,{onClick:e[5]||(e[5]=s=>w.value=!1)},{default:a(()=>[...e[17]||(e[17]=[i("取消",-1)])]),_:1}),m.value?(p(),f(u,{key:0,type:"primary",onClick:W},{default:a(()=>[...e[18]||(e[18]=[i("保存权限",-1)])]),_:1})):k("",!0)]),default:a(()=>{var s;return[l(y,{title:`正在为「${(s=A.value)==null?void 0:s.name}」配置权限`,type:"info",closable:!1,"show-icon":"",class:"mb-4"},null,8,["title"]),l(ne,{ref_key:"permissionTreeRef",ref:b,data:I.value,"show-checkbox":"","node-key":"code","default-checked-keys":h.value,props:{label:"name",children:"children"}},{default:a(({node:B,data:D})=>[M("span",xe,[M("span",null,$(D.icon)+" "+$(D.name),1),D.isButton?(p(),f(T,{key:0,size:"small",type:"info",class:"ml-2"},{default:a(()=>[...e[16]||(e[16]=[i("按钮",-1)])]),_:1})):k("",!0)])]),_:1},8,["data","default-checked-keys"])]}),_:1},8,["modelValue","title"])])}}},Se=re(Ce,[["__scopeId","data-v-4e746995"]]);export{Se as default};
