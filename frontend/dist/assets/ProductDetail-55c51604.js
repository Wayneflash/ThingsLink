import{_ as be,a as ge,u as ye,r as f,Z as Ve,c as u,o as N,d as $,g as t,w as l,e as d,t as g,E as i,q as s,i as c,T as w,a1 as we,ac as J,a4 as Ne,k as O,s as ke,F as Ce,f as xe,ad as K}from"./index-80cba2ab.js";import{p as k}from"./index-67d93fb6.js";const Te={class:"product-detail"},ze={class:"page-header"},$e={class:"page-title"},Me={class:"page-actions"},De={class:"card-header"},Fe={class:"info-grid"},Ue={class:"info-row"},Ae={class:"info-item"},Pe={class:"info-value"},Se={class:"info-item"},Re={class:"info-value"},Be={class:"info-item"},qe={class:"info-value"},he={class:"info-row"},Ie={class:"info-item"},Ee={class:"info-value"},Qe={class:"info-item"},Oe={class:"info-value"},He={class:"info-item"},Le={class:"info-value"},Ye={key:0,class:"info-desc-row"},Ze={class:"info-desc"},je={class:"tab-header"},Ge={key:0,class:"empty-state"},Je={class:"tab-header"},Ke={key:0,class:"empty-state"},We={class:"input-hint"},Xe={class:"input-hint"},et={class:"input-hint"},tt={key:0},lt={key:1},at={class:"input-hint"},ot={class:"input-hint"},dt={class:"input-hint"},st={class:"input-hint"},rt={class:"input-hint"},nt={class:"input-hint"},ut={class:"alert-title"},it={__name:"ProductDetail",setup(mt){const M=ge(),W=ye(),_=f({}),C=f([]),D=f([]),H=f("attributes"),F=f(!1),T=f(!1),U=f(!1),z=f(!1),R=f(null),B=f(null),q=f(null),v=f({productName:"",productModel:"",protocol:"",description:""}),r=f({addr:"",attrName:"",dataType:"",unit:""}),b=f({commandName:"",addr:"",commandValue:""}),X=a=>{if(!a)return"-";if(typeof a=="string"&&a.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/))return a;if(typeof a=="string"&&a.includes("T"))return a.replace("T"," ").substring(0,19);const e=new Date(a),m=e.getFullYear(),A=String(e.getMonth()+1).padStart(2,"0"),p=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),P=String(e.getMinutes()).padStart(2,"0"),y=String(e.getSeconds()).padStart(2,"0");return`${m}-${A}-${p} ${n}:${P}:${y}`},ee={productName:[{required:!0,message:"请输入产品名称",trigger:"blur"}],protocol:[{required:!0,message:"请选择协议类型",trigger:"change"}]},te={addr:[{required:!0,message:"请输入属性标识符",trigger:"blur"}],attrName:[{required:!0,message:"请输入属性名称",trigger:"blur"}],dataType:[{required:!0,message:"请选择数据类型",trigger:"change"}]},le={commandName:[{required:!0,message:"请输入命令名称",trigger:"blur"}],addr:[{required:!0,message:"请选择控制属性",trigger:"change"}],commandValue:[{required:!0,message:"请输入下发值",trigger:"blur"}]},L=async()=>{try{const a=M.params.id,e=await k.getProductDetail(a);_.value=e,e.attrs&&(C.value=e.attrs),e.commands&&(D.value=e.commands)}catch(a){console.error("加载产品详情失败:",a),i.error("加载产品详情失败")}},h=async()=>{try{const a=M.params.id,e=await k.getProductAttributes(a);C.value=e||[]}catch(a){console.error("加载属性列表失败:",a)}},Y=async()=>{try{const a=M.params.id,e=await k.getProductCommands(a);D.value=e||[]}catch(a){console.error("加载命令列表失败:",a)}},ae=()=>{v.value={productName:_.value.productName,productModel:_.value.productModel,protocol:_.value.protocol,description:_.value.description||""},F.value=!0},oe=async()=>{if(R.value)try{await R.value.validate(),await k.updateProduct({id:M.params.id,productName:v.value.productName,productModel:v.value.productModel,protocol:v.value.protocol,description:v.value.description}),i.success("产品信息已更新"),F.value=!1,L()}catch(a){a!==!1&&(console.error("更新产品失败:",a),i.error("更新产品失败"))}},de=()=>{z.value=!1,r.value={addr:"",attrName:"",dataType:"",unit:""},T.value=!0},se=a=>{z.value=!0,r.value={id:a.id,addr:a.addr,attrName:a.attrName||"",dataType:a.dataType||"",unit:a.unit||"",description:a.description||""},T.value=!0},re=async()=>{if(B.value)try{if(await B.value.validate(),C.value.some(a=>a.addr===r.value.addr)){i.error("属性标识符已存在");return}await k.addProductAttribute({productId:M.params.id,addr:r.value.addr,attrName:r.value.attrName,dataType:r.value.dataType,unit:r.value.unit}),i.success("属性添加成功"),T.value=!1,h()}catch(a){a!==!1&&(console.error("添加属性失败:",a),i.error("添加属性失败"))}},ne=async()=>{var a,e;try{if(!r.value.id){i.error("属性ID不能为空"),console.error("属性ID为空，attrForm:",r.value);return}if(!r.value.attrName||r.value.attrName.trim()===""){i.error("请输入属性名称");return}const m={id:r.value.id,attrName:r.value.attrName.trim(),unit:(r.value.unit||"").trim(),description:(r.value.description||"").trim()};console.log("发送更新属性请求，参数:",m),await k.updateProductAttribute(m),i.success("属性更新成功"),T.value=!1,h()}catch(m){console.error("更新属性失败:",m);const A=(m==null?void 0:m.message)||((e=(a=m==null?void 0:m.response)==null?void 0:a.data)==null?void 0:e.message)||"更新属性失败";i.error(A)}},ue=async a=>{try{await K.confirm(`确定要删除属性"${a.attrName}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await k.deleteProductAttribute(a.id),i.success("属性已删除"),h()}catch(e){e!=="cancel"&&(console.error("删除属性失败:",e),i.error("删除属性失败"))}},ie=()=>{if(C.value.length===0){i.warning("请先添加属性后再创建命令");return}b.value={commandName:"",addr:"",commandValue:""},U.value=!0},me=async()=>{if(q.value)try{await q.value.validate(),await k.addProductCommand({productId:M.params.id,addr:b.value.addr,commandName:b.value.commandName,commandValue:b.value.commandValue,description:`控制属性 ${b.value.addr} 为 ${b.value.commandValue}`}),i.success("命令添加成功"),U.value=!1,Y()}catch(a){a!==!1&&(console.error("添加命令失败:",a),i.error("添加命令失败"))}},pe=async a=>{try{await K.confirm(`确定要删除命令"${a.commandName}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await k.deleteProductCommand(a.id),i.success("命令已删除"),Y()}catch(e){e!=="cancel"&&(console.error("删除命令失败:",e),i.error("删除命令失败"))}},ce=()=>{W.push("/products")};return Ve(()=>{L()}),(a,e)=>{const m=u("el-breadcrumb-item"),A=u("el-breadcrumb"),p=u("el-button"),n=u("el-icon"),P=u("el-card"),y=u("el-table-column"),ve=u("el-tag"),Z=u("el-table"),j=u("el-tab-pane"),fe=u("el-tabs"),x=u("el-input"),V=u("el-form-item"),S=u("el-option"),I=u("el-select"),E=u("el-form"),Q=u("el-dialog"),_e=u("el-alert");return N(),$("div",Te,[t(A,{separator:"›",class:"breadcrumb"},{default:l(()=>[t(m,{to:{path:"/products"}},{default:l(()=>[...e[19]||(e[19]=[s("产品管理",-1)])]),_:1}),t(m,null,{default:l(()=>[s(g(_.value.productName||"产品详情"),1)]),_:1})]),_:1}),d("div",ze,[d("h1",$e,g(_.value.productName),1),d("div",Me,[t(p,{onClick:ce},{default:l(()=>[...e[20]||(e[20]=[s("← 返回列表",-1)])]),_:1}),t(p,{type:"primary",onClick:ae},{default:l(()=>[...e[21]||(e[21]=[s("编辑产品",-1)])]),_:1})])]),t(P,{class:"info-card"},{header:l(()=>[d("div",De,[t(n,{class:"header-icon"},{default:l(()=>[t(c(w))]),_:1}),e[22]||(e[22]=d("span",null,"基本信息",-1))])]),default:l(()=>[d("div",Fe,[d("div",Ue,[d("div",Ae,[e[23]||(e[23]=d("div",{class:"info-label"},"产品名称",-1)),d("div",Pe,g(_.value.productName||"-"),1)]),d("div",Se,[e[24]||(e[24]=d("div",{class:"info-label"},"产品型号",-1)),d("div",Re,g(_.value.productModel||"-"),1)]),d("div",Be,[e[25]||(e[25]=d("div",{class:"info-label"},"协议类型",-1)),d("div",qe,g(_.value.protocol||"-"),1)])]),d("div",he,[d("div",Ie,[e[26]||(e[26]=d("div",{class:"info-label"},"创建时间",-1)),d("div",Ee,g(X(_.value.createTime)),1)]),d("div",Qe,[e[27]||(e[27]=d("div",{class:"info-label"},"属性数量",-1)),d("div",Oe,g(C.value.length)+" 个",1)]),d("div",He,[e[28]||(e[28]=d("div",{class:"info-label"},"命令数量",-1)),d("div",Le,g(D.value.length)+" 个",1)])]),_.value.description?(N(),$("div",Ye,[e[29]||(e[29]=d("div",{class:"info-label"},"产品描述",-1)),d("div",Ze,g(_.value.description),1)])):we("",!0)])]),_:1}),t(P,{class:"tab-card"},{default:l(()=>[t(fe,{modelValue:H.value,"onUpdate:modelValue":e[0]||(e[0]=o=>H.value=o)},{default:l(()=>[t(j,{label:"属性列表",name:"attributes"},{default:l(()=>[d("div",je,[e[31]||(e[31]=d("div",{class:"tab-title"},"设备属性定义",-1)),t(p,{type:"primary",size:"small",onClick:de},{default:l(()=>[t(n,null,{default:l(()=>[t(c(J))]),_:1}),e[30]||(e[30]=s("添加属性 ",-1))]),_:1})]),C.value.length===0?(N(),$("div",Ge,[t(n,{class:"empty-icon",size:48},{default:l(()=>[t(c(Ne))]),_:1}),e[32]||(e[32]=d("div",{class:"empty-text"},'暂无属性，点击"添加属性"开始定义数据点',-1))])):(N(),O(Z,{key:1,data:C.value,stripe:"",size:"small",class:"attr-table"},{default:l(()=>[t(y,{prop:"addr",label:"标识符",width:"200"}),t(y,{prop:"attrName",label:"属性名称","min-width":"120"}),t(y,{prop:"dataType",label:"数据类型",width:"100"},{default:l(({row:o})=>[t(ve,{size:"small"},{default:l(()=>[s(g(o.dataType),1)]),_:2},1024)]),_:1}),t(y,{prop:"unit",label:"单位",width:"100"},{default:l(({row:o})=>[s(g(o.unit||"-"),1)]),_:1}),t(y,{label:"操作",width:"150",fixed:"right"},{default:l(({row:o})=>[t(p,{size:"small",type:"primary",link:"",onClick:G=>se(o)},{default:l(()=>[...e[33]||(e[33]=[s("编辑",-1)])]),_:1},8,["onClick"]),t(p,{size:"small",type:"danger",link:"",onClick:G=>ue(o)},{default:l(()=>[...e[34]||(e[34]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1}),t(j,{label:"命令列表",name:"commands"},{default:l(()=>[d("div",Je,[e[36]||(e[36]=d("div",{class:"tab-title"},"设备命令定义",-1)),t(p,{type:"primary",size:"small",onClick:ie},{default:l(()=>[t(n,null,{default:l(()=>[t(c(J))]),_:1}),e[35]||(e[35]=s("添加命令 ",-1))]),_:1})]),D.value.length===0?(N(),$("div",Ke,[t(n,{class:"empty-icon",size:48},{default:l(()=>[t(c(ke))]),_:1}),e[37]||(e[37]=d("div",{class:"empty-text"},'暂无命令，点击"添加命令"开始定义控制指令',-1))])):(N(),O(Z,{key:1,data:D.value,stripe:"",size:"small",class:"cmd-table"},{default:l(()=>[t(y,{prop:"commandName",label:"命令名称","min-width":"150"}),t(y,{prop:"addr",label:"控制属性",width:"120"}),t(y,{prop:"commandValue",label:"下发值",width:"120"}),t(y,{label:"操作",width:"100",fixed:"right"},{default:l(({row:o})=>[t(p,{size:"small",type:"danger",link:"",onClick:G=>pe(o)},{default:l(()=>[...e[38]||(e[38]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(Q,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=o=>F.value=o),title:"编辑产品",width:"600px"},{footer:l(()=>[t(p,{onClick:e[5]||(e[5]=o=>F.value=!1)},{default:l(()=>[...e[41]||(e[41]=[s("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:oe},{default:l(()=>[...e[42]||(e[42]=[s("保存修改",-1)])]),_:1})]),default:l(()=>[t(E,{model:v.value,"label-width":"120px",rules:ee,ref_key:"editFormRef",ref:R},{default:l(()=>[t(V,{label:"产品名称",prop:"productName"},{default:l(()=>[t(x,{modelValue:v.value.productName,"onUpdate:modelValue":e[1]||(e[1]=o=>v.value.productName=o),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),t(V,{label:"产品型号",prop:"productModel"},{default:l(()=>[t(x,{modelValue:v.value.productModel,"onUpdate:modelValue":e[2]||(e[2]=o=>v.value.productModel=o),disabled:""},null,8,["modelValue"]),d("div",We,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[39]||(e[39]=s(" 产品型号创建后不可修改 ",-1))])]),_:1}),t(V,{label:"协议类型",prop:"protocol"},{default:l(()=>[t(I,{modelValue:v.value.protocol,"onUpdate:modelValue":e[3]||(e[3]=o=>v.value.protocol=o),placeholder:"请选择协议类型",style:{width:"100%"},disabled:""},{default:l(()=>[t(S,{label:"MQTT",value:"MQTT"})]),_:1},8,["modelValue"]),d("div",Xe,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[40]||(e[40]=s(" 当前仅支持MQTT协议，其他协议类型正在开发中 ",-1))])]),_:1}),t(V,{label:"产品描述"},{default:l(()=>[t(x,{modelValue:v.value.description,"onUpdate:modelValue":e[4]||(e[4]=o=>v.value.description=o),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Q,{modelValue:T.value,"onUpdate:modelValue":e[13]||(e[13]=o=>T.value=o),title:z.value?"编辑产品属性":"添加产品属性",width:"600px"},{footer:l(()=>[t(p,{onClick:e[11]||(e[11]=o=>T.value=!1)},{default:l(()=>[...e[46]||(e[46]=[s("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:e[12]||(e[12]=o=>z.value?ne():re())},{default:l(()=>[s(g(z.value?"保存修改":"确定添加"),1)]),_:1})]),default:l(()=>[t(E,{model:r.value,"label-width":"120px",rules:te,ref_key:"attrFormRef",ref:B},{default:l(()=>[t(V,{label:"属性标识符",prop:"addr"},{default:l(()=>[t(x,{modelValue:r.value.addr,"onUpdate:modelValue":e[7]||(e[7]=o=>r.value.addr=o),placeholder:"如：tem、hum、battery",disabled:z.value},null,8,["modelValue","disabled"]),d("div",et,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),z.value?(N(),$("span",tt,"属性标识符创建后不可修改")):(N(),$("span",lt,"英文标识符，用于数据上报的字段名，建议使用小写字母+下划线"))])]),_:1}),t(V,{label:"属性名称",prop:"attrName"},{default:l(()=>[t(x,{modelValue:r.value.attrName,"onUpdate:modelValue":e[8]||(e[8]=o=>r.value.attrName=o),placeholder:"如：温度、湿度、电池电量"},null,8,["modelValue"]),d("div",at,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[43]||(e[43]=s(" 中文显示名称，方便理解属性含义 ",-1))])]),_:1}),t(V,{label:"数据类型",prop:"dataType"},{default:l(()=>[t(I,{modelValue:r.value.dataType,"onUpdate:modelValue":e[9]||(e[9]=o=>r.value.dataType=o),placeholder:"请选择数据类型",style:{width:"100%"}},{default:l(()=>[t(S,{label:"整数 (int) - 如状态、计数",value:"int"}),t(S,{label:"浮点数 (float) - 如温度、湿度",value:"float"})]),_:1},8,["modelValue"]),d("div",ot,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[44]||(e[44]=s(" 选择合适的数据类型，影响数据存储和处理方式 ",-1))])]),_:1}),t(V,{label:"单位"},{default:l(()=>[t(x,{modelValue:r.value.unit,"onUpdate:modelValue":e[10]||(e[10]=o=>r.value.unit=o),placeholder:"如：℃、%、m/s（可选）"},null,8,["modelValue"]),d("div",dt,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[45]||(e[45]=s(" 数值属性可填写单位，非数值属性可留空 ",-1))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(Q,{modelValue:U.value,"onUpdate:modelValue":e[18]||(e[18]=o=>U.value=o),title:"添加产品命令",width:"600px"},{footer:l(()=>[t(p,{onClick:e[17]||(e[17]=o=>U.value=!1)},{default:l(()=>[...e[56]||(e[56]=[s("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:me},{default:l(()=>[...e[57]||(e[57]=[s("确定添加",-1)])]),_:1})]),default:l(()=>[t(E,{model:b.value,"label-width":"120px",rules:le,ref_key:"cmdFormRef",ref:q},{default:l(()=>[t(V,{label:"命令名称",prop:"commandName"},{default:l(()=>[t(x,{modelValue:b.value.commandName,"onUpdate:modelValue":e[14]||(e[14]=o=>b.value.commandName=o),placeholder:"如：打开窗户、关闭灯光、设置模式"},null,8,["modelValue"]),d("div",st,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[47]||(e[47]=s(" 命令的显示名称，让用户知道这是什么操作 ",-1))])]),_:1}),t(V,{label:"控制属性",prop:"addr"},{default:l(()=>[t(I,{modelValue:b.value.addr,"onUpdate:modelValue":e[15]||(e[15]=o=>b.value.addr=o),placeholder:"请选择要控制的属性",style:{width:"100%"}},{default:l(()=>[(N(!0),$(Ce,null,xe(C.value,o=>(N(),O(S,{key:o.addr,label:`${o.attrName} (${o.addr})`,value:o.addr},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d("div",rt,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[48]||(e[48]=s(" 选择要控制的属性，命令会修改该属性的值 ",-1))])]),_:1}),t(V,{label:"下发值",prop:"commandValue"},{default:l(()=>[t(x,{modelValue:b.value.commandValue,"onUpdate:modelValue":e[16]||(e[16]=o=>b.value.commandValue=o),placeholder:"如：1、0、ON、OFF"},null,8,["modelValue"]),d("div",nt,[t(n,{class:"hint-icon",size:14},{default:l(()=>[t(c(w))]),_:1}),e[49]||(e[49]=s(" 命令执行时会将该值下发给设备，设备根据该值进行操作 ",-1))])]),_:1}),t(_e,{type:"info",closable:!1},{title:l(()=>[d("div",ut,[t(n,{class:"alert-icon",size:16},{default:l(()=>[t(c(w))]),_:1}),e[50]||(e[50]=s(" 示例 ",-1))])]),default:l(()=>[e[51]||(e[51]=s(' 如果有一个属性叫 "window"，可以创建两个命令：',-1)),e[52]||(e[52]=d("br",null,null,-1)),e[53]||(e[53]=s(" • 命令名：打开窗户 | 控制属性：window | 下发值：1",-1)),e[54]||(e[54]=d("br",null,null,-1)),e[55]||(e[55]=s(" • 命令名：关闭窗户 | 控制属性：window | 下发值：0 ",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},vt=be(it,[["__scopeId","data-v-6ff78433"]]);export{vt as default};
