import{r as le,_ as ge,a as fe,u as ye,c as Q,b as D,s as X,N as ee,v as te,d as T,o as d,e as v,f as t,g as r,w as g,z as $,t as c,q as A,A as V,F as W,C as G,B as oe,O as ae,I as se,E as p,D as ne,i as R,P as he,Q as Z,M as _e}from"./index-6eb9f70f.js";import{a as be,b as we}from"./device-e2733035.js";import{a as Ce,b as De}from"./product-3ce149d3.js";import{g as Se}from"./system-2e7ef582.js";import{i as ke}from"./index-18acf776.js";const xe=H=>le({url:"/device-data/list",method:"post",data:H}),Te=H=>le({url:"/commands/send",method:"post",data:H});const $e={class:"device-detail-page"},ze={class:"topbar"},Me={key:0,class:"header-section"},qe={class:"header-left"},Ne={class:"device-title-bar-compact"},Ve={class:"device-title-text"},Ie={class:"title-row"},Ae={class:"device-name-wrapper"},Pe={class:"device-name-large"},He={class:"device-code-badge"},Be={class:"info-grid-compact"},Re={class:"info-card-compact"},Ye={class:"info-value"},Le={class:"info-card-compact"},Oe={class:"info-value"},Ee={class:"info-card-compact"},Fe={class:"info-value"},je={class:"header-right"},Ue={class:"mqtt-card-compact"},Qe={class:"mqtt-line"},We={class:"mqtt-value"},Ge={class:"mqtt-value"},Ze={class:"mqtt-line"},Je={class:"mqtt-code-inline"},Ke={class:"mqtt-line"},Xe={class:"mqtt-code-inline"},et={class:"mqtt-line"},tt={class:"mqtt-code-inline"},ot={class:"tabs"},at={key:0,class:"data-grid-wrapper"},st={class:"data-grid"},nt={class:"data-label"},lt={class:"data-value"},it={key:0,class:"data-unit"},rt={class:"data-time"},dt={key:1,class:"empty-data"},ct={class:"history-toolbar"},ut={style:{flex:"1",display:"flex",gap:"12px","justify-content":"flex-end"}},vt={class:"history-chart-container"},pt={key:0,class:"empty-data"},mt={class:"history-table-wrapper"},gt={class:"history-table-container"},ft={key:0},yt={key:0,class:"unit-text"},ht={key:1,style:{color:"#ccc"}},_t={key:1,class:"empty-data"},bt={class:"command-grid"},wt=["onClick"],Ct={class:"command-name"},Dt={key:0,class:"empty-data"},St={__name:"DeviceDetail",setup(H){const ie=fe(),re=ye(),l=Q({id:null,deviceName:"",deviceCode:"",productId:null,productName:"",groupId:null,groupName:"",groupPath:"",status:0,lastOnlineTime:"",createTime:""}),h=D([]),z=D([]),B=D([]),Y=D("-"),S=D("chart"),k=D([]),f=D([]),M=D(null);let _=null;const b=Q({currentPage:1,pageSize:50,total:0}),w=D("realtime"),q=Q({broker:"",port:"",username:"",password:""});D(!1);const de=async()=>{try{const o=await Se();o&&Object.assign(q,o)}catch(o){console.error("åŠ è½½MQTTé…ç½®å¤±è´¥:",o),q.broker="localhost",q.port="1883",q.username="admin",q.password="admin123."}},ce=async()=>{try{const o=ie.query.deviceCode;if(!o){p.error("è®¾å¤‡ç¼–ç ä¸å­˜åœ¨"),P();return}await de();const e=await be({deviceCode:o});e?(Object.assign(l,e),L()):(p.error("è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥"),P())}catch(o){console.error("åŠ è½½è®¾å¤‡è¯¦æƒ…å¤±è´¥:",o),p.error("åŠ è½½è®¾å¤‡è¯¦æƒ…å¤±è´¥"),P()}},J=async()=>{if(!l.productId){console.warn("äº§å“IDä¸å­˜åœ¨");return}if(!(h.value.length>0))try{const o=await Ce(l.productId);o&&(h.value=o||[],console.log("äº§å“å±æ€§åŠ è½½å®Œæˆ:",h.value.length,"ä¸ª"))}catch(o){console.error("åŠ è½½äº§å“å±æ€§å¤±è´¥:",o),p.error("åŠ è½½äº§å“å±æ€§å¤±è´¥")}},ue=async()=>{if(!l.productId){console.warn("äº§å“IDä¸å­˜åœ¨");return}if(!(z.value.length>0))try{const o=await De(l.productId);o&&(Array.isArray(o)?z.value=o:o.list&&Array.isArray(o.list)?z.value=o.list:z.value=[],console.log("äº§å“å‘½ä»¤åŠ è½½å®Œæˆ:",z.value.length,"ä¸ª"))}catch(o){console.error("åŠ è½½äº§å“å‘½ä»¤å¤±è´¥:",o),p.error("åŠ è½½äº§å“å‘½ä»¤å¤±è´¥")}},L=async()=>{try{h.value.length===0&&await J();const o=await we({deviceCode:l.deviceCode});if(o){const e=o.reportTime;if(e)Y.value=e.includes("T")?e.replace("T"," "):e;else{const s=new Date,m=s.getFullYear(),x=String(s.getMonth()+1).padStart(2,"0"),N=String(s.getDate()).padStart(2,"0"),n=String(s.getHours()).padStart(2,"0"),u=String(s.getMinutes()).padStart(2,"0"),y=String(s.getSeconds()).padStart(2,"0");Y.value=`${m}-${x}-${N} ${n}:${u}:${y}`}const i=o.data||{};B.value=h.value.map(s=>{const m=i[s.addr];return{key:s.addr,label:s.attrName,value:m!=null&&m!==""?m:"-",unit:s.unit}})}else B.value=h.value.map(e=>({key:e.addr,label:e.attrName,value:"-",unit:e.unit}))}catch(o){console.error("åŠ è½½å®æ—¶æ•°æ®å¤±è´¥:",o),p.error("åŠ è½½å®æ—¶æ•°æ®å¤±è´¥")}},ve=X(()=>{const o=(b.currentPage-1)*b.pageSize,e=o+b.pageSize;return f.value.slice(o,e)}),pe=X(()=>"calc(100vh - 320px)"),O=async()=>{try{if(!k.value||k.value.length!==2){p.warning("è¯·é€‰æ‹©æŸ¥è¯¢æ—¶é—´èŒƒå›´");return}const o=await xe({deviceCode:l.deviceCode,startTime:k.value[0],endTime:k.value[1]});if(o){const e=new Map;o.forEach(i=>{let s="";i.ctime&&(s=i.ctime.includes("T")?i.ctime.replace("T"," "):i.ctime),e.has(s)||e.set(s,{reportTime:s}),e.get(s)[i.addr]=i.addrv}),f.value=Array.from(e.values()).sort((i,s)=>new Date(s.reportTime)-new Date(i.reportTime)),b.total=f.value.length,b.currentPage=1,p.success(`æŸ¥è¯¢æˆåŠŸï¼Œå…± ${f.value.length} æ¡è®°å½•`),S.value==="chart"&&ne(()=>{E()})}}catch(o){console.error("æŸ¥è¯¢å†å²æ•°æ®å¤±è´¥:",o),p.error("æŸ¥è¯¢å†å²æ•°æ®å¤±è´¥")}},E=()=>{if(console.log("=== å¼€å§‹æ¸²æŸ“å›¾è¡¨ ==="),console.log("historyChartRef.value:",M.value),console.log("historyData.value.length:",f.value.length),console.log("productAttributes.value.length:",h.value.length),!M.value){console.error("å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°");return}const o=M.value.getBoundingClientRect();if(console.log("å®¹å™¨å°ºå¯¸:",o.width,"x",o.height),o.width===0||o.height===0){console.error("å®¹å™¨å°ºå¯¸ä¸º0ï¼Œå¯èƒ½æœªæ˜¾ç¤º"),setTimeout(()=>{if(M.value){const n=M.value.getBoundingClientRect();n.width>0&&n.height>0&&E()}},200);return}if(f.value.length===0){console.warn("æ— å†å²æ•°æ®");return}if(h.value.length===0){console.warn("äº§å“å±æ€§æœªåŠ è½½");return}_&&(_.dispose(),_=null),_=ke(M.value),console.log("å›¾è¡¨å®ä¾‹å·²åˆ›å»º");const e=[...f.value].sort((n,u)=>new Date(n.reportTime.replace("T"," "))-new Date(u.reportTime.replace("T"," ")));console.log("æ’åºåæ•°æ®:",e.length,"æ¡");const i=e.map(n=>{const u=n.reportTime.replace("T"," ");return u.split(" ")[1]||u});console.log("æ—¶é—´è½´æ•°æ®:",i.slice(0,5));const s=h.value.filter(n=>{const u=n.dataType;return u==="int"||u==="float"||u==="double"});if(console.log("æ•°å€¼å±æ€§:",s.map(n=>`${n.attrName}(${n.addr})`)),s.length===0){console.warn("æ²¡æœ‰æ•°å€¼ç±»å‹çš„å±æ€§"),p.warning("å½“å‰äº§å“æ²¡æœ‰å¯ç»˜åˆ¶çš„æ•°å€¼å±æ€§");return}const m=["#409eff","#67c23a","#e6a23c","#f56c6c","#909399"],x=s.map((n,u)=>{const y=e.map(C=>{const I=C[n.addr];return I!=null&&I!==""?Number(I):null}),a=y.filter(C=>C!==null).length;return console.log(`${n.attrName}: ${a} ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹`),{name:n.attrName,type:"line",smooth:!0,symbol:"circle",symbolSize:6,data:y,itemStyle:{color:m[u%m.length]},lineStyle:{width:2},connectNulls:!1}}),N={title:{text:"å†å²æ•°æ®è¶‹åŠ¿å›¾",left:"center",top:10,textStyle:{fontSize:16,fontWeight:600,color:"#333"}},backgroundColor:"#fff",tooltip:{trigger:"axis",backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderWidth:1,padding:10,textStyle:{color:"#333",fontSize:12},formatter:function(n){let u=`<div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">${n[0].axisValue}</div>`;return n.forEach(y=>{if(y.value!==null){const a=s.find(I=>I.attrName===y.seriesName),C=(a==null?void 0:a.unit)||"";u+=`<div style="margin: 4px 0;">${y.marker} ${y.seriesName}: <span style="font-weight: bold;">${y.value}</span> ${C}</div>`}}),u}},legend:{data:x.map(n=>n.name),top:30,type:"scroll",textStyle:{fontSize:11}},grid:{left:55,right:35,bottom:50,top:65,containLabel:!1},xAxis:{type:"category",boundaryGap:!1,data:i,axisLine:{lineStyle:{color:"#999"}},axisLabel:{color:"#666",fontSize:11,rotate:45,interval:Math.floor(i.length/15)||0},splitLine:{show:!1}},yAxis:{type:"value",axisLine:{show:!0,lineStyle:{color:"#999"}},axisLabel:{color:"#666",fontSize:11},splitLine:{lineStyle:{color:"#e5e5e5",type:"dashed"}}},dataZoom:[{type:"inside",start:0,end:100,zoomOnMouseWheel:!0,moveOnMouseMove:!0},{type:"slider",start:0,end:100,height:20,bottom:8,borderColor:"#ccc",fillerColor:"rgba(64, 158, 255, 0.2)",handleStyle:{color:"#409eff"}}],series:x};console.log("è®¾ç½®å›¾è¡¨é…ç½®"),_.setOption(N,!0),console.log("å›¾è¡¨æ¸²æŸ“å®Œæˆ"),console.log("=== æ¸²æŸ“å›¾è¡¨ç»“æŸ ===")};ee(S,async o=>{o==="chart"&&(f.value.length===0?(console.log("å›¾è¡¨è§†å›¾æ— æ•°æ®ï¼Œå¼€å§‹æŸ¥è¯¢..."),await O()):(console.log("å›¾è¡¨è§†å›¾æœ‰æ•°æ®ï¼Œæ¸²æŸ“å›¾è¡¨..."),setTimeout(()=>{ne(()=>{E()})},100)))}),ee([()=>w.value,()=>S.value],()=>{w.value==="history"&&S.value==="chart"&&_&&setTimeout(()=>{_&&_.resize()},100)}),te(()=>{window.addEventListener("resize",()=>{_&&_.resize()})});const me=async o=>{if(console.log("ç‚¹å‡»å‘½ä»¤æŒ‰é’®:",o),console.log("è®¾å¤‡çŠ¶æ€:",l.status),l.status!==1){p.warning("è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•ä¸‹å‘å‘½ä»¤");return}try{await _e.confirm(`æ˜¯å¦ç¡®è®¤æ‰§è¡Œ ${o.commandName||o.addr} æŒ‡ä»¤ï¼Ÿ`,"å‘½ä»¤ç¡®è®¤",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"}),await Te({deviceCode:l.deviceCode,commands:[{addr:o.addr,addrv:o.commandValue}]})&&(p.success("å‘½ä»¤å·²ä¸‹å‘"),setTimeout(()=>{L()},1e3))}catch(e){e!=="cancel"&&(console.error("å‘é€å‘½ä»¤å¤±è´¥:",e),p.error("å‘é€å‘½ä»¤å¤±è´¥"))}},F=async o=>{w.value=o,o==="realtime"?L():o==="history"?(await J(),k.value.length===0&&K(),f.value.length===0&&await O()):o==="command"&&await ue()},K=()=>{const o=new Date,e=new Date(o.getFullYear(),o.getMonth(),o.getDate(),0,0,0);k.value=[j(e),j(o)]},j=o=>{const e=new Date(o),i=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),m=String(e.getDate()).padStart(2,"0"),x=String(e.getHours()).padStart(2,"0"),N=String(e.getMinutes()).padStart(2,"0"),n=String(e.getSeconds()).padStart(2,"0");return`${i}-${s}-${m} ${x}:${N}:${n}`},P=()=>{re.push("/devices")},U=async(o,e)=>{try{await navigator.clipboard.writeText(o),p({message:`${e}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`,type:"success",duration:2e3})}catch(i){console.error("å¤åˆ¶å¤±è´¥:",i),p.error("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶")}};return te(()=>{ce(),K()}),(o,e)=>{const i=T("el-icon"),s=T("el-button"),m=T("el-radio-button"),x=T("el-radio-group"),N=T("el-date-picker"),n=T("el-table-column"),u=T("el-table"),y=T("el-pagination");return d(),v("div",$e,[t("div",ze,[t("div",{class:"breadcrumb"},[t("span",{onClick:P,class:"breadcrumb-link"},"è®¾å¤‡ç®¡ç†"),e[10]||(e[10]=t("span",{class:"breadcrumb-sep"},"/",-1)),e[11]||(e[11]=t("span",{class:"breadcrumb-current"},"è®¾å¤‡è¯¦æƒ…",-1))]),r(s,{type:"primary",onClick:P,size:"default",class:"back-btn"},{default:g(()=>[r(i,{style:{"margin-right":"6px"}},{default:g(()=>[r(R(he))]),_:1}),e[12]||(e[12]=A(" è¿”å›è®¾å¤‡åˆ—è¡¨ ",-1))]),_:1})]),w.value!=="history"?(d(),v("div",Me,[t("div",qe,[t("div",Ne,[t("div",{class:$(["device-icon-large",l.status===1?"icon-online":"icon-offline"])},"ğŸ“±",2),t("div",Ve,[t("div",Ie,[t("div",Ae,[t("h1",Pe,c(l.deviceName||"-"),1),t("div",He,c(l.deviceCode||"-"),1)]),t("div",{class:$(["status-badge",l.status===1?"status-online":"status-offline"])},[e[13]||(e[13]=t("span",{class:"status-dot"},null,-1)),t("span",null,c(l.status===1?"åœ¨çº¿":"ç¦»çº¿"),1)],2)])])]),t("div",Be,[t("div",Re,[e[14]||(e[14]=t("div",{class:"info-label"},"äº§å“ç±»å‹",-1)),t("div",Ye,c(l.productName||"-"),1)]),t("div",Le,[e[15]||(e[15]=t("div",{class:"info-label"},"æ‰€å±åˆ†ç»„",-1)),t("div",Oe,c(l.groupName||"-"),1)]),t("div",Ee,[e[16]||(e[16]=t("div",{class:"info-label"},"æœ€åä¸Šçº¿",-1)),t("div",Fe,c(j(l.lastOnlineTime)||"-"),1)])])]),t("div",je,[e[23]||(e[23]=t("div",{class:"info-section-title"},[t("span",{class:"section-icon"},"ğŸ“¡"),A(" MQTTè¿æ¥ä¿¡æ¯ ")],-1)),t("div",Ue,[t("div",Qe,[e[17]||(e[17]=t("span",{class:"mqtt-label"},"åœ°å€:",-1)),t("span",We,c(q.broker||"-"),1),e[18]||(e[18]=t("span",{class:"mqtt-sep"},"|",-1)),e[19]||(e[19]=t("span",{class:"mqtt-label"},"ç«¯å£:",-1)),t("span",Ge,c(q.port||"-"),1)]),t("div",Ze,[e[20]||(e[20]=t("span",{class:"mqtt-label"},"Client ID:",-1)),t("code",Je,c(l.deviceCode||"-"),1),r(s,{text:"",class:"copy-btn",onClick:e[0]||(e[0]=a=>U(l.deviceCode,"Client ID")),size:"small"},{default:g(()=>[r(i,null,{default:g(()=>[r(R(Z))]),_:1})]),_:1})]),t("div",Ke,[e[21]||(e[21]=t("span",{class:"mqtt-label"},"å‘å¸ƒä¸»é¢˜:",-1)),t("code",Xe,"ssc/"+c(l.deviceCode||"-")+"/report",1),r(s,{text:"",class:"copy-btn",onClick:e[1]||(e[1]=a=>U(`ssc/${l.deviceCode}/report`,"å‘å¸ƒä¸»é¢˜")),size:"small"},{default:g(()=>[r(i,null,{default:g(()=>[r(R(Z))]),_:1})]),_:1})]),t("div",et,[e[22]||(e[22]=t("span",{class:"mqtt-label"},"è®¢é˜…ä¸»é¢˜:",-1)),t("code",tt,"ssc/"+c(l.deviceCode||"-")+"/command",1),r(s,{text:"",class:"copy-btn",onClick:e[2]||(e[2]=a=>U(`ssc/${l.deviceCode}/command`,"è®¢é˜…ä¸»é¢˜")),size:"small"},{default:g(()=>[r(i,null,{default:g(()=>[r(R(Z))]),_:1})]),_:1})])])])])):V("",!0),t("div",ot,[t("button",{class:$(["tab",{active:w.value==="realtime"}]),onClick:e[3]||(e[3]=a=>F("realtime"))}," å®æ—¶æ•°æ® ",2),t("button",{class:$(["tab",{active:w.value==="history"}]),onClick:e[4]||(e[4]=a=>F("history"))}," å†å²æ•°æ® ",2),t("button",{class:$(["tab",{active:w.value==="command"}]),onClick:e[5]||(e[5]=a=>F("command"))}," å‘½ä»¤æ§åˆ¶ ",2)]),t("div",{class:$(["tab-content",{active:w.value==="realtime"}])},[B.value.length>0?(d(),v("div",at,[t("div",st,[(d(!0),v(W,null,G(B.value,a=>(d(),v("div",{key:a.key,class:"data-card"},[t("div",nt,c(a.label),1),t("div",null,[t("span",lt,c(a.value),1),a.unit?(d(),v("span",it,c(a.unit),1)):V("",!0)]),t("div",rt,"ğŸ“… "+c(Y.value),1)]))),128))])])):(d(),v("div",dt,[...e[24]||(e[24]=[t("div",{class:"empty-icon"},"ğŸ“­",-1),t("div",null,"æš‚æ— å®æ—¶æ•°æ®",-1)])]))],2),t("div",{class:$(["tab-content",{active:w.value==="history"}])},[t("div",ct,[r(x,{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=a=>S.value=a),size:"small"},{default:g(()=>[r(m,{label:"chart"},{default:g(()=>[...e[25]||(e[25]=[A("ğŸ“ˆ è¶‹åŠ¿å›¾",-1)])]),_:1}),r(m,{label:"table"},{default:g(()=>[...e[26]||(e[26]=[A("ğŸ“Š è¡¨æ ¼",-1)])]),_:1})]),_:1},8,["modelValue"]),t("div",ut,[r(N,{modelValue:k.value,"onUpdate:modelValue":e[7]||(e[7]=a=>k.value=a),type:"datetimerange","range-separator":"è‡³","start-placeholder":"å¼€å§‹æ—¶é—´","end-placeholder":"ç»“æŸæ—¶é—´",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"400px"}},null,8,["modelValue"]),r(s,{type:"primary",onClick:O},{default:g(()=>[...e[27]||(e[27]=[A("æŸ¥è¯¢",-1)])]),_:1})])]),oe(t("div",vt,[t("div",{ref_key:"historyChartRef",ref:M,class:"history-chart"},null,512),f.value.length===0?(d(),v("div",pt,[...e[28]||(e[28]=[t("div",{class:"empty-icon"},"ğŸ“Š",-1),t("div",null,"æš‚æ— å†å²æ•°æ®",-1)])])):V("",!0)],512),[[ae,S.value==="chart"]]),oe(t("div",mt,[t("div",gt,[r(u,{data:ve.value,stripe:"",style:{width:"100%"},height:pe.value},{default:g(()=>[r(n,{prop:"reportTime",label:"ä¸ŠæŠ¥æ—¶é—´",width:"220",fixed:""}),(d(!0),v(W,null,G(h.value,a=>(d(),se(n,{key:a.addr,label:a.attrName,"min-width":"100"},{default:g(({row:C})=>[C[a.addr]!==void 0&&C[a.addr]!==null?(d(),v("span",ft,[A(c(C[a.addr])+" ",1),a.unit?(d(),v("span",yt,c(a.unit),1)):V("",!0)])):(d(),v("span",ht,"-"))]),_:2},1032,["label"]))),128))]),_:1},8,["data","height"]),f.value.length>0?(d(),se(y,{key:0,"current-page":b.currentPage,"onUpdate:currentPage":e[8]||(e[8]=a=>b.currentPage=a),"page-size":b.pageSize,"onUpdate:pageSize":e[9]||(e[9]=a=>b.pageSize=a),"page-sizes":[20,50,100,200],total:b.total,layout:"total, sizes, prev, pager, next, jumper",class:"history-pagination"},null,8,["current-page","page-size","total"])):V("",!0),f.value.length===0?(d(),v("div",_t,[...e[29]||(e[29]=[t("div",{class:"empty-icon"},"ğŸ“­",-1),t("div",null,"æš‚æ— å†å²æ•°æ®",-1)])])):V("",!0)])],512),[[ae,S.value==="table"]])],2),t("div",{class:$(["tab-content",{active:w.value==="command"}])},[t("div",bt,[(d(!0),v(W,null,G(z.value,a=>(d(),v("button",{key:a.id,class:"command-btn",onClick:C=>me(a)},[e[30]||(e[30]=t("div",{class:"command-icon"},"âš¡",-1)),t("div",Ct,c(a.commandName),1)],8,wt))),128)),z.value.length===0?(d(),v("div",Dt,[...e[31]||(e[31]=[t("div",{class:"empty-icon"},"ğŸ®",-1),t("div",null,"æš‚æ— å¯ç”¨å‘½ä»¤",-1)])])):V("",!0)])],2)])}}},qt=ge(St,[["__scopeId","data-v-004dc508"]]);export{qt as default};
