import{_ as be,a as ge,u as ye,r as v,z as Ve,c as n,o as w,d as $,g as t,w as l,e as d,t as g,E as u,q as s,i as f,T as N,D as we,W as j,J as Ne,k as O,s as ke,F as Ce,f as Te,X as G}from"./index-84c82c57.js";import{p as k}from"./index-eeb428ef.js";const xe={class:"product-detail"},ze={class:"page-header"},Me={class:"page-title"},$e={class:"page-actions"},De={class:"card-header"},Pe={class:"info-grid"},Ae={class:"info-row"},Fe={class:"info-item"},Ue={class:"info-value"},Se={class:"info-item"},Re={class:"info-value"},Be={class:"info-item"},qe={class:"info-value"},Ie={class:"info-row"},he={class:"info-item"},Ee={class:"info-value"},He={class:"info-item"},Oe={class:"info-value"},Qe={class:"info-item"},Je={class:"info-value"},Le={key:0,class:"info-desc-row"},We={class:"info-desc"},Xe={class:"tab-header"},Ye={key:0,class:"empty-state"},je={class:"tab-header"},Ge={key:0,class:"empty-state"},Ke={class:"input-hint"},Ze={class:"input-hint"},et={key:0},tt={key:1},lt={class:"input-hint"},at={class:"input-hint"},ot={class:"input-hint"},dt={class:"input-hint"},st={class:"input-hint"},rt={class:"input-hint"},nt={class:"alert-title"},ut={__name:"ProductDetail",setup(it){const D=ge(),K=ye(),_=v({}),C=v([]),P=v([]),Q=v("attributes"),A=v(!1),x=v(!1),F=v(!1),z=v(!1),R=v(null),B=v(null),q=v(null),c=v({productName:"",productModel:"",protocol:"",description:""}),r=v({addr:"",attrName:"",dataType:"",unit:""}),b=v({commandName:"",addr:"",commandValue:""}),Z=a=>{if(!a)return"-";if(typeof a=="string"&&a.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/))return a;if(typeof a=="string"&&a.includes("T"))return a.replace("T"," ").substring(0,19);const e=new Date(a),m=e.getFullYear(),U=String(e.getMonth()+1).padStart(2,"0"),p=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),S=String(e.getMinutes()).padStart(2,"0"),y=String(e.getSeconds()).padStart(2,"0");return`${m}-${U}-${p} ${i}:${S}:${y}`},ee={productName:[{required:!0,message:"请输入产品名称",trigger:"blur"}],protocol:[{required:!0,message:"请选择协议类型",trigger:"change"}]},te={addr:[{required:!0,message:"请输入属性标识符",trigger:"blur"}],attrName:[{required:!0,message:"请输入属性名称",trigger:"blur"}],dataType:[{required:!0,message:"请选择数据类型",trigger:"change"}]},le={commandName:[{required:!0,message:"请输入命令名称",trigger:"blur"}],addr:[{required:!0,message:"请选择控制属性",trigger:"change"}],commandValue:[{required:!0,message:"请输入下发值",trigger:"blur"}]},J=async()=>{try{const a=D.params.id,e=await k.getProductDetail(a);_.value=e,e.attrs&&(C.value=e.attrs),e.commands&&(P.value=e.commands)}catch(a){console.error("加载产品详情失败:",a),u.error("加载产品详情失败")}},I=async()=>{try{const a=D.params.id,e=await k.getProductAttributes(a);C.value=e||[]}catch(a){console.error("加载属性列表失败:",a)}},L=async()=>{try{const a=D.params.id,e=await k.getProductCommands(a);P.value=e||[]}catch(a){console.error("加载命令列表失败:",a)}},ae=()=>{c.value={productName:_.value.productName,productModel:_.value.productModel,protocol:_.value.protocol,description:_.value.description||""},A.value=!0},oe=async()=>{if(R.value)try{await R.value.validate(),await k.updateProduct({id:D.params.id,productName:c.value.productName,productModel:c.value.productModel,protocol:c.value.protocol,description:c.value.description}),u.success("产品信息已更新"),A.value=!1,J()}catch(a){a!==!1&&(console.error("更新产品失败:",a),u.error("更新产品失败"))}},de=()=>{z.value=!1,r.value={addr:"",attrName:"",dataType:"",unit:""},x.value=!0},se=a=>{z.value=!0,r.value={id:a.id,addr:a.addr,attrName:a.attrName||"",dataType:a.dataType||"",unit:a.unit||"",description:a.description||""},x.value=!0},re=async()=>{if(B.value)try{if(await B.value.validate(),C.value.some(a=>a.addr===r.value.addr)){u.error("属性标识符已存在");return}await k.addProductAttribute({productId:D.params.id,addr:r.value.addr,attrName:r.value.attrName,dataType:r.value.dataType,unit:r.value.unit}),u.success("属性添加成功"),x.value=!1,I()}catch(a){a!==!1&&(console.error("添加属性失败:",a),u.error("添加属性失败"))}},ne=async()=>{var a,e;try{if(!r.value.id){u.error("属性ID不能为空"),console.error("属性ID为空，attrForm:",r.value);return}if(!r.value.attrName||r.value.attrName.trim()===""){u.error("请输入属性名称");return}const m={id:r.value.id,attrName:r.value.attrName.trim(),unit:(r.value.unit||"").trim(),description:(r.value.description||"").trim()};console.log("发送更新属性请求，参数:",m),await k.updateProductAttribute(m),u.success("属性更新成功"),x.value=!1,I()}catch(m){console.error("更新属性失败:",m);const U=(m==null?void 0:m.message)||((e=(a=m==null?void 0:m.response)==null?void 0:a.data)==null?void 0:e.message)||"更新属性失败";u.error(U)}},ue=async a=>{try{await G.confirm(`确定要删除属性"${a.attrName}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await k.deleteProductAttribute(a.id),u.success("属性已删除"),I()}catch(e){e!=="cancel"&&(console.error("删除属性失败:",e),u.error("删除属性失败"))}},ie=()=>{if(C.value.length===0){u.warning("请先添加属性后再创建命令");return}b.value={commandName:"",addr:"",commandValue:""},F.value=!0},me=async()=>{if(q.value)try{await q.value.validate(),await k.addProductCommand({productId:D.params.id,addr:b.value.addr,commandName:b.value.commandName,commandValue:b.value.commandValue,description:`控制属性 ${b.value.addr} 为 ${b.value.commandValue}`}),u.success("命令添加成功"),F.value=!1,L()}catch(a){a!==!1&&(console.error("添加命令失败:",a),u.error("添加命令失败"))}},pe=async a=>{try{await G.confirm(`确定要删除命令"${a.commandName}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await k.deleteProductCommand(a.id),u.success("命令已删除"),L()}catch(e){e!=="cancel"&&(console.error("删除命令失败:",e),u.error("删除命令失败"))}},ce=()=>{K.push("/products")};return Ve(()=>{J()}),(a,e)=>{const m=n("el-breadcrumb-item"),U=n("el-breadcrumb"),p=n("el-button"),i=n("el-icon"),S=n("el-card"),y=n("el-table-column"),ve=n("el-tag"),W=n("el-table"),X=n("el-tab-pane"),fe=n("el-tabs"),T=n("el-input"),V=n("el-form-item"),M=n("el-option"),h=n("el-select"),E=n("el-form"),H=n("el-dialog"),_e=n("el-alert");return w(),$("div",xe,[t(U,{separator:"›",class:"breadcrumb"},{default:l(()=>[t(m,{to:{path:"/products"}},{default:l(()=>[...e[19]||(e[19]=[s("产品管理",-1)])]),_:1}),t(m,null,{default:l(()=>[s(g(_.value.productName||"产品详情"),1)]),_:1})]),_:1}),d("div",ze,[d("h1",Me,g(_.value.productName),1),d("div",$e,[t(p,{onClick:ce},{default:l(()=>[...e[20]||(e[20]=[s("← 返回列表",-1)])]),_:1}),t(p,{type:"primary",onClick:ae},{default:l(()=>[...e[21]||(e[21]=[s("编辑产品",-1)])]),_:1})])]),t(S,{class:"info-card"},{header:l(()=>[d("div",De,[t(i,{class:"header-icon"},{default:l(()=>[t(f(N))]),_:1}),e[22]||(e[22]=d("span",null,"基本信息",-1))])]),default:l(()=>[d("div",Pe,[d("div",Ae,[d("div",Fe,[e[23]||(e[23]=d("div",{class:"info-label"},"产品名称",-1)),d("div",Ue,g(_.value.productName||"-"),1)]),d("div",Se,[e[24]||(e[24]=d("div",{class:"info-label"},"产品型号",-1)),d("div",Re,g(_.value.productModel||"-"),1)]),d("div",Be,[e[25]||(e[25]=d("div",{class:"info-label"},"协议类型",-1)),d("div",qe,g(_.value.protocol||"-"),1)])]),d("div",Ie,[d("div",he,[e[26]||(e[26]=d("div",{class:"info-label"},"创建时间",-1)),d("div",Ee,g(Z(_.value.createTime)),1)]),d("div",He,[e[27]||(e[27]=d("div",{class:"info-label"},"属性数量",-1)),d("div",Oe,g(C.value.length)+" 个",1)]),d("div",Qe,[e[28]||(e[28]=d("div",{class:"info-label"},"命令数量",-1)),d("div",Je,g(P.value.length)+" 个",1)])]),_.value.description?(w(),$("div",Le,[e[29]||(e[29]=d("div",{class:"info-label"},"产品描述",-1)),d("div",We,g(_.value.description),1)])):we("",!0)])]),_:1}),t(S,{class:"tab-card"},{default:l(()=>[t(fe,{modelValue:Q.value,"onUpdate:modelValue":e[0]||(e[0]=o=>Q.value=o)},{default:l(()=>[t(X,{label:"属性列表",name:"attributes"},{default:l(()=>[d("div",Xe,[e[31]||(e[31]=d("div",{class:"tab-title"},"设备属性定义",-1)),t(p,{type:"primary",size:"small",onClick:de},{default:l(()=>[t(i,null,{default:l(()=>[t(f(j))]),_:1}),e[30]||(e[30]=s("添加属性 ",-1))]),_:1})]),C.value.length===0?(w(),$("div",Ye,[t(i,{class:"empty-icon",size:48},{default:l(()=>[t(f(Ne))]),_:1}),e[32]||(e[32]=d("div",{class:"empty-text"},'暂无属性，点击"添加属性"开始定义数据点',-1))])):(w(),O(W,{key:1,data:C.value,stripe:"",size:"small",class:"attr-table"},{default:l(()=>[t(y,{prop:"addr",label:"标识符",width:"200"}),t(y,{prop:"attrName",label:"属性名称","min-width":"120"}),t(y,{prop:"dataType",label:"数据类型",width:"100"},{default:l(({row:o})=>[t(ve,{size:"small"},{default:l(()=>[s(g(o.dataType),1)]),_:2},1024)]),_:1}),t(y,{prop:"unit",label:"单位",width:"100"},{default:l(({row:o})=>[s(g(o.unit||"-"),1)]),_:1}),t(y,{label:"操作",width:"150",fixed:"right"},{default:l(({row:o})=>[t(p,{size:"small",type:"primary",link:"",onClick:Y=>se(o)},{default:l(()=>[...e[33]||(e[33]=[s("编辑",-1)])]),_:1},8,["onClick"]),t(p,{size:"small",type:"danger",link:"",onClick:Y=>ue(o)},{default:l(()=>[...e[34]||(e[34]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1}),t(X,{label:"命令列表",name:"commands"},{default:l(()=>[d("div",je,[e[36]||(e[36]=d("div",{class:"tab-title"},"设备命令定义",-1)),t(p,{type:"primary",size:"small",onClick:ie},{default:l(()=>[t(i,null,{default:l(()=>[t(f(j))]),_:1}),e[35]||(e[35]=s("添加命令 ",-1))]),_:1})]),P.value.length===0?(w(),$("div",Ge,[t(i,{class:"empty-icon",size:48},{default:l(()=>[t(f(ke))]),_:1}),e[37]||(e[37]=d("div",{class:"empty-text"},'暂无命令，点击"添加命令"开始定义控制指令',-1))])):(w(),O(W,{key:1,data:P.value,stripe:"",size:"small",class:"cmd-table"},{default:l(()=>[t(y,{prop:"commandName",label:"命令名称","min-width":"150"}),t(y,{prop:"addr",label:"控制属性",width:"120"}),t(y,{prop:"commandValue",label:"下发值",width:"120"}),t(y,{label:"操作",width:"100",fixed:"right"},{default:l(({row:o})=>[t(p,{size:"small",type:"danger",link:"",onClick:Y=>pe(o)},{default:l(()=>[...e[38]||(e[38]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(H,{modelValue:A.value,"onUpdate:modelValue":e[6]||(e[6]=o=>A.value=o),title:"编辑产品",width:"600px"},{footer:l(()=>[t(p,{onClick:e[5]||(e[5]=o=>A.value=!1)},{default:l(()=>[...e[40]||(e[40]=[s("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:oe},{default:l(()=>[...e[41]||(e[41]=[s("保存修改",-1)])]),_:1})]),default:l(()=>[t(E,{model:c.value,"label-width":"120px",rules:ee,ref_key:"editFormRef",ref:R},{default:l(()=>[t(V,{label:"产品名称",prop:"productName"},{default:l(()=>[t(T,{modelValue:c.value.productName,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value.productName=o),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),t(V,{label:"产品型号",prop:"productModel"},{default:l(()=>[t(T,{modelValue:c.value.productModel,"onUpdate:modelValue":e[2]||(e[2]=o=>c.value.productModel=o),disabled:""},null,8,["modelValue"]),d("div",Ke,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[39]||(e[39]=s(" 产品型号创建后不可修改 ",-1))])]),_:1}),t(V,{label:"协议类型",prop:"protocol"},{default:l(()=>[t(h,{modelValue:c.value.protocol,"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.protocol=o),placeholder:"请选择协议类型",style:{width:"100%"}},{default:l(()=>[t(M,{label:"MQTT",value:"MQTT"}),t(M,{label:"HTTP",value:"HTTP"}),t(M,{label:"CoAP",value:"CoAP"}),t(M,{label:"Modbus",value:"Modbus"})]),_:1},8,["modelValue"])]),_:1}),t(V,{label:"产品描述"},{default:l(()=>[t(T,{modelValue:c.value.description,"onUpdate:modelValue":e[4]||(e[4]=o=>c.value.description=o),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(H,{modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=o=>x.value=o),title:z.value?"编辑产品属性":"添加产品属性",width:"600px"},{footer:l(()=>[t(p,{onClick:e[11]||(e[11]=o=>x.value=!1)},{default:l(()=>[...e[45]||(e[45]=[s("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:e[12]||(e[12]=o=>z.value?ne():re())},{default:l(()=>[s(g(z.value?"保存修改":"确定添加"),1)]),_:1})]),default:l(()=>[t(E,{model:r.value,"label-width":"120px",rules:te,ref_key:"attrFormRef",ref:B},{default:l(()=>[t(V,{label:"属性标识符",prop:"addr"},{default:l(()=>[t(T,{modelValue:r.value.addr,"onUpdate:modelValue":e[7]||(e[7]=o=>r.value.addr=o),placeholder:"如：tem、hum、battery",disabled:z.value},null,8,["modelValue","disabled"]),d("div",Ze,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),z.value?(w(),$("span",et,"属性标识符创建后不可修改")):(w(),$("span",tt,"英文标识符，用于数据上报的字段名，建议使用小写字母+下划线"))])]),_:1}),t(V,{label:"属性名称",prop:"attrName"},{default:l(()=>[t(T,{modelValue:r.value.attrName,"onUpdate:modelValue":e[8]||(e[8]=o=>r.value.attrName=o),placeholder:"如：温度、湿度、电池电量"},null,8,["modelValue"]),d("div",lt,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[42]||(e[42]=s(" 中文显示名称，方便理解属性含义 ",-1))])]),_:1}),t(V,{label:"数据类型",prop:"dataType"},{default:l(()=>[t(h,{modelValue:r.value.dataType,"onUpdate:modelValue":e[9]||(e[9]=o=>r.value.dataType=o),placeholder:"请选择数据类型",style:{width:"100%"}},{default:l(()=>[t(M,{label:"整数 (int) - 如状态、计数",value:"int"}),t(M,{label:"浮点数 (float) - 如温度、湿度",value:"float"})]),_:1},8,["modelValue"]),d("div",at,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[43]||(e[43]=s(" 选择合适的数据类型，影响数据存储和处理方式 ",-1))])]),_:1}),t(V,{label:"单位"},{default:l(()=>[t(T,{modelValue:r.value.unit,"onUpdate:modelValue":e[10]||(e[10]=o=>r.value.unit=o),placeholder:"如：℃、%、m/s（可选）"},null,8,["modelValue"]),d("div",ot,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[44]||(e[44]=s(" 数值属性可填写单位，非数值属性可留空 ",-1))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(H,{modelValue:F.value,"onUpdate:modelValue":e[18]||(e[18]=o=>F.value=o),title:"添加产品命令",width:"600px"},{footer:l(()=>[t(p,{onClick:e[17]||(e[17]=o=>F.value=!1)},{default:l(()=>[...e[55]||(e[55]=[s("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:me},{default:l(()=>[...e[56]||(e[56]=[s("确定添加",-1)])]),_:1})]),default:l(()=>[t(E,{model:b.value,"label-width":"120px",rules:le,ref_key:"cmdFormRef",ref:q},{default:l(()=>[t(V,{label:"命令名称",prop:"commandName"},{default:l(()=>[t(T,{modelValue:b.value.commandName,"onUpdate:modelValue":e[14]||(e[14]=o=>b.value.commandName=o),placeholder:"如：打开窗户、关闭灯光、设置模式"},null,8,["modelValue"]),d("div",dt,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[46]||(e[46]=s(" 命令的显示名称，让用户知道这是什么操作 ",-1))])]),_:1}),t(V,{label:"控制属性",prop:"addr"},{default:l(()=>[t(h,{modelValue:b.value.addr,"onUpdate:modelValue":e[15]||(e[15]=o=>b.value.addr=o),placeholder:"请选择要控制的属性",style:{width:"100%"}},{default:l(()=>[(w(!0),$(Ce,null,Te(C.value,o=>(w(),O(M,{key:o.addr,label:`${o.attrName} (${o.addr})`,value:o.addr},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d("div",st,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[47]||(e[47]=s(" 选择要控制的属性，命令会修改该属性的值 ",-1))])]),_:1}),t(V,{label:"下发值",prop:"commandValue"},{default:l(()=>[t(T,{modelValue:b.value.commandValue,"onUpdate:modelValue":e[16]||(e[16]=o=>b.value.commandValue=o),placeholder:"如：1、0、ON、OFF"},null,8,["modelValue"]),d("div",rt,[t(i,{class:"hint-icon",size:14},{default:l(()=>[t(f(N))]),_:1}),e[48]||(e[48]=s(" 命令执行时会将该值下发给设备，设备根据该值进行操作 ",-1))])]),_:1}),t(_e,{type:"info",closable:!1},{title:l(()=>[d("div",nt,[t(i,{class:"alert-icon",size:16},{default:l(()=>[t(f(N))]),_:1}),e[49]||(e[49]=s(" 示例 ",-1))])]),default:l(()=>[e[50]||(e[50]=s(' 如果有一个属性叫 "window"，可以创建两个命令：',-1)),e[51]||(e[51]=d("br",null,null,-1)),e[52]||(e[52]=s(" • 命令名：打开窗户 | 控制属性：window | 下发值：1",-1)),e[53]||(e[53]=d("br",null,null,-1)),e[54]||(e[54]=s(" • 命令名：关闭窗户 | 控制属性：window | 下发值：0 ",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ct=be(ut,[["__scopeId","data-v-ea907d4f"]]);export{ct as default};
