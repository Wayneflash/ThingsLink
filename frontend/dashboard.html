<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»ªè¡¨ç›˜ - ThingsLink</title>
  <link rel="stylesheet" href="/src/styles/common.css">
  <style>
    body {
      background: #f5f5f7;
      margin: 0;
      min-height: 100vh;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* ä¾§è¾¹æ  - æ·±è‰²ä¼˜é›…é£æ ¼ */
    .sidebar {
      width: 260px;
      background: #1d1d1f;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar-header {
      padding: 28px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 19px;
      font-weight: 700;
      color: white;
      letter-spacing: -0.02em;
    }

    .sidebar-logo-icon {
      font-size: 32px;
      filter: drop-shadow(0 2px 8px rgba(0, 122, 255, 0.4));
    }

    .sidebar-menu {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }

    .menu-item {
      padding: 12px 20px;
      margin: 4px 12px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      position: relative;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(2px);
    }

    .menu-item.active {
      background: #007aff;
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4);
    }

    .menu-item.active::before {
      display: none;
    }

    .menu-icon {
      font-size: 22px;
      transition: transform 0.3s;
    }

    .menu-item:hover .menu-icon {
      transform: scale(1.1);
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-info-sidebar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      color: white;
    }

    .user-avatar-sidebar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #007aff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* ä¸»å†…å®¹åŒº - æµ…è‰² */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #f5f5f7;
    }

    .topbar {
      height: 64px;
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      padding: 0 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: #1d1d1f;
      letter-spacing: -0.02em;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #f5f5f7;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .user-info:hover {
      background: #e5e5e7;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #007aff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .btn-logout {
      padding: 8px 20px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-logout:hover {
      background: #0051d5;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .btn-logout:active {
      transform: translateY(0);
    }

    .content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      background: #f5f5f7;
    }

    /* ç»Ÿè®¡å¡ç‰‡ - Appleé£æ ¼ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 16px;
      padding: 28px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      border-color: rgba(0, 0, 0, 0.12);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 140px;
      height: 140px;
      opacity: 0.03;
      font-size: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: rotate(-15deg);
      transition: all 0.4s;
    }

    .stat-card:hover::before {
      transform: rotate(0deg) scale(1.1);
      opacity: 0.05;
    }

    .stat-card.devices::before { content: 'ğŸ“±'; }
    .stat-card.online::before { content: 'âœ…'; }
    .stat-card.products::before { content: 'ğŸ“¦'; }
    .stat-card.alerts::before { content: 'âš ï¸'; }

    .stat-label {
      font-size: 14px;
      color: #86868b;
      margin-bottom: 14px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #1d1d1f;
      margin-bottom: 12px;
      letter-spacing: -0.03em;
    }

    .stat-card.devices .stat-value { color: #007aff; }
    .stat-card.online .stat-value { color: #34c759; }
    .stat-card.offline .stat-value { color: #ff9500; }
    .stat-card.alerts .stat-value { color: #ff3b30; }

    .stat-trend {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      color: #86868b;
    }

    .stat-trend.up {
      color: #34c759;
    }

    .stat-trend.down {
      color: #ff3b30;
    }

    /* è®¾å¤‡åˆ—è¡¨ */
    .device-list-section {
      margin-top: 40px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #1d1d1f;
      letter-spacing: -0.02em;
    }

    .device-table {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .empty-state {
      padding: 80px;
      text-align: center;
      color: #86868b;
    }

    .empty-icon {
      font-size: 72px;
      margin-bottom: 20px;
      opacity: 0.4;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span class="sidebar-logo-icon">ğŸ”—</span>
          <span>ThingsLink</span>
        </div>
      </div>

      <nav class="sidebar-menu">
        <a href="/dashboard.html" class="menu-item active">
          <span class="menu-icon">ğŸ“Š</span>
          <span>ä»ªè¡¨ç›˜</span>
        </a>
        <a href="/devices.html" class="menu-item">
          <span class="menu-icon">ğŸ“±</span>
          <span>è®¾å¤‡ç®¡ç†</span>
        </a>
        <a href="/products.html" class="menu-item">
          <span class="menu-icon">ğŸ“¦</span>
          <span>äº§å“ç®¡ç†</span>
        </a>
        <a href="/groups.html" class="menu-item">
          <span class="menu-icon">ğŸ“</span>
          <span>åˆ†ç»„ç®¡ç†</span>
        </a>
        <a href="/data-query.html" class="menu-item">
          <span class="menu-icon">ğŸ“ˆ</span>
          <span>æ•°æ®æŸ¥è¯¢</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info-sidebar">
          <div class="user-avatar-sidebar">ğŸ‘¤</div>
          <div>
            <div style="font-size: 13px; font-weight: 600;" id="userName">ç®¡ç†å‘˜</div>
            <div style="font-size: 11px; opacity: 0.7;">åœ¨çº¿</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
      <div class="topbar">
        <h1 class="page-title">ä»ªè¡¨ç›˜</h1>
        <div class="topbar-right">
          <div class="user-info">
            <div class="user-avatar">ğŸ‘¤</div>
            <div class="user-name" id="userNameTop">ç®¡ç†å‘˜</div>
          </div>
          <button class="btn-logout" onclick="logout()">
            <span>ğŸšª</span>
            <span>é€€å‡º</span>
          </button>
        </div>
      </div>

      <div class="content">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
          <div class="stat-card devices">
            <div class="stat-label">è®¾å¤‡æ€»æ•°</div>
            <div class="stat-value" id="totalDevices">-</div>
            <div class="stat-trend">
              <span>ğŸ“Š å®æ—¶ç»Ÿè®¡</span>
            </div>
          </div>

          <div class="stat-card online">
            <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
            <div class="stat-value" id="onlineDevices">-</div>
            <div class="stat-trend up">
              <span>â†—</span>
              <span id="onlineRate">-</span>
            </div>
          </div>

          <div class="stat-card products">
            <div class="stat-label">äº§å“ç±»å‹</div>
            <div class="stat-value" id="totalProducts">-</div>
            <div class="stat-trend">
              <span>ğŸ“¦ äº§å“ç§ç±»</span>
            </div>
          </div>

          <div class="stat-card alerts">
            <div class="stat-label">ç¦»çº¿è®¾å¤‡</div>
            <div class="stat-value" id="offlineDevices">-</div>
            <div class="stat-trend down" id="offlineRate">
              <span>â†˜</span>
              <span>-</span>
            </div>
          </div>
        </div>

        <!-- æœ€è¿‘è®¾å¤‡ -->
        <div class="device-list-section">
          <div class="section-header">
            <h2 class="section-title">æœ€è¿‘è®¾å¤‡</h2>
            <a href="/devices.html" class="btn btn-sm btn-primary">æŸ¥çœ‹å…¨éƒ¨</a>
          </div>

          <div class="device-table">
            <table class="table">
              <thead>
                <tr>
                  <th>è®¾å¤‡åç§°</th>
                  <th>è®¾å¤‡ç¼–ç </th>
                  <th>äº§å“</th>
                  <th>åˆ†ç»„</th>
                  <th>çŠ¶æ€</th>
                  <th>æœ€ååœ¨çº¿</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="deviceList">
                <tr>
                  <td colspan="7" class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <div>åŠ è½½ä¸­...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { deviceApi, productApi, authApi } from '/src/utils/api.js';

    // æ£€æŸ¥ç™»å½•
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login.html';
    }

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    if (userInfo.username) {
      const userName = userInfo.username;
      document.getElementById('userName').textContent = userName;
      if (document.getElementById('userNameTop')) {
        document.getElementById('userNameTop').textContent = userName;
      }
    }

    // é€€å‡ºç™»å½•
    window.logout = () => {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      const confirmLogout = confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ');
      if (confirmLogout) {
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        
        // è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login.html';
      }
    };

    // æ›´æ–°æ—¶é—´
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      document.getElementById('currentTime').textContent = timeStr;
    }
    updateTime();
    setInterval(updateTime, 1000);

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStatistics() {
      try {
        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        const deviceResult = await deviceApi.list({ page: 1, pageSize: 100 });
        if (deviceResult.code === 200) {
          const devices = deviceResult.data.list || [];
          const total = deviceResult.data.total || 0;
          const online = devices.filter(d => d.status === 1).length;
          const offline = total - online;
          const onlineRate = total > 0 ? ((online / total) * 100).toFixed(1) : 0;

          document.getElementById('totalDevices').textContent = total;
          document.getElementById('onlineDevices').textContent = online;
          document.getElementById('offlineDevices').textContent = offline;
          document.getElementById('onlineRate').textContent = `${onlineRate}%`;
        }

        // åŠ è½½äº§å“æ•°é‡
        const productResult = await productApi.list({ page: 1, pageSize: 100 });
        if (productResult.code === 200) {
          document.getElementById('totalProducts').textContent = productResult.data.total || 0;
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½æœ€è¿‘è®¾å¤‡
    async function loadRecentDevices() {
      try {
        const result = await deviceApi.list({ page: 1, pageSize: 10 });
        if (result.code === 200) {
          const devices = result.data.list || [];
          renderDeviceList(devices);
        }
      } catch (error) {
        console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('deviceList').innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div class="empty-icon">âŒ</div>
              <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
            </td>
          </tr>
        `;
      }
    }

    // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
    function renderDeviceList(devices) {
      const tbody = document.getElementById('deviceList');
      
      if (devices.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div class="empty-icon">ğŸ“­</div>
              <div>æš‚æ— è®¾å¤‡</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = devices.map(device => `
        <tr>
          <td>${device.deviceName || '-'}</td>
          <td><code>${device.deviceCode || '-'}</code></td>
          <td>${device.productName || '-'}</td>
          <td>${device.groupPath || device.groupName || '-'}</td>
          <td>
            ${device.status === 1 
              ? '<span class="badge badge-online">åœ¨çº¿</span>' 
              : '<span class="badge badge-offline">ç¦»çº¿</span>'}
          </td>
          <td>${device.lastOnlineTime || '-'}</td>
          <td>
            <a href="/device-detail.html?code=${device.deviceCode}" class="btn btn-sm">æŸ¥çœ‹</a>
          </td>
        </tr>
      `).join('');
    }

    // åˆå§‹åŒ–
    loadStatistics();
    loadRecentDevices();

    // å®šæ—¶åˆ·æ–°
    setInterval(() => {
      loadStatistics();
      loadRecentDevices();
    }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
  </script>
</body>
</html>
