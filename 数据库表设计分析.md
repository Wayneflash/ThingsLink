# IoT平台数据库表设计分析报告

> 生成时间：2025-01-XX  
> 数据库：iot_platform

---

## 📊 数据库表统计

### 当前表数量：**10张表**

| 序号 | 表名 | 中文名 | 用途 | 状态 |
|------|------|--------|------|------|
| 1 | `tb_user` | 用户表 | 系统用户管理 | ✅ |
| 2 | `tb_role` | 角色表 | 角色权限管理 | ✅ |
| 3 | `tb_menu` | 菜单表 | 菜单权限管理 | ⚠️ 未使用 |
| 4 | `tb_device_group` | 设备分组表 | 设备分组树形结构 | ✅ |
| 5 | `tb_product` | 产品表 | 产品定义 | ✅ |
| 6 | `tb_attribute` | 产品属性表 | 产品物模型（属性） | ✅ |
| 7 | `tb_command` | 产品命令表 | 产品物模型（命令） | ✅ |
| 8 | `tb_device` | 设备表 | 设备实例管理 | ✅ |
| 9 | `tb_device_data` | 设备数据表 | 时序数据存储 | ✅ |
| 10 | `tb_command_log` | 命令下发记录表 | 命令下发日志 | ⚠️ 未使用 |

---

## ✅ 表设计合理性分析

### 1. 核心业务表（设计合理）✅

#### 1.1 用户权限体系
- **`tb_user`** ✅
  - 设计合理，包含基本用户信息
  - 关联角色和分组，支持数据权限
  - **建议**：可考虑添加 `avatar`（头像）字段

- **`tb_role`** ✅
  - 设计合理，支持菜单权限和数据权限
  - `menu_ids` 使用文本存储，简单但不够灵活
  - **建议**：`data_scope` 字段定义了但未完全使用

- **`tb_menu`** ⚠️ **未使用**
  - 表已创建，但代码中未使用
  - 菜单权限通过硬编码实现（`UserService.getUserMenus()`）
  - **建议**：要么使用此表，要么删除

#### 1.2 设备分组
- **`tb_device_group`** ✅
  - 设计合理，支持树形结构
  - 索引设计合理（`idx_parent_id`）
  - **建议**：可考虑添加 `level`（层级）字段，提升查询性能

#### 1.3 产品物模型
- **`tb_product`** ✅
  - 设计合理，产品基本信息完整
  - **建议**：可考虑添加 `icon`（图标）字段

- **`tb_attribute`** ✅
  - 设计合理，支持产品属性定义
  - 外键约束合理（CASCADE删除）
  - **建议**：可考虑添加 `min_value`、`max_value`（取值范围）字段

- **`tb_command`** ✅
  - 设计合理，支持产品命令定义
  - **建议**：可考虑添加 `command_type`（命令类型：同步/异步）字段

#### 1.4 设备管理
- **`tb_device`** ✅
  - 设计合理，设备信息完整
  - 已添加告警配置字段（`alarm_config`、`alarm_enabled`）
  - 索引设计合理
  - **建议**：
    - `tags` 字段使用JSON，可考虑添加 `tag` 表（多对多关系）
    - 可考虑添加 `firmware_version`（固件版本）字段

#### 1.5 数据存储
- **`tb_device_data`** ✅
  - **设计优秀**：使用分区表（按月分区）
  - 索引设计合理，支持高效查询
  - **建议**：
    - 可考虑添加 `data_quality`（数据质量）字段
    - 可考虑添加 `source`（数据来源）字段

- **`tb_command_log`** ⚠️ **未使用**
  - 表已创建，但代码中未使用
  - 命令下发记录未持久化
  - **建议**：实现命令下发日志功能，或删除此表

---

## 🔴 缺失的表（需要添加）

### 1. 告警相关表 ⚠️⚠️⚠️

#### 1.1 `tb_alarm_log` - 告警日志表（必需）
**问题**：
- 告警阈值配置已实现，但告警触发后的日志未存储
- 前端有 `AlarmLog.vue` 页面，但无数据来源

**建议表结构**：
```sql
CREATE TABLE `tb_alarm_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '告警ID',
  `device_id` bigint NOT NULL COMMENT '设备ID',
  `device_code` varchar(100) NOT NULL COMMENT '设备编码',
  `alarm_level` varchar(20) NOT NULL COMMENT '告警级别：critical/warning/info',
  `alarm_type` varchar(50) NOT NULL COMMENT '告警类型：阈值告警/离线告警',
  `metric` varchar(50) DEFAULT NULL COMMENT '监控指标（如：temperature）',
  `current_value` varchar(100) DEFAULT NULL COMMENT '当前值',
  `threshold` varchar(100) DEFAULT NULL COMMENT '阈值',
  `alarm_message` varchar(500) NOT NULL COMMENT '告警消息',
  `status` tinyint NOT NULL DEFAULT 0 COMMENT '状态：0-未处理，1-已处理，2-已忽略',
  `handler_id` bigint DEFAULT NULL COMMENT '处理人ID',
  `handle_time` datetime DEFAULT NULL COMMENT '处理时间',
  `handle_remark` varchar(500) DEFAULT NULL COMMENT '处理备注',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '告警时间',
  PRIMARY KEY (`id`),
  KEY `idx_device_id` (`device_id`),
  KEY `idx_device_code` (`device_code`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_status` (`status`),
  KEY `idx_alarm_level` (`alarm_level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警日志表';
```

#### 1.2 `tb_alarm_rule` - 告警规则表（可选）
**说明**：
- 当前告警配置直接存储在设备表的 `alarm_config` 字段（JSON格式）
- 如果未来需要告警规则模板或共享规则，可考虑此表

**建议**：暂时不需要，当前设计已满足需求

---

### 2. 操作日志表 ⚠️⚠️

#### 2.1 `tb_operation_log` - 操作日志表（建议添加）
**问题**：
- 用户操作（增删改）未记录
- 无法追溯数据变更历史
- 无法审计用户行为

**建议表结构**：
```sql
CREATE TABLE `tb_operation_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint NOT NULL COMMENT '操作用户ID',
  `username` varchar(50) NOT NULL COMMENT '操作用户名',
  `module` varchar(50) NOT NULL COMMENT '操作模块：device/product/user等',
  `operation` varchar(50) NOT NULL COMMENT '操作类型：create/update/delete',
  `target_type` varchar(50) NOT NULL COMMENT '目标类型：device/product等',
  `target_id` bigint DEFAULT NULL COMMENT '目标ID',
  `target_name` varchar(200) DEFAULT NULL COMMENT '目标名称',
  `request_method` varchar(10) DEFAULT NULL COMMENT '请求方法：POST/GET等',
  `request_url` varchar(500) DEFAULT NULL COMMENT '请求URL',
  `request_params` text DEFAULT NULL COMMENT '请求参数（JSON）',
  `ip_address` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '操作状态：0-失败，1-成功',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `duration` int DEFAULT NULL COMMENT '耗时（毫秒）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_module` (`module`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_target` (`target_type`, `target_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

---

### 3. 设备标签表（可选）⚠️

#### 3.1 `tb_device_tag` - 设备标签表
**问题**：
- 当前设备表的 `tags` 字段使用JSON存储
- 无法对标签进行统一管理和查询

**建议**：
- 如果标签功能简单，保持JSON格式即可
- 如果需要标签管理、统计等功能，可拆分为独立表

**建议表结构**（可选）：
```sql
CREATE TABLE `tb_device_tag` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '标签ID',
  `tag_name` varchar(50) NOT NULL COMMENT '标签名称',
  `tag_color` varchar(20) DEFAULT NULL COMMENT '标签颜色',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tag_name` (`tag_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备标签表';

CREATE TABLE `tb_device_tag_relation` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `device_id` bigint NOT NULL COMMENT '设备ID',
  `tag_id` bigint NOT NULL COMMENT '标签ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_device_tag` (`device_id`, `tag_id`),
  KEY `idx_device_id` (`device_id`),
  KEY `idx_tag_id` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备标签关联表';
```

---

### 4. 数据统计表（可选）⚠️

#### 4.1 `tb_statistics_daily` - 每日统计表
**问题**：
- 当前统计数据实时计算，性能可能有问题
- 历史统计数据无法追溯

**建议**：
- 如果数据量不大，保持实时计算即可
- 如果数据量大，可考虑每日定时统计并存储

---

## 📋 表设计优化建议

### 高优先级（必需）

#### 1. 添加告警日志表 ⚠️⚠️⚠️
- **原因**：告警功能已实现配置，但日志未存储
- **影响**：无法查看历史告警，告警日志页面无数据
- **优先级**：🔴 高

#### 2. 删除或使用未使用的表 ⚠️
- **`tb_menu`**：要么使用，要么删除
- **`tb_command_log`**：要么实现功能，要么删除
- **优先级**：🟡 中

#### 3. 添加操作日志表 ⚠️⚠️
- **原因**：无法追溯用户操作，无法审计
- **优先级**：🟡 中

### 中优先级（建议）

#### 4. 优化现有表字段
- **`tb_user`**：添加 `avatar`（头像）
- **`tb_product`**：添加 `icon`（图标）
- **`tb_attribute`**：添加 `min_value`、`max_value`（取值范围）
- **`tb_device`**：添加 `firmware_version`（固件版本）
- **`tb_device_group`**：添加 `level`（层级，提升查询性能）

#### 5. 设备标签表（可选）
- 如果标签功能简单，保持JSON即可
- 如果需要标签管理，拆分为独立表

### 低优先级（可选）

#### 6. 数据统计表
- 如果性能没问题，保持实时计算
- 如果数据量大，考虑每日统计表

---

## 📊 表设计评分

| 表名 | 设计合理性 | 完整性 | 性能优化 | 综合评分 |
|------|-----------|--------|----------|----------|
| `tb_user` | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **4.0/5.0** |
| `tb_role` | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | **3.7/5.0** |
| `tb_menu` | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | **2.7/5.0** ⚠️ |
| `tb_device_group` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **4.3/5.0** |
| `tb_product` | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **4.0/5.0** |
| `tb_attribute` | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **4.0/5.0** |
| `tb_command` | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | **3.7/5.0** |
| `tb_device` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | **4.7/5.0** |
| `tb_device_data` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | **4.7/5.0** ✅ |
| `tb_command_log` | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | **2.7/5.0** ⚠️ |

**平均分：3.9/5.0**

---

## 🎯 总结

### 优点 ✅
1. **核心业务表设计合理**：用户、角色、产品、设备、数据表设计良好
2. **性能优化到位**：设备数据表使用分区表，索引设计合理
3. **外键约束合理**：产品属性、命令表使用CASCADE删除
4. **字段设计完整**：基本字段齐全，支持业务需求

### 主要问题 ⚠️
1. **告警日志表缺失**：告警功能不完整，无法查看历史告警
2. **未使用的表**：`tb_menu`、`tb_command_log` 已创建但未使用
3. **操作日志缺失**：无法追溯用户操作，无法审计
4. **部分字段可优化**：可添加一些常用字段提升用户体验

### 建议优先级
1. 🔴 **立即添加**：告警日志表（`tb_alarm_log`）
2. 🟡 **尽快处理**：删除或使用未使用的表
3. 🟡 **建议添加**：操作日志表（`tb_operation_log`）
4. 🟢 **后续优化**：优化现有表字段，添加标签表等

---

## 📝 下一步行动建议

### 第一阶段：完善告警功能（1-2天）
1. ✅ 创建 `tb_alarm_log` 表
2. ✅ 实现告警触发引擎，写入告警日志
3. ✅ 实现告警日志查询接口
4. ✅ 完善前端告警日志页面

### 第二阶段：清理未使用的表（1天）
5. ✅ 决定 `tb_menu` 的使用方式（使用或删除）
6. ✅ 决定 `tb_command_log` 的使用方式（实现或删除）

### 第三阶段：添加操作日志（2-3天）
7. ✅ 创建 `tb_operation_log` 表
8. ✅ 实现操作日志记录功能（AOP拦截器）
9. ✅ 实现操作日志查询接口

### 第四阶段：优化表结构（按需）
10. ⚠️ 优化现有表字段
11. ⚠️ 考虑添加设备标签表

---

*报告生成时间：2025-01-XX*

