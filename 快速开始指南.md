# IoT ç‰©è”ç½‘å¹³å° - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ“¦ é¡¹ç›®ç‰¹æ€§

âœ… **è½»é‡çº§è®¾è®¡** - æ€»å†…å­˜å ç”¨ < 1GB  
âœ… **é«˜æ€§èƒ½** - æ”¯æŒ 1W+ è®¾å¤‡å¹¶å‘  
âœ… **å®Œæ•´åŠŸèƒ½** - äº§å“ç®¡ç†ã€è®¾å¤‡ç®¡ç†ã€æ•°æ®å­˜å‚¨ã€å®æ—¶ç›‘æ§  
âœ… **æ ‡å‡†åè®®** - å…¼å®¹ ThingsFusion MQTT æ•°æ®æ ¼å¼  
âœ… **ä¸€é”®éƒ¨ç½²** - Docker Compose å®¹å™¨åŒ–éƒ¨ç½²  

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vue 3   â”‚ â”€â”€â”€> â”‚  Spring  â”‚ â”€â”€â”€> â”‚  MySQL   â”‚
â”‚  å‰ç«¯     â”‚      â”‚  Boot    â”‚      â”‚  æ•°æ®åº“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   EMQX   â”‚
                  â”‚  MQTT    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†‘
                   è®¾å¤‡ä¸ŠæŠ¥æ•°æ®
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒè¦æ±‚

- Linux ç³»ç»Ÿ (æ¨è Ubuntu 20.04+)
- Docker 20.10+
- Docker Compose 1.29+
- è‡³å°‘ 2GB å¯ç”¨å†…å­˜

### 2. å¿«é€Ÿéƒ¨ç½²

```bash
# 1. ä¸Šä¼ é¡¹ç›®åˆ° Linux æœåŠ¡å™¨
cd /opt
git clone <your-repo> iot-platform
cd iot-platform

# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸€é”®éƒ¨ç½²ï¼‰
docker-compose up -d

# 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
```

### 3. è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| **å‰ç«¯é¡µé¢** | http://your-ip | Vue å‰ç«¯ç•Œé¢ |
| **åç«¯API** | http://your-ip:8080 | Spring Boot API |
| **EMQXæ§åˆ¶å°** | http://your-ip:18083 | MQTTç®¡ç†åå° (admin/public) |
| **MQTTç«¯å£** | tcp://your-ip:1883 | è®¾å¤‡è¿æ¥åœ°å€ |

---

## ğŸ“‹ ä½¿ç”¨æµç¨‹

### æ­¥éª¤ 1: åˆ›å»ºäº§å“

```bash
curl -X POST http://localhost:8080/product/create \
  -H "Content-Type: application/json" \
  -d '{
    "productName": "æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨",
    "productModel": "TEM",
    "protocol": "MQTT",
    "description": "ç¯å¢ƒç›‘æµ‹ä¼ æ„Ÿå™¨"
  }'
```

### æ­¥éª¤ 2: æ·»åŠ äº§å“å±æ€§

```bash
curl -X POST http://localhost:8080/attribute/create \
  -H "Content-Type: application/json" \
  -d '{
    "productId": 1,
    "addr": "tem",
    "attrName": "æ¸©åº¦",
    "dataType": "float",
    "unit": "â„ƒ"
  }'
```

### æ­¥éª¤ 3: åˆ›å»ºè®¾å¤‡

```bash
curl -X POST http://localhost:8080/device/create \
  -H "Content-Type: application/json" \
  -d '{
    "deviceCode": "TEM1111",
    "deviceName": "1å·æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨",
    "productId": 1,
    "location": "åŠå…¬å®¤AåŒº"
  }'
```

### æ­¥éª¤ 4: è®¾å¤‡ä¸ŠæŠ¥æ•°æ®

è®¾å¤‡é€šè¿‡ MQTT å‘å¸ƒåˆ° `ssc/TEM1111/report`:

```json
{
  "did": "TEM1111",
  "content": [
    {
      "addr": "tem",
      "addrv": "25.5",
      "ctime": "2025/12/25 10:30:00",
      "pid": "TEM1111"
    }
  ]
}
```

### æ­¥éª¤ 5: å¹³å°ä¸‹å‘å‘½ä»¤

```bash
curl -X POST http://localhost:8080/command/send \
  -H "Content-Type: application/json" \
  -d '{
    "deviceCode": "TEM1111",
    "commandId": 1
  }'
```

---

## ğŸ”§ åç»­å¼€å‘ä»»åŠ¡

ç”±äºæ—¶é—´å’Œç¯‡å¹…é™åˆ¶ï¼Œä»¥ä¸‹æ˜¯å‰©ä½™éœ€è¦å®Œæˆçš„æ ¸å¿ƒä»£ç æ–‡ä»¶ï¼š

### åç«¯ Service å±‚ (éœ€åˆ›å»º)
- `ProductService.java` - äº§å“ç®¡ç†ä¸šåŠ¡é€»è¾‘
- `DeviceService.java` - è®¾å¤‡ç®¡ç†ä¸šåŠ¡é€»è¾‘  
- `DeviceDataService.java` - æ•°æ®å­˜å‚¨ä¸šåŠ¡é€»è¾‘
- `MqttService.java` - MQTT æ¶ˆæ¯å¤„ç†æœåŠ¡

### åç«¯ Controller å±‚ (éœ€åˆ›å»º)
- `ProductController.java` - äº§å“ç®¡ç†æ¥å£
- `DeviceController.java` - è®¾å¤‡ç®¡ç†æ¥å£
- `DeviceDataController.java` - æ•°æ®æŸ¥è¯¢æ¥å£
- `CommandController.java` - å‘½ä»¤ä¸‹å‘æ¥å£

### MQTT é…ç½®å’Œå¤„ç† (éœ€åˆ›å»º)
- `MqttConfig.java` - MQTT å®¢æˆ·ç«¯é…ç½®
- `MqttMessageHandler.java` - æ¶ˆæ¯è®¢é˜…å’Œå¤„ç†

### Vue 3 å‰ç«¯ (éœ€åˆ›å»º)
- äº§å“ç®¡ç†é¡µé¢
- è®¾å¤‡ç®¡ç†é¡µé¢
- å®æ—¶æ•°æ®ç›‘æ§å¤§å±
- å‘½ä»¤ä¸‹å‘ç•Œé¢

---

## ğŸ’¾ æ•°æ®åº“ä¼˜åŒ–å»ºè®®

### 1. é’ˆå¯¹ 1W å¹¶å‘çš„ä¼˜åŒ–

```sql
-- åˆ†åŒºç­–ç•¥ï¼ˆå·²åœ¨ init.sql å®ç°ï¼‰
-- æŒ‰æœˆåˆ†åŒºï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_device_ctime ON tb_device_data(device_id, ctime DESC);
CREATE INDEX idx_receive_time ON tb_device_data(receive_time DESC);

-- å®šæœŸæ¸…ç†å†å²æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªæœˆï¼‰
DELETE FROM tb_device_data WHERE ctime < DATE_SUB(NOW(), INTERVAL 3 MONTH);
```

### 2. Redis ç¼“å­˜ç­–ç•¥

- è®¾å¤‡åœ¨çº¿çŠ¶æ€ï¼šRedis Hash (device:status)
- æœ€æ–°æ•°æ®ï¼šRedis String (device:{code}:latest)
- ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼š5åˆ†é’Ÿ

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|--------|---------|
| è®¾å¤‡å¹¶å‘æ•° | 10,000 | EMQX é›†ç¾¤ |
| æ•°æ®ååé‡ | 167 QPS | å¼‚æ­¥å†™å…¥ + æ‰¹é‡æ’å…¥ |
| API å“åº”æ—¶é—´ | < 100ms | Redis ç¼“å­˜ |
| å†…å­˜å ç”¨ | < 1GB | JVM å †å†…å­˜é™åˆ¶ 512MB |

---

## ğŸ› æ•…éšœæ’æŸ¥

### æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs backend

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8080

# é‡å¯æœåŠ¡
docker-compose restart backend
```

### MQTT è¿æ¥å¤±è´¥

```bash
# è¿›å…¥ EMQX å®¹å™¨
docker exec -it iot-emqx sh

# æŸ¥çœ‹ MQTT å®¢æˆ·ç«¯è¿æ¥
emqx_ctl clients list
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MySQL çŠ¶æ€
docker-compose exec mysql mysql -uroot -proot123456 -e "SHOW DATABASES;"
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€å®Œæ•´çš„ä»£ç å®ç°ï¼Œè¯·å‘Šè¯‰æˆ‘éœ€è¦ä¼˜å…ˆå®Œæˆå“ªä¸ªéƒ¨åˆ†ï¼š

1. âœ… **åç«¯æ ¸å¿ƒä¸šåŠ¡ä»£ç ** (Service + Controller + MQTT)
2. âœ… **Vue 3 å‰ç«¯ç•Œé¢**  
3. âœ… **è®¾å¤‡æ¨¡æ‹Ÿå™¨** (ç”¨äºæµ‹è¯•)
4. âœ… **éƒ¨ç½²è„šæœ¬ä¼˜åŒ–**

æˆ‘å°†ç»§ç»­ä¸ºä½ è¡¥å……å®Œæ•´ä»£ç ï¼
